;; Ported from AVL Fortran source by Mark Drela and Harold Youngren.
;; Derived work under GPL-2.0.
;; Original source: https://web.mit.edu/drela/Public/web/avl/
(module
  (import "env" "sin_f32" (func $sin_f32 (param f32) (result f32)))
  (import "env" "cos_f32" (func $cos_f32 (param f32) (result f32)))
  (import "env" "sqrt_f32" (func $sqrt_f32 (param f32) (result f32)))
  (import "env" "cross" (func $cross (param i32) (param i32) (param i32)))
  (import "env" "dot" (func $dot (param i32) (param i32) (result f32)))
  (import "env" "cdcl" (func $cdcl (param i32) (param f32) (param i32)))
  (import "env" "tpforc_js" (func $tpforc_js (param i32)))
  (import "env" "sfforc_js" (func $sfforc_js (param i32)))
  (import "env" "bdforc_js" (func $bdforc_js (param i32)))

  (memory (export "memory") 1)

  (global $USE_SFFORC_JS (mut i32) (i32.const 1))
  (func (export "set_sfforc_js") (param $flag i32)
    (global.set $USE_SFFORC_JS (local.get $flag))
  )

  ;; Index helpers (row-major for 3xN arrays)
  (func $idx3 (param $r i32) (param $c i32) (result i32)
    (i32.add (local.get $r) (i32.mul (i32.const 3) (local.get $c)))
  )

  (func $idx2 (param $i i32) (param $j i32) (param $dim1 i32) (result i32)
    (i32.add (local.get $i) (i32.mul (local.get $dim1) (local.get $j)))
  )

  ;; Row-major helper for atpforc-style indexing.
  (func $idx2r (param $i i32) (param $j i32) (param $ncol i32) (result i32)
    (i32.add (i32.mul (local.get $i) (local.get $ncol)) (local.get $j))
  )

  (global $IDX_PI i32 (i32.const 0))
  (global $IDX_ALFA i32 (i32.const 1))
  (global $IDX_BETA i32 (i32.const 2))
  (global $IDX_MACH i32 (i32.const 3))
  (global $IDX_AMACH i32 (i32.const 4))
  (global $IDX_YSYM i32 (i32.const 5))
  (global $IDX_ZSYM i32 (i32.const 6))
  (global $IDX_VRCOREC i32 (i32.const 7))
  (global $IDX_VRCOREW i32 (i32.const 8))
  (global $IDX_IYSYM i32 (i32.const 23))
  (global $IDX_IZSYM i32 (i32.const 24))
  (global $IDX_NBODY i32 (i32.const 28))
  (global $IDX_NCONTROL i32 (i32.const 29))
  (global $IDX_NDESIGN i32 (i32.const 30))
  (global $IDX_NUMAX i32 (i32.const 31))
  (global $IDX_NL i32 (i32.const 32))
  (global $IDX_NLNODE i32 (i32.const 33))
  (global $IDX_OUTPUT_PTR i32 (i32.const 34))
  (global $IDX_CDREF i32 (i32.const 12))
  (global $IDX_CDTOT i32 (i32.const 13))
  (global $IDX_CYTOT i32 (i32.const 14))
  (global $IDX_CLTOT i32 (i32.const 15))
  (global $IDX_CDVTOT i32 (i32.const 16))
  (global $IDX_CDTOT_A i32 (i32.const 17))
  (global $IDX_CLTOT_A i32 (i32.const 18))
  (global $IDX_CLFF i32 (i32.const 19))
  (global $IDX_CYFF i32 (i32.const 20))
  (global $IDX_CDFF i32 (i32.const 21))
  (global $IDX_SPANEF i32 (i32.const 22))
  (global $IDX_VINF i32 (i32.const 50))
  (global $IDX_VINF_A i32 (i32.const 51))
  (global $IDX_VINF_B i32 (i32.const 52))
  (global $IDX_CFTOT i32 (i32.const 54))
  (global $IDX_CMTOT i32 (i32.const 55))
  (global $IDX_CHINGE i32 (i32.const 167))
  (global $IDX_CHINGE_U i32 (i32.const 168))
  (global $IDX_CHINGE_D i32 (i32.const 169))
  (global $IDX_CHINGE_G i32 (i32.const 170))
  (global $IDX_CDTOT_U i32 (i32.const 171))
  (global $IDX_CYTOT_U i32 (i32.const 172))
  (global $IDX_CLTOT_U i32 (i32.const 173))
  (global $IDX_CDTOT_D i32 (i32.const 174))
  (global $IDX_CYTOT_D i32 (i32.const 175))
  (global $IDX_CLTOT_D i32 (i32.const 176))
  (global $IDX_CDTOT_G i32 (i32.const 177))
  (global $IDX_CYTOT_G i32 (i32.const 178))
  (global $IDX_CLTOT_G i32 (i32.const 179))
  (global $IDX_CFTOT_U i32 (i32.const 180))
  (global $IDX_CMTOT_U i32 (i32.const 181))
  (global $IDX_CFTOT_D i32 (i32.const 182))
  (global $IDX_CMTOT_D i32 (i32.const 183))
  (global $IDX_CFTOT_G i32 (i32.const 184))
  (global $IDX_CMTOT_G i32 (i32.const 185))
  (global $IDX_CDBDY i32 (i32.const 186))
  (global $IDX_CYBDY i32 (i32.const 187))
  (global $IDX_CLBDY i32 (i32.const 188))
  (global $IDX_CFBDY i32 (i32.const 189))
  (global $IDX_CMBDY i32 (i32.const 190))
  (global $IDX_RADL i32 (i32.const 191))
  (global $IDX_RL i32 (i32.const 192))
  (global $IDX_SRC i32 (i32.const 193))
  (global $IDX_SRC_U i32 (i32.const 194))
  (global $IDX_DCP i32 (i32.const 92))
  (global $IDX_DCP_U i32 (i32.const 93))
  (global $IDX_DCP_D i32 (i32.const 94))
  (global $IDX_DCP_G i32 (i32.const 95))
  (global $IDX_DCPB i32 (i32.const 96))
  (global $IDX_CNC i32 (i32.const 97))
  (global $IDX_CNC_U i32 (i32.const 98))
  (global $IDX_CNC_D i32 (i32.const 99))
  (global $IDX_CNC_G i32 (i32.const 100))
  (global $IDX_PHINGE i32 (i32.const 101))
  (global $IDX_VHINGE i32 (i32.const 102))
  (global $IDX_DCONTROL i32 (i32.const 103))
  (global $IDX_CFSTRP i32 (i32.const 106))
  (global $IDX_CMSTRP i32 (i32.const 107))
  (global $IDX_CDSTRP i32 (i32.const 108))
  (global $IDX_CYSTRP i32 (i32.const 109))
  (global $IDX_CLSTRP i32 (i32.const 110))
  (global $IDX_CDSURF i32 (i32.const 140))
  (global $IDX_CYSURF i32 (i32.const 141))
  (global $IDX_CLSURF i32 (i32.const 142))
  (global $IDX_CFSURF i32 (i32.const 143))
  (global $IDX_CMSURF i32 (i32.const 144))
  (global $IDX_CDVSURF i32 (i32.const 145))
  (global $IDX_WROT i32 (i32.const 53))
  (global $IDX_LNFLD_WV i32 (i32.const 36))
  (global $IDX_LTRFORCE i32 (i32.const 35))
  (global $IDX_LVISC i32 (i32.const 37))
  (global $IDX_NSTRIP i32 (i32.const 25))
  (global $IDX_NVOR i32 (i32.const 26))
  (global $IDX_NSURF i32 (i32.const 27))
  (global $IDX_SREF i32 (i32.const 9))
  (global $IDX_CREF i32 (i32.const 10))
  (global $IDX_BREF i32 (i32.const 11))
  (global $IDX_XYZREF i32 (i32.const 49))
  (global $IDX_IJFRST i32 (i32.const 38))
  (global $IDX_NVSTRP i32 (i32.const 39))
  (global $IDX_CHORD i32 (i32.const 56))
  (global $IDX_WSTRIP i32 (i32.const 57))
  (global $IDX_CHORD1 i32 (i32.const 58))
  (global $IDX_CHORD2 i32 (i32.const 59))
  (global $IDX_RLE1 i32 (i32.const 60))
  (global $IDX_RLE2 i32 (i32.const 61))
  (global $IDX_RLE i32 (i32.const 62))
  (global $IDX_ENSY i32 (i32.const 63))
  (global $IDX_ENSZ i32 (i32.const 64))
  (global $IDX_ESS i32 (i32.const 65))
  (global $IDX_AINC i32 (i32.const 66))
  (global $IDX_XSREF i32 (i32.const 67))
  (global $IDX_YSREF i32 (i32.const 68))
  (global $IDX_ZSREF i32 (i32.const 69))
  (global $IDX_SSURF i32 (i32.const 70))
  (global $IDX_CAVESURF i32 (i32.const 71))
  (global $IDX_RV1 i32 (i32.const 72))
  (global $IDX_RV2 i32 (i32.const 73))
  (global $IDX_RV i32 (i32.const 74))
  (global $IDX_RC i32 (i32.const 75))
  (global $IDX_DXV i32 (i32.const 76))
  (global $IDX_ENV i32 (i32.const 77))
  (global $IDX_ENV_D i32 (i32.const 78))
  (global $IDX_ENV_G i32 (i32.const 79))
  (global $IDX_VV i32 (i32.const 80))
  (global $IDX_VV_U i32 (i32.const 81))
  (global $IDX_VV_D i32 (i32.const 82))
  (global $IDX_VV_G i32 (i32.const 83))
  (global $IDX_WV i32 (i32.const 84))
  (global $IDX_WV_U i32 (i32.const 85))
  (global $IDX_WV_D i32 (i32.const 86))
  (global $IDX_WV_G i32 (i32.const 87))
  (global $IDX_GAM i32 (i32.const 88))
  (global $IDX_GAM_U i32 (i32.const 89))
  (global $IDX_GAM_D i32 (i32.const 90))
  (global $IDX_GAM_G i32 (i32.const 91))
  (global $IDX_CF_LSTRP i32 (i32.const 104))
  (global $IDX_CM_LSTRP i32 (i32.const 105))
  (global $IDX_CDST_A i32 (i32.const 111))
  (global $IDX_CYST_A i32 (i32.const 112))
  (global $IDX_CLST_A i32 (i32.const 113))
  (global $IDX_CDST_U i32 (i32.const 114))
  (global $IDX_CYST_U i32 (i32.const 115))
  (global $IDX_CLST_U i32 (i32.const 116))
  (global $IDX_CFST_U i32 (i32.const 117))
  (global $IDX_CMST_U i32 (i32.const 118))
  (global $IDX_CDST_D i32 (i32.const 119))
  (global $IDX_CYST_D i32 (i32.const 120))
  (global $IDX_CLST_D i32 (i32.const 121))
  (global $IDX_CFST_D i32 (i32.const 122))
  (global $IDX_CMST_D i32 (i32.const 123))
  (global $IDX_CDST_G i32 (i32.const 124))
  (global $IDX_CYST_G i32 (i32.const 125))
  (global $IDX_CLST_G i32 (i32.const 126))
  (global $IDX_CFST_G i32 (i32.const 127))
  (global $IDX_CMST_G i32 (i32.const 128))
  (global $IDX_CDV_LSTRP i32 (i32.const 137))
  (global $IDX_CL_LSTRP i32 (i32.const 129))
  (global $IDX_CD_LSTRP i32 (i32.const 130))
  (global $IDX_CMC4_LSTRP i32 (i32.const 131))
  (global $IDX_CA_LSTRP i32 (i32.const 132))
  (global $IDX_CN_LSTRP i32 (i32.const 133))
  (global $IDX_CLT_LSTRP i32 (i32.const 134))
  (global $IDX_CLA_LSTRP i32 (i32.const 135))
  (global $IDX_CMLE_LSTRP i32 (i32.const 136))
  (global $IDX_IMAGS i32 (i32.const 43))
  (global $IDX_LNCOMP i32 (i32.const 44))
  (global $IDX_LSSURF i32 (i32.const 42))
  (global $IDX_JFRST i32 (i32.const 40))
  (global $IDX_NJ i32 (i32.const 41))
  (global $IDX_LFRST i32 (i32.const 45))
  (global $IDX_LFLOAD i32 (i32.const 47))
  (global $IDX_LVISCSTRP i32 (i32.const 48))
  (global $IDX_CF_LSRF i32 (i32.const 138))
  (global $IDX_CM_LSRF i32 (i32.const 139))
  (global $IDX_CDS_A i32 (i32.const 146))
  (global $IDX_CYS_A i32 (i32.const 147))
  (global $IDX_CLS_A i32 (i32.const 148))
  (global $IDX_CDS_U i32 (i32.const 149))
  (global $IDX_CYS_U i32 (i32.const 150))
  (global $IDX_CLS_U i32 (i32.const 151))
  (global $IDX_CFS_U i32 (i32.const 152))
  (global $IDX_CMS_U i32 (i32.const 153))
  (global $IDX_CDS_D i32 (i32.const 154))
  (global $IDX_CYS_D i32 (i32.const 155))
  (global $IDX_CLS_D i32 (i32.const 156))
  (global $IDX_CFS_D i32 (i32.const 157))
  (global $IDX_CMS_D i32 (i32.const 158))
  (global $IDX_CDS_G i32 (i32.const 159))
  (global $IDX_CYS_G i32 (i32.const 160))
  (global $IDX_CLS_G i32 (i32.const 161))
  (global $IDX_CFS_G i32 (i32.const 162))
  (global $IDX_CMS_G i32 (i32.const 163))
  (global $IDX_CL_LSRF i32 (i32.const 164))
  (global $IDX_CD_LSRF i32 (i32.const 165))
  (global $IDX_CLCD i32 (i32.const 166))

  (func $field_offset (param $state i32) (param $idx i32) (result i32)
    (i32.load
      (i32.add
        (i32.load (local.get $state))
        (i32.mul (local.get $idx) (i32.const 4))
      )
    )
  )

  (func $field_addr (param $state i32) (param $idx i32) (result i32)
    (i32.add (local.get $state) (call $field_offset (local.get $state) (local.get $idx)))
  )

  (func $load_i32 (param $state i32) (param $idx i32) (result i32)
    (i32.load (call $field_addr (local.get $state) (local.get $idx)))
  )

  (func $load_f32 (param $state i32) (param $idx i32) (result f32)
    (f32.load (call $field_addr (local.get $state) (local.get $idx)))
  )

  (func $field_ptr (param $state i32) (param $idx i32) (result i32)
    (i32.load (call $field_addr (local.get $state) (local.get $idx)))
  )

  (func $load_i32_at (param $base i32) (param $idx i32) (result i32)
    (i32.load (i32.add (local.get $base) (i32.mul (local.get $idx) (i32.const 4))))
  )

  (func $load_f32_at (param $base i32) (param $idx i32) (result f32)
    (f32.load (i32.add (local.get $base) (i32.mul (local.get $idx) (i32.const 4))))
  )

  (func $store_f32_at (param $base i32) (param $idx i32) (param $val f32)
    (f32.store (i32.add (local.get $base) (i32.mul (local.get $idx) (i32.const 4))) (local.get $val))
  )

  (func (export "VINFAB") (param $state i32)
    (local $alfa f32) (local $beta f32)
    (local $sina f32) (local $cosa f32) (local $sinb f32) (local $cosb f32)
    (local $layout i32)
    (local $vinf i32) (local $vinf_a i32) (local $vinf_b i32)

    (local.set $layout (i32.load (local.get $state)))

    (local.set $alfa
      (f32.load
        (i32.add (local.get $state)
          (i32.load (i32.add (local.get $layout) (i32.mul (global.get $IDX_ALFA) (i32.const 4)))))
      )
    )
    (local.set $beta
      (f32.load
        (i32.add (local.get $state)
          (i32.load (i32.add (local.get $layout) (i32.mul (global.get $IDX_BETA) (i32.const 4)))))
      )
    )
    (local.set $vinf
      (i32.load
        (i32.add (local.get $state)
          (i32.load (i32.add (local.get $layout) (i32.mul (global.get $IDX_VINF) (i32.const 4)))))
      )
    )
    (local.set $vinf_a
      (i32.load
        (i32.add (local.get $state)
          (i32.load (i32.add (local.get $layout) (i32.mul (global.get $IDX_VINF_A) (i32.const 4)))))
      )
    )
    (local.set $vinf_b
      (i32.load
        (i32.add (local.get $state)
          (i32.load (i32.add (local.get $layout) (i32.mul (global.get $IDX_VINF_B) (i32.const 4)))))
      )
    )

    (local.set $sina (call $sin_f32 (local.get $alfa)))
    (local.set $cosa (call $cos_f32 (local.get $alfa)))
    (local.set $sinb (call $sin_f32 (local.get $beta)))
    (local.set $cosb (call $cos_f32 (local.get $beta)))

    (f32.store (local.get $vinf) (f32.mul (local.get $cosa) (local.get $cosb)))
    (f32.store (i32.add (local.get $vinf) (i32.const 4)) (f32.neg (local.get $sinb)))
    (f32.store (i32.add (local.get $vinf) (i32.const 8)) (f32.mul (local.get $sina) (local.get $cosb)))

    (f32.store (local.get $vinf_a) (f32.neg (f32.mul (local.get $sina) (local.get $cosb))))
    (f32.store (i32.add (local.get $vinf_a) (i32.const 4)) (f32.const 0))
    (f32.store (i32.add (local.get $vinf_a) (i32.const 8)) (f32.mul (local.get $cosa) (local.get $cosb)))

    (f32.store (local.get $vinf_b) (f32.neg (f32.mul (local.get $cosa) (local.get $sinb))))
    (f32.store (i32.add (local.get $vinf_b) (i32.const 4)) (f32.neg (local.get $cosb)))
    (f32.store (i32.add (local.get $vinf_b) (i32.const 8)) (f32.neg (f32.mul (local.get $sina) (local.get $sinb))))
  )

  

  (func $SFFORC_WAT (param $state i32)
    (local $lnfld i32) (local $ltr i32) (local $lvisc i32)
    (local $ncontrol i32) (local $ndesign i32) (local $numax i32)
    (local $nstrip i32) (local $nvor i32) (local $nsurf i32)
    (local $i i32) (local $ii i32) (local $j i32) (local $jj i32) (local $is i32)
    (local $i1 i32) (local $nvc i32) (local $nstrps i32)
    (local $idx i32) (local $idx2v i32)
    (local $ptr i32) (local $ptr2 i32)
    (local $alfa f32) (local $sina f32) (local $cosa f32)
    (local $cr f32) (local $sr f32)
    (local $xte1 f32) (local $xte2 f32)
    (local $cfx f32) (local $cfy f32) (local $cfz f32)
    (local $cmx f32) (local $cmy f32) (local $cmz f32)
    (local $dcfx f32) (local $dcfy f32) (local $dcfz f32)
    (local $tmp f32) (local $tmp2 f32) (local $tmp3 f32)
    (local $vsq f32) (local $vsqi f32) (local $vpsq f32) (local $vpsqi f32)
    (local $vspan f32)
    (local $ulmag f32)
    (local $dmag f32)
    (local $sr_over_sref f32)
    (local $r0 f32) (local $r1 f32) (local $r2 f32)
    (local $rle0 f32) (local $rle1 f32) (local $rle2 f32)
    (local $delx f32) (local $dely f32) (local $delz f32)
    (local $en0 f32) (local $en1 f32) (local $en2 f32)
    (local $spn0 f32) (local $spn1 f32) (local $spn2 f32)
    (local $ud0 f32) (local $ud1 f32) (local $ud2 f32)
    (local $ul0 f32) (local $ul1 f32) (local $ul2 f32)
    (local $rc40 f32) (local $rc41 f32) (local $rc42 f32)
    (local $rv0 f32) (local $rv1 f32) (local $rv2 f32)
    (local $rr0 f32) (local $rr1 f32) (local $rr2 f32)
    (local $vr0 f32) (local $vr1 f32) (local $vr2 f32)
    (local $ve0 f32) (local $ve1 f32) (local $ve2 f32)
    (local $g0 f32) (local $g1 f32) (local $g2 f32)
    (local $f0 f32) (local $f1 f32) (local $f2 f32)
    (local $fg0 f32) (local $fg1 f32) (local $fg2 f32)
    (local $env0 f32) (local $env1 f32) (local $env2 f32)
    (local $fnv f32)
    (local $sref f32) (local $cref f32) (local $bref f32)
    (local $imags i32) (local $j0 i32)
    (local $ess0 f32) (local $ess1 f32) (local $ess2 f32)
    (local $vp0 f32) (local $vp1 f32) (local $vp2 f32)
    (local $cmle f32)
    (local $cav f32) (local $ssurf f32)
    (local $cf_l0 f32) (local $cf_l1 f32) (local $cf_l2 f32)
    (local $cm_l0 f32) (local $cm_l1 f32) (local $cm_l2 f32)
    (local $n i32) (local $l i32)
    (local $veff_u0 f32) (local $veff_u1 f32) (local $veff_u2 f32)
    (local $f_u0 f32) (local $f_u1 f32) (local $f_u2 f32)
    (local $fg_u0 f32) (local $fg_u1 f32) (local $fg_u2 f32)
    (local $dfac f32)
    (local $clv f32) (local $cdv f32) (local $cdv_clv f32)
    (local $veffmag f32) (local $veffmag_u f32)
    (local $vv_u_ptr i32) (local $wv_u_ptr i32)
    (local $gam_u_ptr i32) (local $dcp_u_ptr i32) (local $cnc_u_ptr i32)
    (local $cfst_u_ptr i32) (local $cmst_u_ptr i32)
    (local $cdst_u_ptr i32) (local $cyst_u_ptr i32) (local $clst_u_ptr i32)
    (local $cds_u_ptr i32) (local $cys_u_ptr i32) (local $cls_u_ptr i32)
    (local $cfs_u_ptr i32) (local $cms_u_ptr i32)
    (local $cdtot_u_ptr i32) (local $cytot_u_ptr i32) (local $cltot_u_ptr i32)
    (local $cftot_u_ptr i32) (local $cmtot_u_ptr i32)
    (local $vv_d_ptr i32) (local $wv_d_ptr i32)
    (local $gam_d_ptr i32) (local $dcp_d_ptr i32) (local $cnc_d_ptr i32)
    (local $cfst_d_ptr i32) (local $cmst_d_ptr i32)
    (local $cdst_d_ptr i32) (local $cyst_d_ptr i32) (local $clst_d_ptr i32)
    (local $cds_d_ptr i32) (local $cys_d_ptr i32) (local $cls_d_ptr i32)
    (local $cfs_d_ptr i32) (local $cms_d_ptr i32)
    (local $cdtot_d_ptr i32) (local $cytot_d_ptr i32) (local $cltot_d_ptr i32)
    (local $cftot_d_ptr i32) (local $cmtot_d_ptr i32)
    (local $vv_g_ptr i32) (local $wv_g_ptr i32)
    (local $gam_g_ptr i32) (local $dcp_g_ptr i32) (local $cnc_g_ptr i32)
    (local $cfst_g_ptr i32) (local $cmst_g_ptr i32)
    (local $cdst_g_ptr i32) (local $cyst_g_ptr i32) (local $clst_g_ptr i32)
    (local $cds_g_ptr i32) (local $cys_g_ptr i32) (local $cls_g_ptr i32)
    (local $cfs_g_ptr i32) (local $cms_g_ptr i32)
    (local $cdtot_g_ptr i32) (local $cytot_g_ptr i32) (local $cltot_g_ptr i32)
    (local $cftot_g_ptr i32) (local $cmtot_g_ptr i32)
    (local $env_d_ptr i32) (local $env_g_ptr i32)
    (local $phinge_ptr i32) (local $vhinge_ptr i32) (local $dcontrol_ptr i32)
    (local $chinge_ptr i32) (local $chinge_u_ptr i32) (local $chinge_d_ptr i32) (local $chinge_g_ptr i32)
    (local $clcd_ptr i32)
    (local $veff_d0 f32) (local $veff_d1 f32) (local $veff_d2 f32)
    (local $f_d0 f32) (local $f_d1 f32) (local $f_d2 f32)
    (local $fg_d0 f32) (local $fg_d1 f32) (local $fg_d2 f32)
    (local $veff_g0 f32) (local $veff_g1 f32) (local $veff_g2 f32)
    (local $f_g0 f32) (local $f_g1 f32) (local $f_g2 f32)
    (local $fg_g0 f32) (local $fg_g1 f32) (local $fg_g2 f32)
    (local $envd0 f32) (local $envd1 f32) (local $envd2 f32)
    (local $envg0 f32) (local $envg1 f32) (local $envg2 f32)
    (local $ulift_u0 f32) (local $ulift_u1 f32) (local $ulift_u2 f32)
    (local $udrag_u0 f32) (local $udrag_u1 f32) (local $udrag_u2 f32)

    (local.set $lnfld (call $load_i32 (local.get $state) (global.get $IDX_LNFLD_WV)))
    (local.set $ltr (call $load_i32 (local.get $state) (global.get $IDX_LTRFORCE)))
    (local.set $lvisc (call $load_i32 (local.get $state) (global.get $IDX_LVISC)))
    (local.set $ncontrol (call $load_i32 (local.get $state) (global.get $IDX_NCONTROL)))
    (local.set $ndesign (call $load_i32 (local.get $state) (global.get $IDX_NDESIGN)))
    (local.set $numax (call $load_i32 (local.get $state) (global.get $IDX_NUMAX)))

    (local.set $nstrip (call $load_i32 (local.get $state) (global.get $IDX_NSTRIP)))
    (local.set $nvor (call $load_i32 (local.get $state) (global.get $IDX_NVOR)))
    (local.set $nsurf (call $load_i32 (local.get $state) (global.get $IDX_NSURF)))

    (local.set $vv_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_VV_U)))
    (local.set $wv_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_WV_U)))
    (local.set $gam_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_GAM_U)))
    (local.set $dcp_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_DCP_U)))
    (local.set $cnc_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CNC_U)))
    (local.set $cfst_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFST_U)))
    (local.set $cmst_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMST_U)))
    (local.set $cdst_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDST_U)))
    (local.set $cyst_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYST_U)))
    (local.set $clst_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLST_U)))
    (local.set $cds_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDS_U)))
    (local.set $cys_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYS_U)))
    (local.set $cls_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLS_U)))
    (local.set $cfs_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFS_U)))
    (local.set $cms_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMS_U)))
    (local.set $cdtot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDTOT_U)))
    (local.set $cytot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYTOT_U)))
    (local.set $cltot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLTOT_U)))
    (local.set $cftot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFTOT_U)))
    (local.set $cmtot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMTOT_U)))

    (local.set $alfa (call $load_f32 (local.get $state) (global.get $IDX_ALFA)))
    (local.set $sina (call $sin_f32 (local.get $alfa)))
    (local.set $cosa (call $cos_f32 (local.get $alfa)))

    (local.set $ud0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VINF)) (i32.const 0)))
    (local.set $ud1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VINF)) (i32.const 1)))
    (local.set $ud2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VINF)) (i32.const 2)))
    (local.set $sref (call $load_f32 (local.get $state) (global.get $IDX_SREF)))
    (local.set $cref (call $load_f32 (local.get $state) (global.get $IDX_CREF)))
    (local.set $bref (call $load_f32 (local.get $state) (global.get $IDX_BREF)))

    (local.set $j (i32.const 0))
    (block $done_j
      (loop $loop_j
        (br_if $done_j (i32.ge_s (local.get $j) (local.get $nstrip)))

        (local.set $i1 (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_IJFRST)) (i32.mul (local.get $j) (i32.const 4)))))
        (local.set $nvc (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_NVSTRP)) (i32.mul (local.get $j) (i32.const 4)))))

        (local.set $cr (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CHORD)) (local.get $j)))
        (local.set $sr (f32.mul (local.get $cr) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WSTRIP)) (local.get $j))))

        (local.set $xte1
          (f32.add
            (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE1)) (call $idx3 (i32.const 0) (local.get $j)))
            (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CHORD1)) (local.get $j))
          )
        )
        (local.set $xte2
          (f32.add
            (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE2)) (call $idx3 (i32.const 0) (local.get $j)))
            (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CHORD2)) (local.get $j))
          )
        )

        (local.set $spn0 (f32.const 0))
        (local.set $spn1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)))
        (local.set $spn2 (f32.neg (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j))))

        (local.set $ul0 (f32.sub (f32.mul (local.get $ud1) (local.get $spn2)) (f32.mul (local.get $ud2) (local.get $spn1))))
        (local.set $ul1 (f32.sub (f32.mul (local.get $ud2) (local.get $spn0)) (f32.mul (local.get $ud0) (local.get $spn2))))
        (local.set $ul2 (f32.sub (f32.mul (local.get $ud0) (local.get $spn1)) (f32.mul (local.get $ud1) (local.get $spn0))))
        (local.set $ulmag
          (call $sqrt_f32 (f32.add (f32.add (f32.mul (local.get $ul0) (local.get $ul0))
                                          (f32.mul (local.get $ul1) (local.get $ul1)))
                                   (f32.mul (local.get $ul2) (local.get $ul2))))
        )
        (if (f32.eq (local.get $ulmag) (f32.const 0))
          (then
            (local.set $ul0 (f32.const 0))
            (local.set $ul1 (f32.const 0))
            (local.set $ul2 (f32.const 1))
          )
          (else
            (local.set $ul0 (f32.div (local.get $ul0) (local.get $ulmag)))
            (local.set $ul1 (f32.div (local.get $ul1) (local.get $ulmag)))
            (local.set $ul2 (f32.div (local.get $ul2) (local.get $ulmag)))
          )
        )

        (local.set $rc40
          (f32.add
            (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 0) (local.get $j)))
            (f32.mul (f32.const 0.25) (local.get $cr))
          )
        )
        (local.set $rc41 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 1) (local.get $j))))
        (local.set $rc42 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 2) (local.get $j))))

        (local.set $cfx (f32.const 0))
        (local.set $cfy (f32.const 0))
        (local.set $cfz (f32.const 0))
        (local.set $cmx (f32.const 0))
        (local.set $cmy (f32.const 0))
        (local.set $cmz (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC)) (local.get $j) (f32.const 0))

        (local.set $n (i32.const 0))
        (block $done_n_init
          (loop $loop_n_init
            (br_if $done_n_init (i32.ge_s (local.get $n) (local.get $numax)))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC_U))
              (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_U))
              (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_U))
              (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_U))
              (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_U))
              (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_U))
              (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_U))
              (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_n_init)
          )
        )

        (local.set $n (i32.const 0))
        (block $done_nd_init
          (loop $loop_nd_init
            (br_if $done_nd_init (i32.ge_s (local.get $n) (local.get $ncontrol)))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC_D))
              (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_D))
              (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_D))
              (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_D))
              (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_D))
              (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_D))
              (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_D))
              (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_nd_init)
          )
        )

        (local.set $n (i32.const 0))
        (block $done_ng_init
          (loop $loop_ng_init
            (br_if $done_ng_init (i32.ge_s (local.get $n) (local.get $ndesign)))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC_G))
              (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_G))
              (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_G))
              (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFST_G))
              (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_G))
              (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_G))
              (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMST_G))
              (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (i32.const 3)) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_ng_init)
          )
        )

        (local.set $ii (i32.const 0))
        (block $done_ii
          (loop $loop_ii
            (br_if $done_ii (i32.ge_s (local.get $ii) (local.get $nvc)))
            (local.set $i (i32.add (local.get $i1) (local.get $ii)))

            (local.set $rv0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV)) (call $idx3 (i32.const 0) (local.get $i))))
            (local.set $rv1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV)) (call $idx3 (i32.const 1) (local.get $i))))
            (local.set $rv2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV)) (call $idx3 (i32.const 2) (local.get $i))))

            (local.set $r0 (f32.sub (local.get $rv0) (local.get $rc40)))
            (local.set $r1 (f32.sub (local.get $rv1) (local.get $rc41)))
            (local.set $r2 (f32.sub (local.get $rv2) (local.get $rc42)))

            (local.set $rr0 (f32.sub (local.get $rv0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 0))))
            (local.set $rr1 (f32.sub (local.get $rv1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 1))))
            (local.set $rr2 (f32.sub (local.get $rv2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 2))))

            (local.set $vr0 (f32.sub (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))
                                     (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))))
            (local.set $vr1 (f32.sub (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))
                                     (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))))
            (local.set $vr2 (f32.sub (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))
                                     (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))))

            (local.set $tmp (f32.const 0))
            (local.set $tmp2 (f32.const 0))
            (local.set $tmp3 (f32.const 0))
            (if (i32.ne (local.get $lnfld) (i32.const 0))
              (then
                (local.set $tmp (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WV)) (call $idx3 (i32.const 0) (local.get $i))))
                (local.set $tmp2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WV)) (call $idx3 (i32.const 1) (local.get $i))))
                (local.set $tmp3 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WV)) (call $idx3 (i32.const 2) (local.get $i))))
              )
              (else
                (local.set $tmp (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VV)) (call $idx3 (i32.const 0) (local.get $i))))
                (local.set $tmp2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VV)) (call $idx3 (i32.const 1) (local.get $i))))
                (local.set $tmp3 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VV)) (call $idx3 (i32.const 2) (local.get $i))))
              )
            )
            (local.set $ve0 (f32.add (f32.add (local.get $ud0) (local.get $vr0)) (local.get $tmp)))
            (local.set $ve1 (f32.add (f32.add (local.get $ud1) (local.get $vr1)) (local.get $tmp2)))
            (local.set $ve2 (f32.add (f32.add (local.get $ud2) (local.get $vr2)) (local.get $tmp3)))

            (local.set $g0 (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV2)) (call $idx3 (i32.const 0) (local.get $i)))
                                    (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV1)) (call $idx3 (i32.const 0) (local.get $i)))))
            (local.set $g1 (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV2)) (call $idx3 (i32.const 1) (local.get $i)))
                                    (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV1)) (call $idx3 (i32.const 1) (local.get $i)))))
            (local.set $g2 (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV2)) (call $idx3 (i32.const 2) (local.get $i)))
                                    (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV1)) (call $idx3 (i32.const 2) (local.get $i)))))

            (local.set $f0 (f32.sub (f32.mul (local.get $ve1) (local.get $g2)) (f32.mul (local.get $ve2) (local.get $g1))))
            (local.set $f1 (f32.sub (f32.mul (local.get $ve2) (local.get $g0)) (f32.mul (local.get $ve0) (local.get $g2))))
            (local.set $f2 (f32.sub (f32.mul (local.get $ve0) (local.get $g1)) (f32.mul (local.get $ve1) (local.get $g0))))

            (local.set $tmp (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)))
            (local.set $fg0 (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0))))
            (local.set $fg1 (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1))))
            (local.set $fg2 (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2))))

            (local.set $env0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENV)) (call $idx3 (i32.const 0) (local.get $i))))
            (local.set $env1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENV)) (call $idx3 (i32.const 1) (local.get $i))))
            (local.set $env2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENV)) (call $idx3 (i32.const 2) (local.get $i))))
            (local.set $fnv (f32.add (f32.add (f32.mul (local.get $env0) (local.get $fg0))
                                              (f32.mul (local.get $env1) (local.get $fg1)))
                                       (f32.mul (local.get $env2) (local.get $fg2))))
            (local.set $tmp (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_DXV)) (local.get $i))
                                     (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WSTRIP)) (local.get $j))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_DCP)) (local.get $i) (f32.div (local.get $fnv) (local.get $tmp)))
            (local.set $tmp2 (local.get $tmp))

            (local.set $dcfx (f32.div (local.get $fg0) (local.get $sr)))
            (local.set $dcfy (f32.div (local.get $fg1) (local.get $sr)))
            (local.set $dcfz (f32.div (local.get $fg2) (local.get $sr)))

            (local.set $cfx (f32.add (local.get $cfx) (local.get $dcfx)))
            (local.set $cfy (f32.add (local.get $cfy) (local.get $dcfy)))
            (local.set $cfz (f32.add (local.get $cfz) (local.get $dcfz)))

            (local.set $cmx (f32.add (local.get $cmx)
                                     (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1))
                                                       (f32.mul (local.get $dcfy) (local.get $r2)))
                                              (local.get $cr))))
            (local.set $cmy (f32.add (local.get $cmy)
                                     (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2))
                                                       (f32.mul (local.get $dcfz) (local.get $r0)))
                                              (local.get $cr))))
            (local.set $cmz (f32.add (local.get $cmz)
                                     (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0))
                                                       (f32.mul (local.get $dcfx) (local.get $r1)))
                                              (local.get $cr))))

            (local.set $tmp
              (f32.add
                (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC)) (local.get $j))
                (f32.mul (local.get $cr)
                         (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                  (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))
              )
            )
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC)) (local.get $j) (local.get $tmp))

            ;; NUMAX derivatives
            (local.set $n (i32.const 0))
            (block $done_u
              (loop $loop_u
                (br_if $done_u (i32.ge_s (local.get $n) (local.get $numax)))
                (local.set $idx2v (i32.add (local.get $i) (i32.mul (local.get $nvor) (local.get $n))))
                (if (i32.ne (local.get $lnfld) (i32.const 0))
                  (then
                    (local.set $veff_u0 (call $load_f32_at (local.get $wv_u_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                    (local.set $veff_u1 (call $load_f32_at (local.get $wv_u_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                    (local.set $veff_u2 (call $load_f32_at (local.get $wv_u_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                  )
                  (else
                    (local.set $veff_u0 (call $load_f32_at (local.get $vv_u_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                    (local.set $veff_u1 (call $load_f32_at (local.get $vv_u_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                    (local.set $veff_u2 (call $load_f32_at (local.get $vv_u_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                  )
                )
                (if (i32.lt_s (local.get $n) (i32.const 3))
                  (then
                    (if (i32.eq (local.get $n) (i32.const 0)) (then (local.set $veff_u0 (f32.add (local.get $veff_u0) (f32.const 1)))))
                    (if (i32.eq (local.get $n) (i32.const 1)) (then (local.set $veff_u1 (f32.add (local.get $veff_u1) (f32.const 1)))))
                    (if (i32.eq (local.get $n) (i32.const 2)) (then (local.set $veff_u2 (f32.add (local.get $veff_u2) (f32.const 1)))))
                  )
                  (else
                    (if (i32.lt_s (local.get $n) (i32.const 6))
                      (then
                        (if (i32.eq (local.get $n) (i32.const 3))
                          (then
                            (local.set $veff_u1 (f32.add (local.get $veff_u1) (local.get $rr2)))
                            (local.set $veff_u2 (f32.add (local.get $veff_u2) (f32.neg (local.get $rr1))))
                          )
                        )
                        (if (i32.eq (local.get $n) (i32.const 4))
                          (then
                            (local.set $veff_u0 (f32.add (local.get $veff_u0) (f32.neg (local.get $rr2))))
                            (local.set $veff_u2 (f32.add (local.get $veff_u2) (local.get $rr0)))
                          )
                        )
                        (if (i32.eq (local.get $n) (i32.const 5))
                          (then
                            (local.set $veff_u0 (f32.add (local.get $veff_u0) (local.get $rr1)))
                            (local.set $veff_u1 (f32.add (local.get $veff_u1) (f32.neg (local.get $rr0))))
                          )
                        )
                      )
                    )
                  )
                )

                (local.set $f_u0 (f32.sub (f32.mul (local.get $veff_u1) (local.get $g2)) (f32.mul (local.get $veff_u2) (local.get $g1))))
                (local.set $f_u1 (f32.sub (f32.mul (local.get $veff_u2) (local.get $g0)) (f32.mul (local.get $veff_u0) (local.get $g2))))
                (local.set $f_u2 (f32.sub (f32.mul (local.get $veff_u0) (local.get $g1)) (f32.mul (local.get $veff_u1) (local.get $g0))))

                (local.set $tmp (call $load_f32_at (local.get $gam_u_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))))
                (local.set $fg_u0 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u0)))))
                (local.set $fg_u1 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u1)))))
                (local.set $fg_u2 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u2)))))

                (local.set $fnv (f32.add (f32.add (f32.mul (local.get $env0) (local.get $fg_u0)) (f32.mul (local.get $env1) (local.get $fg_u1)))
                                         (f32.mul (local.get $env2) (local.get $fg_u2))))
                (call $store_f32_at (local.get $dcp_u_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))
                  (f32.div (local.get $fnv) (local.get $tmp2)))

                (local.set $dcfx (f32.div (local.get $fg_u0) (local.get $sr)))
                (local.set $dcfy (f32.div (local.get $fg_u1) (local.get $sr)))
                (local.set $dcfz (f32.div (local.get $fg_u2) (local.get $sr)))

                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $dcfx)))
                (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $dcfy)))
                (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $dcfz)))

                (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1)) (f32.mul (local.get $dcfy) (local.get $r2))) (local.get $cr))))
                (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2)) (f32.mul (local.get $dcfz) (local.get $r0))) (local.get $cr))))
                (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0)) (f32.mul (local.get $dcfx) (local.get $r1))) (local.get $cr))))

                (call $store_f32_at (local.get $cnc_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
                  (f32.add (call $load_f32_at (local.get $cnc_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                           (f32.mul (local.get $cr) (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                                   (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))))

            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_u)
          )
        )

            ;; NCONTROL derivatives
            (local.set $n (i32.const 0))
            (block $done_d
              (loop $loop_d
                (br_if $done_d (i32.ge_s (local.get $n) (local.get $ncontrol)))
                (local.set $idx2v (i32.add (local.get $i) (i32.mul (local.get $nvor) (local.get $n))))
                (if (i32.ne (local.get $lnfld) (i32.const 0))
                  (then
                    (local.set $veff_d0 (call $load_f32_at (local.get $wv_d_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                    (local.set $veff_d1 (call $load_f32_at (local.get $wv_d_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                    (local.set $veff_d2 (call $load_f32_at (local.get $wv_d_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                  )
                  (else
                    (local.set $veff_d0 (call $load_f32_at (local.get $vv_d_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                    (local.set $veff_d1 (call $load_f32_at (local.get $vv_d_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                    (local.set $veff_d2 (call $load_f32_at (local.get $vv_d_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                  )
                )

                (local.set $f_d0 (f32.sub (f32.mul (local.get $veff_d1) (local.get $g2)) (f32.mul (local.get $veff_d2) (local.get $g1))))
                (local.set $f_d1 (f32.sub (f32.mul (local.get $veff_d2) (local.get $g0)) (f32.mul (local.get $veff_d0) (local.get $g2))))
                (local.set $f_d2 (f32.sub (f32.mul (local.get $veff_d0) (local.get $g1)) (f32.mul (local.get $veff_d1) (local.get $g0))))

                (local.set $tmp (call $load_f32_at (local.get $gam_d_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))))
                (local.set $fg_d0 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_d0)))))
                (local.set $fg_d1 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_d1)))))
                (local.set $fg_d2 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_d2)))))

                (local.set $envd0 (call $load_f32_at (local.get $env_d_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                (local.set $envd1 (call $load_f32_at (local.get $env_d_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                (local.set $envd2 (call $load_f32_at (local.get $env_d_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))

                (local.set $fnv
                  (f32.add
                    (f32.add
                      (f32.add (f32.mul (local.get $env0) (local.get $fg_d0))
                               (f32.mul (local.get $env1) (local.get $fg_d1)))
                      (f32.mul (local.get $env2) (local.get $fg_d2)))
                    (f32.add
                      (f32.add (f32.mul (local.get $envd0) (local.get $fg0))
                               (f32.mul (local.get $envd1) (local.get $fg1)))
                      (f32.mul (local.get $envd2) (local.get $fg2)))))
                (call $store_f32_at (local.get $dcp_d_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))
                  (f32.div (local.get $fnv) (local.get $tmp2)))

                (local.set $dcfx (f32.div (local.get $fg_d0) (local.get $sr)))
                (local.set $dcfy (f32.div (local.get $fg_d1) (local.get $sr)))
                (local.set $dcfz (f32.div (local.get $fg_d2) (local.get $sr)))

                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (call $store_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $dcfx)))
                (call $store_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $dcfy)))
                (call $store_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $dcfz)))

                (call $store_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1)) (f32.mul (local.get $dcfy) (local.get $r2))) (local.get $cr))))
                (call $store_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2)) (f32.mul (local.get $dcfz) (local.get $r0))) (local.get $cr))))
                (call $store_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0)) (f32.mul (local.get $dcfx) (local.get $r1))) (local.get $cr))))

                (call $store_f32_at (local.get $cnc_d_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
                  (f32.add (call $load_f32_at (local.get $cnc_d_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                           (f32.mul (local.get $cr) (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                                   (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))))

                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br 0)
              )
            )

            ;; NDESIGN derivatives
            (local.set $n (i32.const 0))
            (block $done_g
              (loop $loop_g
                (br_if $done_g (i32.ge_s (local.get $n) (local.get $ndesign)))
                (local.set $idx2v (i32.add (local.get $i) (i32.mul (local.get $nvor) (local.get $n))))
                (if (i32.ne (local.get $lnfld) (i32.const 0))
                  (then
                    (local.set $veff_g0 (call $load_f32_at (local.get $wv_g_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                    (local.set $veff_g1 (call $load_f32_at (local.get $wv_g_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                    (local.set $veff_g2 (call $load_f32_at (local.get $wv_g_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                  )
                  (else
                    (local.set $veff_g0 (call $load_f32_at (local.get $vv_g_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                    (local.set $veff_g1 (call $load_f32_at (local.get $vv_g_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                    (local.set $veff_g2 (call $load_f32_at (local.get $vv_g_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                  )
                )

                (local.set $f_g0 (f32.sub (f32.mul (local.get $veff_g1) (local.get $g2)) (f32.mul (local.get $veff_g2) (local.get $g1))))
                (local.set $f_g1 (f32.sub (f32.mul (local.get $veff_g2) (local.get $g0)) (f32.mul (local.get $veff_g0) (local.get $g2))))
                (local.set $f_g2 (f32.sub (f32.mul (local.get $veff_g0) (local.get $g1)) (f32.mul (local.get $veff_g1) (local.get $g0))))

                (local.set $tmp (call $load_f32_at (local.get $gam_g_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))))
                (local.set $fg_g0 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_g0)))))
                (local.set $fg_g1 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_g1)))))
                (local.set $fg_g2 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2)))
                                           (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_g2)))))

                (local.set $envg0 (call $load_f32_at (local.get $env_g_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                (local.set $envg1 (call $load_f32_at (local.get $env_g_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                (local.set $envg2 (call $load_f32_at (local.get $env_g_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))

                (local.set $fnv
                  (f32.add
                    (f32.add
                      (f32.add (f32.mul (local.get $env0) (local.get $fg_g0))
                               (f32.mul (local.get $env1) (local.get $fg_g1)))
                      (f32.mul (local.get $env2) (local.get $fg_g2)))
                    (f32.add
                      (f32.add (f32.mul (local.get $envg0) (local.get $fg0))
                               (f32.mul (local.get $envg1) (local.get $fg1)))
                      (f32.mul (local.get $envg2) (local.get $fg2))))
                )
                (call $store_f32_at (local.get $dcp_g_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))
                  (f32.div (local.get $fnv) (local.get $tmp2)))

                (local.set $dcfx (f32.div (local.get $fg_g0) (local.get $sr)))
                (local.set $dcfy (f32.div (local.get $fg_g1) (local.get $sr)))
                (local.set $dcfz (f32.div (local.get $fg_g2) (local.get $sr)))

                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (call $store_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $dcfx)))
                (call $store_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $dcfy)))
                (call $store_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $dcfz)))

                (call $store_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1)) (f32.mul (local.get $dcfy) (local.get $r2))) (local.get $cr))))
                (call $store_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2)) (f32.mul (local.get $dcfz) (local.get $r0))) (local.get $cr))))
                (call $store_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))
                           (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0)) (f32.mul (local.get $dcfx) (local.get $r1))) (local.get $cr))))

                (call $store_f32_at (local.get $cnc_g_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
                  (f32.add (call $load_f32_at (local.get $cnc_g_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                           (f32.mul (local.get $cr) (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                                   (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))))

                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br 0)
              )
            )

            ;; Hinge moments
            (local.set $l (i32.const 0))
            (block $done_hinge
              (loop $loop_hinge
                (br_if $done_hinge (i32.ge_s (local.get $l) (local.get $ncontrol)))
                (local.set $r0
                  (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV)) (call $idx3 (i32.const 0) (local.get $i)))
                           (call $load_f32_at (local.get $phinge_ptr) (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $l) (local.get $nstrip)) (i32.const 3)))))
                (local.set $r1
                  (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV)) (call $idx3 (i32.const 1) (local.get $i)))
                           (call $load_f32_at (local.get $phinge_ptr) (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $l) (local.get $nstrip)) (i32.const 3)))))
                (local.set $r2
                  (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV)) (call $idx3 (i32.const 2) (local.get $i)))
                           (call $load_f32_at (local.get $phinge_ptr) (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $l) (local.get $nstrip)) (i32.const 3)))))

                (local.set $dfac
                  (f32.div
                    (call $load_f32_at (local.get $dcontrol_ptr) (call $idx2 (local.get $i) (local.get $l) (local.get $nvor)))
                    (f32.mul (local.get $sref) (local.get $cref))))

                (local.set $ve0 (call $load_f32_at (local.get $vhinge_ptr) (call $idx2 (i32.const 0) (call $idx2 (local.get $j) (local.get $l) (local.get $nstrip)) (i32.const 3))))
                (local.set $ve1 (call $load_f32_at (local.get $vhinge_ptr) (call $idx2 (i32.const 1) (call $idx2 (local.get $j) (local.get $l) (local.get $nstrip)) (i32.const 3))))
                (local.set $ve2 (call $load_f32_at (local.get $vhinge_ptr) (call $idx2 (i32.const 2) (call $idx2 (local.get $j) (local.get $l) (local.get $nstrip)) (i32.const 3))))

                (local.set $f_u0 (f32.sub (f32.mul (local.get $r1) (local.get $fg2)) (f32.mul (local.get $r2) (local.get $fg1))))
                (local.set $f_u1 (f32.sub (f32.mul (local.get $r2) (local.get $fg0)) (f32.mul (local.get $r0) (local.get $fg2))))
                (local.set $f_u2 (f32.sub (f32.mul (local.get $r0) (local.get $fg1)) (f32.mul (local.get $r1) (local.get $fg0))))
                (local.set $tmp (f32.add (f32.add (f32.mul (local.get $f_u0) (local.get $ve0))
                                                  (f32.mul (local.get $f_u1) (local.get $ve1)))
                                         (f32.mul (local.get $f_u2) (local.get $ve2))))
                (call $store_f32_at (local.get $chinge_ptr) (local.get $l)
                  (f32.add (call $load_f32_at (local.get $chinge_ptr) (local.get $l))
                           (f32.mul (local.get $tmp) (local.get $dfac))))

                ;; U-derivative hinge terms
                (local.set $n (i32.const 0))
                (block $done_hu
                  (loop $loop_hu
                    (br_if $done_hu (i32.ge_s (local.get $n) (local.get $numax)))
                    (local.set $idx2v (i32.add (local.get $i) (i32.mul (local.get $nvor) (local.get $n))))
                    (if (i32.ne (local.get $lnfld) (i32.const 0))
                      (then
                        (local.set $veff_u0 (call $load_f32_at (local.get $wv_u_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                        (local.set $veff_u1 (call $load_f32_at (local.get $wv_u_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                        (local.set $veff_u2 (call $load_f32_at (local.get $wv_u_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                      )
                      (else
                        (local.set $veff_u0 (call $load_f32_at (local.get $vv_u_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                        (local.set $veff_u1 (call $load_f32_at (local.get $vv_u_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                        (local.set $veff_u2 (call $load_f32_at (local.get $vv_u_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                      )
                    )
                    (if (i32.lt_s (local.get $n) (i32.const 3))
                      (then
                        (if (i32.eq (local.get $n) (i32.const 0)) (then (local.set $veff_u0 (f32.add (local.get $veff_u0) (f32.const 1)))))
                        (if (i32.eq (local.get $n) (i32.const 1)) (then (local.set $veff_u1 (f32.add (local.get $veff_u1) (f32.const 1)))))
                        (if (i32.eq (local.get $n) (i32.const 2)) (then (local.set $veff_u2 (f32.add (local.get $veff_u2) (f32.const 1)))))
                      )
                      (else
                        (if (i32.lt_s (local.get $n) (i32.const 6))
                          (then
                            (if (i32.eq (local.get $n) (i32.const 3))
                              (then
                                (local.set $veff_u1 (f32.add (local.get $veff_u1) (local.get $rr2)))
                                (local.set $veff_u2 (f32.add (local.get $veff_u2) (f32.neg (local.get $rr1))))
                              )
                            )
                            (if (i32.eq (local.get $n) (i32.const 4))
                              (then
                                (local.set $veff_u0 (f32.add (local.get $veff_u0) (f32.neg (local.get $rr2))))
                                (local.set $veff_u2 (f32.add (local.get $veff_u2) (local.get $rr0)))
                              )
                            )
                            (if (i32.eq (local.get $n) (i32.const 5))
                              (then
                                (local.set $veff_u0 (f32.add (local.get $veff_u0) (local.get $rr1)))
                                (local.set $veff_u1 (f32.add (local.get $veff_u1) (f32.neg (local.get $rr0))))
                              )
                            )
                          )
                        )
                      )
                    )

                    (local.set $f_u0 (f32.sub (f32.mul (local.get $veff_u1) (local.get $g2)) (f32.mul (local.get $veff_u2) (local.get $g1))))
                    (local.set $f_u1 (f32.sub (f32.mul (local.get $veff_u2) (local.get $g0)) (f32.mul (local.get $veff_u0) (local.get $g2))))
                    (local.set $f_u2 (f32.sub (f32.mul (local.get $veff_u0) (local.get $g1)) (f32.mul (local.get $veff_u1) (local.get $g0))))

                    (local.set $tmp (call $load_f32_at (local.get $gam_u_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))))
                    (local.set $fg_u0 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u0)))))
                    (local.set $fg_u1 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u1)))))
                    (local.set $fg_u2 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u2)))))

                    (local.set $f_u0 (f32.sub (f32.mul (local.get $r1) (local.get $fg_u2)) (f32.mul (local.get $r2) (local.get $fg_u1))))
                    (local.set $f_u1 (f32.sub (f32.mul (local.get $r2) (local.get $fg_u0)) (f32.mul (local.get $r0) (local.get $fg_u2))))
                    (local.set $f_u2 (f32.sub (f32.mul (local.get $r0) (local.get $fg_u1)) (f32.mul (local.get $r1) (local.get $fg_u0))))
                    (local.set $tmp (f32.add (f32.add (f32.mul (local.get $f_u0) (local.get $ve0))
                                                      (f32.mul (local.get $f_u1) (local.get $ve1)))
                                             (f32.mul (local.get $f_u2) (local.get $ve2))))
                    (local.set $idx (call $idx2 (local.get $l) (local.get $n) (local.get $ncontrol)))
                    (call $store_f32_at (local.get $chinge_u_ptr) (local.get $idx)
                      (f32.add (call $load_f32_at (local.get $chinge_u_ptr) (local.get $idx))
                               (f32.mul (local.get $tmp) (local.get $dfac))))

                    (local.set $n (i32.add (local.get $n) (i32.const 1)))
                    (br $loop_hu)
                  )
                )

                ;; D-derivative hinge terms
                (local.set $n (i32.const 0))
                (block $done_hd
                  (loop $loop_hd
                    (br_if $done_hd (i32.ge_s (local.get $n) (local.get $ncontrol)))
                    (local.set $idx2v (i32.add (local.get $i) (i32.mul (local.get $nvor) (local.get $n))))
                    (if (i32.ne (local.get $lnfld) (i32.const 0))
                      (then
                        (local.set $veff_d0 (call $load_f32_at (local.get $wv_d_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                        (local.set $veff_d1 (call $load_f32_at (local.get $wv_d_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                        (local.set $veff_d2 (call $load_f32_at (local.get $wv_d_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                      )
                      (else
                        (local.set $veff_d0 (call $load_f32_at (local.get $vv_d_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                        (local.set $veff_d1 (call $load_f32_at (local.get $vv_d_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                        (local.set $veff_d2 (call $load_f32_at (local.get $vv_d_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                      )
                    )
                    (local.set $f_d0 (f32.sub (f32.mul (local.get $veff_d1) (local.get $g2)) (f32.mul (local.get $veff_d2) (local.get $g1))))
                    (local.set $f_d1 (f32.sub (f32.mul (local.get $veff_d2) (local.get $g0)) (f32.mul (local.get $veff_d0) (local.get $g2))))
                    (local.set $f_d2 (f32.sub (f32.mul (local.get $veff_d0) (local.get $g1)) (f32.mul (local.get $veff_d1) (local.get $g0))))
                    (local.set $tmp (call $load_f32_at (local.get $gam_d_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))))
                    (local.set $fg_d0 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_d0)))))
                    (local.set $fg_d1 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_d1)))))
                    (local.set $fg_d2 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_d2)))))
                    (local.set $f_u0 (f32.sub (f32.mul (local.get $r1) (local.get $fg_d2)) (f32.mul (local.get $r2) (local.get $fg_d1))))
                    (local.set $f_u1 (f32.sub (f32.mul (local.get $r2) (local.get $fg_d0)) (f32.mul (local.get $r0) (local.get $fg_d2))))
                    (local.set $f_u2 (f32.sub (f32.mul (local.get $r0) (local.get $fg_d1)) (f32.mul (local.get $r1) (local.get $fg_d0))))
                    (local.set $tmp (f32.add (f32.add (f32.mul (local.get $f_u0) (local.get $ve0))
                                                      (f32.mul (local.get $f_u1) (local.get $ve1)))
                                             (f32.mul (local.get $f_u2) (local.get $ve2))))
                    (local.set $idx (call $idx2 (local.get $l) (local.get $n) (local.get $ncontrol)))
                    (call $store_f32_at (local.get $chinge_d_ptr) (local.get $idx)
                      (f32.add (call $load_f32_at (local.get $chinge_d_ptr) (local.get $idx))
                               (f32.mul (local.get $tmp) (local.get $dfac))))
                    (local.set $n (i32.add (local.get $n) (i32.const 1)))
                    (br $loop_hd)
                  )
                )

                ;; G-derivative hinge terms
                (local.set $n (i32.const 0))
                (block $done_hg
                  (loop $loop_hg
                    (br_if $done_hg (i32.ge_s (local.get $n) (local.get $ndesign)))
                    (local.set $idx2v (i32.add (local.get $i) (i32.mul (local.get $nvor) (local.get $n))))
                    (if (i32.ne (local.get $lnfld) (i32.const 0))
                      (then
                        (local.set $veff_g0 (call $load_f32_at (local.get $wv_g_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                        (local.set $veff_g1 (call $load_f32_at (local.get $wv_g_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                        (local.set $veff_g2 (call $load_f32_at (local.get $wv_g_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                      )
                      (else
                        (local.set $veff_g0 (call $load_f32_at (local.get $vv_g_ptr) (call $idx3 (i32.const 0) (local.get $idx2v))))
                        (local.set $veff_g1 (call $load_f32_at (local.get $vv_g_ptr) (call $idx3 (i32.const 1) (local.get $idx2v))))
                        (local.set $veff_g2 (call $load_f32_at (local.get $vv_g_ptr) (call $idx3 (i32.const 2) (local.get $idx2v))))
                      )
                    )
                    (local.set $f_g0 (f32.sub (f32.mul (local.get $veff_g1) (local.get $g2)) (f32.mul (local.get $veff_g2) (local.get $g1))))
                    (local.set $f_g1 (f32.sub (f32.mul (local.get $veff_g2) (local.get $g0)) (f32.mul (local.get $veff_g0) (local.get $g2))))
                    (local.set $f_g2 (f32.sub (f32.mul (local.get $veff_g0) (local.get $g1)) (f32.mul (local.get $veff_g1) (local.get $g0))))
                    (local.set $tmp (call $load_f32_at (local.get $gam_g_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))))
                    (local.set $fg_g0 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_g0)))))
                    (local.set $fg_g1 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_g1)))))
                    (local.set $fg_g2 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2)))
                                               (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_g2)))))
                    (local.set $f_u0 (f32.sub (f32.mul (local.get $r1) (local.get $fg_g2)) (f32.mul (local.get $r2) (local.get $fg_g1))))
                    (local.set $f_u1 (f32.sub (f32.mul (local.get $r2) (local.get $fg_g0)) (f32.mul (local.get $r0) (local.get $fg_g2))))
                    (local.set $f_u2 (f32.sub (f32.mul (local.get $r0) (local.get $fg_g1)) (f32.mul (local.get $r1) (local.get $fg_g0))))
                    (local.set $tmp (f32.add (f32.add (f32.mul (local.get $f_u0) (local.get $ve0))
                                                      (f32.mul (local.get $f_u1) (local.get $ve1)))
                                             (f32.mul (local.get $f_u2) (local.get $ve2))))
                    (local.set $idx (call $idx2 (local.get $l) (local.get $n) (local.get $ncontrol)))
                    (call $store_f32_at (local.get $chinge_g_ptr) (local.get $idx)
                      (f32.add (call $load_f32_at (local.get $chinge_g_ptr) (local.get $idx))
                               (f32.mul (local.get $tmp) (local.get $dfac))))
                    (local.set $n (i32.add (local.get $n) (i32.const 1)))
                    (br $loop_hg)
                  )
                )

                (local.set $l (i32.add (local.get $l) (i32.const 1)))
                (br $loop_hinge)
              )
            )

            (local.set $ii (i32.add (local.get $ii) (i32.const 1)))
            (br $loop_ii)
          )
        )

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDV_LSTRP)) (local.get $j) (f32.const 0))

        ;; Viscous corrections
        (if (i32.and (i32.ne (local.get $lvisc) (i32.const 0))
                     (i32.ne (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_LVISCSTRP)) (i32.mul (local.get $j) (i32.const 4)))) (i32.const 0)))
          (then
            (local.set $rr0 (f32.sub (local.get $rc40) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 0))))
            (local.set $rr1 (f32.sub (local.get $rc41) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 1))))
            (local.set $rr2 (f32.sub (local.get $rc42) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 2))))

            (local.set $vr0 (f32.sub (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))
                                     (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))))
            (local.set $vr1 (f32.sub (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))
                                     (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))))
            (local.set $vr2 (f32.sub (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))
                                     (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))))

            (local.set $ve0 (f32.add (local.get $ud0) (local.get $vr0)))
            (local.set $ve1 (f32.add (local.get $ud1) (local.get $vr1)))
            (local.set $ve2 (f32.add (local.get $ud2) (local.get $vr2)))
            (local.set $veffmag
              (call $sqrt_f32 (f32.add (f32.add (f32.mul (local.get $ve0) (local.get $ve0))
                                              (f32.mul (local.get $ve1) (local.get $ve1)))
                                       (f32.mul (local.get $ve2) (local.get $ve2)))))

            (local.set $tmp (f32.add (f32.add (f32.mul (local.get $ul0) (local.get $cfx))
                                              (f32.mul (local.get $ul1) (local.get $cfy)))
                                     (f32.mul (local.get $ul2) (local.get $cfz))))
            (local.set $ptr (i32.add (local.get $clcd_ptr) (i32.mul (local.get $j) (i32.const 24))))
            (local.set $ptr2 (i32.const 2048))
            (call $cdcl (local.get $ptr) (local.get $tmp) (local.get $ptr2))
            (local.set $cdv (f32.load (local.get $ptr2)))
            (local.set $cdv_clv (f32.load (i32.add (local.get $ptr2) (i32.const 4))))

            (local.set $dcfx (f32.mul (f32.mul (local.get $ve0) (local.get $veffmag)) (local.get $cdv)))
            (local.set $dcfy (f32.mul (f32.mul (local.get $ve1) (local.get $veffmag)) (local.get $cdv)))
            (local.set $dcfz (f32.mul (f32.mul (local.get $ve2) (local.get $veffmag)) (local.get $cdv)))
            (local.set $cfx (f32.add (local.get $cfx) (local.get $dcfx)))
            (local.set $cfy (f32.add (local.get $cfy) (local.get $dcfy)))
            (local.set $cfz (f32.add (local.get $cfz) (local.get $dcfz)))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDV_LSTRP)) (local.get $j)
              (f32.add (f32.add (f32.mul (local.get $ud0) (local.get $dcfx))
                                (f32.mul (local.get $ud1) (local.get $dcfy)))
                       (f32.mul (local.get $ud2) (local.get $dcfz))))

            ;; LVISC U-derivatives
            (local.set $n (i32.const 0))
            (block $done_lv_u
              (loop $loop_lv_u
                (br_if $done_lv_u (i32.ge_s (local.get $n) (local.get $numax)))
                (local.set $udrag_u0 (f32.const 0))
                (local.set $udrag_u1 (f32.const 0))
                (local.set $udrag_u2 (f32.const 0))
                (if (i32.eq (local.get $n) (i32.const 0)) (then (local.set $udrag_u0 (f32.const 1))))
                (if (i32.eq (local.get $n) (i32.const 1)) (then (local.set $udrag_u1 (f32.const 1))))
                (if (i32.eq (local.get $n) (i32.const 2)) (then (local.set $udrag_u2 (f32.const 1))))

                (local.set $ulift_u0 (f32.sub (f32.mul (local.get $udrag_u1) (local.get $spn2)) (f32.mul (local.get $udrag_u2) (local.get $spn1))))
                (local.set $ulift_u1 (f32.sub (f32.mul (local.get $udrag_u2) (f32.const 0)) (f32.mul (local.get $udrag_u0) (local.get $spn2))))
                (local.set $ulift_u2 (f32.sub (f32.mul (local.get $udrag_u0) (local.get $spn1)) (f32.mul (local.get $udrag_u1) (f32.const 0))))

                (if (f32.ne (local.get $ulmag) (f32.const 0))
                  (then
                    (local.set $tmp
                      (f32.div
                        (f32.add (f32.add (f32.mul (local.get $ul0) (local.get $ulift_u0))
                                          (f32.mul (local.get $ul1) (local.get $ulift_u1)))
                                 (f32.mul (local.get $ul2) (local.get $ulift_u2)))
                        (local.get $ulmag)))
                    (local.set $ulift_u0 (f32.div (f32.sub (local.get $ulift_u0) (f32.mul (local.get $ul0) (local.get $tmp))) (local.get $ulmag)))
                    (local.set $ulift_u1 (f32.div (f32.sub (local.get $ulift_u1) (f32.mul (local.get $ul1) (local.get $tmp))) (local.get $ulmag)))
                    (local.set $ulift_u2 (f32.div (f32.sub (local.get $ulift_u2) (f32.mul (local.get $ul2) (local.get $tmp))) (local.get $ulmag)))
                  )
                  (else
                    (local.set $ulift_u0 (f32.const 0))
                    (local.set $ulift_u1 (f32.const 0))
                    (local.set $ulift_u2 (f32.const 0))
                  )
                )

                (local.set $veff_u0 (f32.const 0))
                (local.set $veff_u1 (f32.const 0))
                (local.set $veff_u2 (f32.const 0))
                (if (i32.eq (local.get $n) (i32.const 0)) (then (local.set $veff_u0 (f32.const 1))))
                (if (i32.eq (local.get $n) (i32.const 1)) (then (local.set $veff_u1 (f32.const 1))))
                (if (i32.eq (local.get $n) (i32.const 2)) (then (local.set $veff_u2 (f32.const 1))))
                (if (i32.eq (local.get $n) (i32.const 3))
                  (then
                    (local.set $veff_u1 (local.get $rr2))
                    (local.set $veff_u2 (f32.neg (local.get $rr1)))
                  )
                )
                (if (i32.eq (local.get $n) (i32.const 4))
                  (then
                    (local.set $veff_u0 (f32.neg (local.get $rr2)))
                    (local.set $veff_u2 (local.get $rr0))
                  )
                )
                (if (i32.eq (local.get $n) (i32.const 5))
                  (then
                    (local.set $veff_u0 (local.get $rr1))
                    (local.set $veff_u1 (f32.neg (local.get $rr0)))
                  )
                )

                (local.set $veffmag_u
                  (f32.div (f32.add (f32.add (f32.mul (local.get $ve0) (local.get $veff_u0))
                                              (f32.mul (local.get $ve1) (local.get $veff_u1)))
                                     (f32.mul (local.get $ve2) (local.get $veff_u2)))
                           (local.get $veffmag)))

                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (local.set $clv
                  (f32.add
                    (f32.add
                      (f32.add (f32.mul (local.get $ul0) (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
                               (f32.mul (local.get $ulift_u0) (local.get $cfx)))
                      (f32.add (f32.mul (local.get $ul1) (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
                               (f32.mul (local.get $ulift_u1) (local.get $cfy))))
                    (f32.add (f32.mul (local.get $ul2) (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
                             (f32.mul (local.get $ulift_u2) (local.get $cfz)))))
                (local.set $dcfx
                  (f32.add
                    (f32.mul (f32.add (f32.mul (local.get $veff_u0) (local.get $veffmag)) (f32.mul (local.get $ve0) (local.get $veffmag_u))) (local.get $cdv))
                    (f32.mul (f32.mul (local.get $ve0) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv)))))
                (local.set $dcfy
                  (f32.add
                    (f32.mul (f32.add (f32.mul (local.get $veff_u1) (local.get $veffmag)) (f32.mul (local.get $ve1) (local.get $veffmag_u))) (local.get $cdv))
                    (f32.mul (f32.mul (local.get $ve1) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv)))))
                (local.set $dcfz
                  (f32.add
                    (f32.mul (f32.add (f32.mul (local.get $veff_u2) (local.get $veffmag)) (f32.mul (local.get $ve2) (local.get $veffmag_u))) (local.get $cdv))
                    (f32.mul (f32.mul (local.get $ve2) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv)))))

                (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $dcfx)))
                (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $dcfy)))
                (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $dcfz)))

                (call $store_f32_at (local.get $cnc_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
                  (f32.add (call $load_f32_at (local.get $cnc_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                           (f32.mul (local.get $cr) (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                                   (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))))

                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_lv_u)
              )
            )
            ;; LVISC D-derivatives
            (local.set $n (i32.const 0))
            (block $done_lv_d
              (loop $loop_lv_d
                (br_if $done_lv_d (i32.ge_s (local.get $n) (local.get $ncontrol)))
                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (local.set $clv
                  (f32.add
                    (f32.add
                      (f32.mul (local.get $ul0) (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
                      (f32.mul (local.get $ul1) (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
                    )
                    (f32.mul (local.get $ul2) (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
                  )
                )
                (local.set $dcfx (f32.mul (f32.mul (local.get $ve0) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv))))
                (local.set $dcfy (f32.mul (f32.mul (local.get $ve1) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv))))
                (local.set $dcfz (f32.mul (f32.mul (local.get $ve2) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv))))

                (call $store_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $dcfx)))
                (call $store_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $dcfy)))
                (call $store_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $dcfz)))
                (call $store_f32_at (local.get $cnc_d_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
                  (f32.add (call $load_f32_at (local.get $cnc_d_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                           (f32.mul (local.get $cr) (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                                   (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))))
                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_lv_d)
              )
            )

            ;; LVISC G-derivatives
            (local.set $n (i32.const 0))
            (block $done_lv_g
              (loop $loop_lv_g
                (br_if $done_lv_g (i32.ge_s (local.get $n) (local.get $ndesign)))
                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (local.set $clv
                  (f32.add
                    (f32.add
                      (f32.mul (local.get $ul0) (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
                      (f32.mul (local.get $ul1) (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
                    )
                    (f32.mul (local.get $ul2) (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
                  )
                )
                (local.set $dcfx (f32.mul (f32.mul (local.get $ve0) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv))))
                (local.set $dcfy (f32.mul (f32.mul (local.get $ve1) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv))))
                (local.set $dcfz (f32.mul (f32.mul (local.get $ve2) (local.get $veffmag)) (f32.mul (local.get $cdv_clv) (local.get $clv))))

                (call $store_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $dcfx)))
                (call $store_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $dcfy)))
                (call $store_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $dcfz)))
                (call $store_f32_at (local.get $cnc_g_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
                  (f32.add (call $load_f32_at (local.get $cnc_g_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                           (f32.mul (local.get $cr) (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                                   (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))))
                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_lv_g)
              )
            )
          )
        )

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3)) (local.get $cfx))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3)) (local.get $cfy))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3)) (local.get $cfz))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3)) (local.get $cmx))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3)) (local.get $cmy))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3)) (local.get $cmz))

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3)) (local.get $cfx))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3)) (local.get $cfy))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3)) (local.get $cfz))

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDSTRP)) (local.get $j) (f32.add (f32.mul (local.get $cfx) (local.get $cosa)) (f32.mul (local.get $cfz) (local.get $sina))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYSTRP)) (local.get $j) (local.get $cfy))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLSTRP)) (local.get $j) (f32.add (f32.mul (f32.neg (local.get $cfx)) (local.get $sina)) (f32.mul (local.get $cfz) (local.get $cosa))))

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDST_A)) (local.get $j) (f32.add (f32.mul (f32.neg (local.get $cfx)) (local.get $sina)) (f32.mul (local.get $cfz) (local.get $cosa))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYST_A)) (local.get $j) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLST_A)) (local.get $j) (f32.add (f32.mul (f32.neg (local.get $cfx)) (local.get $cosa)) (f32.mul (f32.neg (local.get $cfz)) (local.get $sina))))

        ;; CDST/CYST/CLST derivatives (U)
        (local.set $n (i32.const 0))
        (block $done_cd_u
          (loop $loop_cd_u
            (br_if $done_cd_u (i32.ge_s (local.get $n) (local.get $numax)))
            (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
            (local.set $dcfx (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (local.set $dcfy (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (local.set $dcfz (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cdst_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
              (f32.add (f32.mul (local.get $dcfx) (local.get $cosa)) (f32.mul (local.get $dcfz) (local.get $sina))))
            (call $store_f32_at (local.get $cyst_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (local.get $dcfy))
            (call $store_f32_at (local.get $clst_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
              (f32.add (f32.mul (f32.neg (local.get $dcfx)) (local.get $sina)) (f32.mul (local.get $dcfz) (local.get $cosa))))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_cd_u)
          )
        )

        ;; CDST/CYST/CLST derivatives (D)
        (local.set $n (i32.const 0))
        (block $done_cd_d
          (loop $loop_cd_d
            (br_if $done_cd_d (i32.ge_s (local.get $n) (local.get $ncontrol)))
            (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
            (local.set $dcfx (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (local.set $dcfy (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (local.set $dcfz (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cdst_d_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
              (f32.add (f32.mul (local.get $dcfx) (local.get $cosa)) (f32.mul (local.get $dcfz) (local.get $sina))))
            (call $store_f32_at (local.get $cyst_d_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (local.get $dcfy))
            (call $store_f32_at (local.get $clst_d_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
              (f32.add (f32.mul (f32.neg (local.get $dcfx)) (local.get $sina)) (f32.mul (local.get $dcfz) (local.get $cosa))))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_cd_d)
          )
        )

        ;; CDST/CYST/CLST derivatives (G)
        (local.set $n (i32.const 0))
        (block $done_cd_g
          (loop $loop_cd_g
            (br_if $done_cd_g (i32.ge_s (local.get $n) (local.get $ndesign)))
            (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
            (local.set $dcfx (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (local.set $dcfy (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (local.set $dcfz (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cdst_g_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
              (f32.add (f32.mul (local.get $dcfx) (local.get $cosa)) (f32.mul (local.get $dcfz) (local.get $sina))))
            (call $store_f32_at (local.get $cyst_g_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)) (local.get $dcfy))
            (call $store_f32_at (local.get $clst_g_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
              (f32.add (f32.mul (f32.neg (local.get $dcfx)) (local.get $sina)) (f32.mul (local.get $dcfz) (local.get $cosa))))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_cd_g)
          )
        )

        (local.set $r0 (f32.sub (local.get $rc40) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 0))))
        (local.set $r1 (f32.sub (local.get $rc41) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 1))))
        (local.set $r2 (f32.sub (local.get $rc42) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 2))))

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3))
          (f32.add (local.get $cmx) (f32.div (f32.sub (f32.mul (local.get $cfz) (local.get $r1)) (f32.mul (local.get $cfy) (local.get $r2))) (local.get $cr))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3))
          (f32.add (local.get $cmy) (f32.div (f32.sub (f32.mul (local.get $cfx) (local.get $r2)) (f32.mul (local.get $cfz) (local.get $r0))) (local.get $cr))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3))
          (f32.add (local.get $cmz) (f32.div (f32.sub (f32.mul (local.get $cfy) (local.get $r0)) (f32.mul (local.get $cfx) (local.get $r1))) (local.get $cr))))

        ;; CMST_U shift to reference
        (local.set $n (i32.const 0))
        (block $done_cm_u
          (loop $loop_cm_u
            (br_if $done_cm_u (i32.ge_s (local.get $n) (local.get $numax)))
            (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
            (local.set $dcfx (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (local.set $dcfy (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (local.set $dcfz (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1)) (f32.mul (local.get $dcfy) (local.get $r2))) (local.get $cr))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2)) (f32.mul (local.get $dcfz) (local.get $r0))) (local.get $cr))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0)) (f32.mul (local.get $dcfx) (local.get $r1))) (local.get $cr))))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_cm_u)
          )
        )

        ;; CMST_D shift to reference
        (local.set $n (i32.const 0))
        (block $done_cm_d
          (loop $loop_cm_d
            (br_if $done_cm_d (i32.ge_s (local.get $n) (local.get $ncontrol)))
            (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
            (local.set $dcfx (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (local.set $dcfy (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (local.set $dcfz (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1)) (f32.mul (local.get $dcfy) (local.get $r2))) (local.get $cr))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2)) (f32.mul (local.get $dcfz) (local.get $r0))) (local.get $cr))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0)) (f32.mul (local.get $dcfx) (local.get $r1))) (local.get $cr))))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_cm_d)
          )
        )

        ;; CMST_G shift to reference
        (local.set $n (i32.const 0))
        (block $done_cm_g
          (loop $loop_cm_g
            (br_if $done_cm_g (i32.ge_s (local.get $n) (local.get $ndesign)))
            (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
            (local.set $dcfx (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (local.set $dcfy (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (local.set $dcfz (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1)) (f32.mul (local.get $dcfy) (local.get $r2))) (local.get $cr))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2)) (f32.mul (local.get $dcfz) (local.get $r0))) (local.get $cr))))
            (local.set $tmp (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))))
            (call $store_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))
              (f32.add (local.get $tmp) (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0)) (f32.mul (local.get $dcfx) (local.get $r1))) (local.get $cr))))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_cm_g)
          )
        )

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CL_LSTRP)) (local.get $j)
          (f32.add (f32.add (f32.mul (local.get $ul0) (local.get $cfx)) (f32.mul (local.get $ul1) (local.get $cfy)))
                   (f32.mul (local.get $ul2) (local.get $cfz))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CD_LSTRP)) (local.get $j)
          (f32.add (f32.add (f32.mul (local.get $ud0) (local.get $cfx)) (f32.mul (local.get $ud1) (local.get $cfy)))
                   (f32.mul (local.get $ud2) (local.get $cfz))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMC4_LSTRP)) (local.get $j)
          (f32.sub (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $cmy))
                   (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $cmz))))

        (local.set $tmp (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_AINC)) (local.get $j)))
        (local.set $tmp2 (call $sin_f32 (local.get $tmp)))
        (local.set $tmp3 (call $cos_f32 (local.get $tmp)))
        (local.set $cfx (f32.add (f32.mul (local.get $cfx) (local.get $tmp3))
                                 (f32.mul (f32.neg (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $cfy))
                                                            (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $cfz))))
                                          (local.get $tmp2))))
        (local.set $tmp (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $cfy))
                                 (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $cfz))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CA_LSTRP)) (local.get $j) (local.get $cfx))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CN_LSTRP)) (local.get $j)
          (f32.add (f32.mul (local.get $tmp) (local.get $tmp3)) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3))) (local.get $tmp2))))

        ;; CLT_LSTRP and CLA_LSTRP
        (local.set $rr0 (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XSREF)) (local.get $j)) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 0))))
        (local.set $rr1 (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_YSREF)) (local.get $j)) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 1))))
        (local.set $rr2 (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ZSREF)) (local.get $j)) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 2))))
        (local.set $vr0 (f32.sub (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))
                                 (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))))
        (local.set $vr1 (f32.sub (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))
                                 (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))))
        (local.set $vr2 (f32.sub (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))
                                 (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))))
        (local.set $ve0 (f32.add (local.get $ud0) (local.get $vr0)))
        (local.set $ve1 (f32.add (local.get $ud1) (local.get $vr1)))
        (local.set $ve2 (f32.add (local.get $ud2) (local.get $vr2)))
        (local.set $vsq (f32.add (f32.add (f32.mul (local.get $ve0) (local.get $ve0)) (f32.mul (local.get $ve1) (local.get $ve1))) (f32.mul (local.get $ve2) (local.get $ve2))))
        (local.set $vsqi (select (f32.div (f32.const 1) (local.get $vsq)) (f32.const 1) (f32.ne (local.get $vsq) (f32.const 0))))
        (local.set $ess0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ESS)) (call $idx3 (i32.const 0) (local.get $j))))
        (local.set $ess1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ESS)) (call $idx3 (i32.const 1) (local.get $j))))
        (local.set $ess2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ESS)) (call $idx3 (i32.const 2) (local.get $j))))
        (local.set $vspan (f32.add (f32.add (f32.mul (local.get $ve0) (local.get $ess0)) (f32.mul (local.get $ve1) (local.get $ess1))) (f32.mul (local.get $ve2) (local.get $ess2))))
        (local.set $vp0 (f32.sub (local.get $ve0) (f32.mul (local.get $ess0) (local.get $vspan))))
        (local.set $vp1 (f32.sub (local.get $ve1) (f32.mul (local.get $ess1) (local.get $vspan))))
        (local.set $vp2 (f32.sub (local.get $ve2) (f32.mul (local.get $ess2) (local.get $vspan))))
        (local.set $vpsq (f32.add (f32.add (f32.mul (local.get $vp0) (local.get $vp0)) (f32.mul (local.get $vp1) (local.get $vp1))) (f32.mul (local.get $vp2) (local.get $vp2))))
        (local.set $vpsqi (select (f32.div (f32.const 1) (local.get $vpsq)) (f32.const 1) (f32.ne (local.get $vpsq) (f32.const 0))))
        (local.set $tmp (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CL_LSTRP)) (local.get $j)))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLT_LSTRP)) (local.get $j) (f32.mul (local.get $tmp) (local.get $vpsqi)))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLA_LSTRP)) (local.get $j) (f32.mul (local.get $tmp) (local.get $vsqi)))

        ;; CMLE_LSTRP
        (local.set $rle0 (f32.sub (local.get $rc40) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 0) (local.get $j)))))
        (local.set $rle1 (f32.sub (local.get $rc41) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 1) (local.get $j)))))
        (local.set $rle2 (f32.sub (local.get $rc42) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 2) (local.get $j)))))
        (local.set $delx (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE2)) (call $idx3 (i32.const 0) (local.get $j)))
                                  (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE1)) (call $idx3 (i32.const 0) (local.get $j)))))
        (local.set $dely (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE2)) (call $idx3 (i32.const 1) (local.get $j)))
                                  (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE1)) (call $idx3 (i32.const 1) (local.get $j)))))
        (local.set $delz (f32.sub (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE2)) (call $idx3 (i32.const 2) (local.get $j)))
                                  (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE1)) (call $idx3 (i32.const 2) (local.get $j)))))
        (local.set $imags (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_IMAGS))
                                             (i32.mul (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_LSSURF)) (i32.mul (local.get $j) (i32.const 4)))) (i32.const 4)))))
        (if (i32.lt_s (local.get $imags) (i32.const 0))
          (then
            (local.set $delx (f32.neg (local.get $delx)))
            (local.set $dely (f32.neg (local.get $dely)))
            (local.set $delz (f32.neg (local.get $delz)))
          )
        )
        (local.set $dmag (call $sqrt_f32 (f32.add (f32.add (f32.mul (local.get $delx) (local.get $delx)) (f32.mul (local.get $dely) (local.get $dely))) (f32.mul (local.get $delz) (local.get $delz)))))
        (local.set $cmle (f32.const 0))
        (if (f32.ne (local.get $dmag) (f32.const 0))
          (then
            (local.set $cmle
              (f32.add
                (f32.add
                  (f32.mul (f32.div (local.get $delx) (local.get $dmag))
                           (f32.add (local.get $cmx) (f32.div (f32.sub (f32.mul (local.get $cfz) (local.get $rle1)) (f32.mul (local.get $cfy) (local.get $rle2))) (local.get $cr))))
                  (f32.mul (f32.div (local.get $dely) (local.get $dmag))
                           (f32.add (local.get $cmy) (f32.div (f32.sub (f32.mul (local.get $cfx) (local.get $rle2)) (f32.mul (local.get $cfz) (local.get $rle0))) (local.get $cr))))
                )
                (f32.mul (f32.div (local.get $delz) (local.get $dmag))
                         (f32.add (local.get $cmz) (f32.div (f32.sub (f32.mul (local.get $cfy) (local.get $rle0)) (f32.mul (local.get $cfx) (local.get $rle1))) (local.get $cr))))
              )
            )
          )
        )
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMLE_LSTRP)) (local.get $j) (local.get $cmle))

        ;; LTRFORCE wake-leg contributions (no derivatives)
        (if (i32.ne (local.get $ltr) (i32.const 0))
          (then
            (local.set $ii (i32.const 0))
            (block $done_ii2
              (loop $loop_ii2
                (br_if $done_ii2 (i32.ge_s (local.get $ii) (local.get $nvc)))
                (local.set $i (i32.add (local.get $i1) (local.get $ii)))
                (local.set $idx (i32.const 0))
                (block $done_leg
                  (loop $loop_leg
                    (br_if $done_leg (i32.ge_s (local.get $idx) (i32.const 2)))
                    (if (i32.eq (local.get $idx) (i32.const 0))
                      (then
                        (local.set $rv0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV1)) (call $idx3 (i32.const 0) (local.get $i))))
                        (local.set $rv1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV1)) (call $idx3 (i32.const 1) (local.get $i))))
                        (local.set $rv2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV1)) (call $idx3 (i32.const 2) (local.get $i))))
                        (local.set $r0 (f32.sub (f32.mul (f32.const 0.5) (f32.add (local.get $rv0) (local.get $xte1))) (local.get $rc40)))
                        (local.set $r1 (f32.sub (local.get $rv1) (local.get $rc41)))
                        (local.set $r2 (f32.sub (local.get $rv2) (local.get $rc42)))
                        (local.set $rr0 (f32.sub (f32.mul (f32.const 0.5) (f32.add (local.get $rv0) (local.get $xte1))) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 0))))
                        (local.set $rr1 (f32.sub (local.get $rv1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 1))))
                        (local.set $rr2 (f32.sub (local.get $rv2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 2))))
                        (local.set $g0 (f32.sub (local.get $rv0) (local.get $xte1)))
                        (local.set $g1 (f32.const 0))
                        (local.set $g2 (f32.const 0))
                      )
                      (else
                        (local.set $rv0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV2)) (call $idx3 (i32.const 0) (local.get $i))))
                        (local.set $rv1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV2)) (call $idx3 (i32.const 1) (local.get $i))))
                        (local.set $rv2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RV2)) (call $idx3 (i32.const 2) (local.get $i))))
                        (local.set $r0 (f32.sub (f32.mul (f32.const 0.5) (f32.add (local.get $rv0) (local.get $xte2))) (local.get $rc40)))
                        (local.set $r1 (f32.sub (local.get $rv1) (local.get $rc41)))
                        (local.set $r2 (f32.sub (local.get $rv2) (local.get $rc42)))
                        (local.set $rr0 (f32.sub (f32.mul (f32.const 0.5) (f32.add (local.get $rv0) (local.get $xte2))) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 0))))
                        (local.set $rr1 (f32.sub (local.get $rv1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 1))))
                        (local.set $rr2 (f32.sub (local.get $rv2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 2))))
                        (local.set $g0 (f32.sub (local.get $xte2) (local.get $rv0)))
                        (local.set $g1 (f32.const 0))
                        (local.set $g2 (f32.const 0))
                      )
                    )
                    (local.set $vr0 (f32.sub (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))
                                             (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))))
                    (local.set $vr1 (f32.sub (f32.mul (local.get $rr2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))
                                             (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))))
                    (local.set $vr2 (f32.sub (f32.mul (local.get $rr0) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))
                                             (f32.mul (local.get $rr1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))))
                    (local.set $ve0 (f32.add (local.get $ud0) (local.get $vr0)))
                    (local.set $ve1 (f32.add (local.get $ud1) (local.get $vr1)))
                    (local.set $ve2 (f32.add (local.get $ud2) (local.get $vr2)))

                    (local.set $f0 (f32.sub (f32.mul (local.get $ve1) (local.get $g2)) (f32.mul (local.get $ve2) (local.get $g1))))
                    (local.set $f1 (f32.sub (f32.mul (local.get $ve2) (local.get $g0)) (f32.mul (local.get $ve0) (local.get $g2))))
                    (local.set $f2 (f32.sub (f32.mul (local.get $ve0) (local.get $g1)) (f32.mul (local.get $ve1) (local.get $g0))))

                    (local.set $tmp (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)))
                    (local.set $fg0 (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0))))
                    (local.set $fg1 (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1))))
                    (local.set $fg2 (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2))))

                    (local.set $dcfx (f32.div (local.get $fg0) (local.get $sr)))
                    (local.set $dcfy (f32.div (local.get $fg1) (local.get $sr)))
                    (local.set $dcfz (f32.div (local.get $fg2) (local.get $sr)))
                    (local.set $cfx (f32.add (local.get $cfx) (local.get $dcfx)))
                    (local.set $cfy (f32.add (local.get $cfy) (local.get $dcfy)))
                    (local.set $cfz (f32.add (local.get $cfz) (local.get $dcfz)))
                    (local.set $cmx (f32.add (local.get $cmx)
                                             (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1))
                                                               (f32.mul (local.get $dcfy) (local.get $r2)))
                                                      (local.get $cr))))
                    (local.set $cmy (f32.add (local.get $cmy)
                                             (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2))
                                                               (f32.mul (local.get $dcfz) (local.get $r0)))
                                                      (local.get $cr))))
                    (local.set $cmz (f32.add (local.get $cmz)
                                             (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0))
                                                               (f32.mul (local.get $dcfx) (local.get $r1)))
                                                      (local.get $cr))))
                    (local.set $tmp
                      (f32.add
                        (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC)) (local.get $j))
                        (f32.mul (local.get $cr)
                                 (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                          (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))
                      )
                    )
                    (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CNC)) (local.get $j) (local.get $tmp))

                    ;; LTRFORCE U-derivatives
                    (local.set $n (i32.const 0))
                    (block $done_ltr_u
                      (loop $loop_ltr_u
                        (br_if $done_ltr_u (i32.ge_s (local.get $n) (local.get $numax)))
                        (local.set $veff_u0 (f32.const 0))
                        (local.set $veff_u1 (f32.const 0))
                        (local.set $veff_u2 (f32.const 0))
                        (if (i32.lt_s (local.get $n) (i32.const 3))
                          (then
                            (if (i32.eq (local.get $n) (i32.const 0)) (then (local.set $veff_u0 (f32.const 1))))
                            (if (i32.eq (local.get $n) (i32.const 1)) (then (local.set $veff_u1 (f32.const 1))))
                            (if (i32.eq (local.get $n) (i32.const 2)) (then (local.set $veff_u2 (f32.const 1))))
                          )
                          (else
                            (if (i32.lt_s (local.get $n) (i32.const 6))
                              (then
                                (if (i32.eq (local.get $n) (i32.const 3))
                                  (then
                                    (local.set $veff_u1 (f32.add (local.get $veff_u1) (local.get $rr2)))
                                    (local.set $veff_u2 (f32.add (local.get $veff_u2) (f32.neg (local.get $rr1))))
                                  )
                                )
                                (if (i32.eq (local.get $n) (i32.const 4))
                                  (then
                                    (local.set $veff_u0 (f32.add (local.get $veff_u0) (f32.neg (local.get $rr2))))
                                    (local.set $veff_u2 (f32.add (local.get $veff_u2) (local.get $rr0)))
                                  )
                                )
                                (if (i32.eq (local.get $n) (i32.const 5))
                                  (then
                                    (local.set $veff_u0 (f32.add (local.get $veff_u0) (local.get $rr1)))
                                    (local.set $veff_u1 (f32.add (local.get $veff_u1) (f32.neg (local.get $rr0))))
                                  )
                                )
                              )
                            )
                          )
                        )

                        (local.set $f_u0 (f32.sub (f32.mul (local.get $veff_u1) (local.get $g2)) (f32.mul (local.get $veff_u2) (local.get $g1))))
                        (local.set $f_u1 (f32.sub (f32.mul (local.get $veff_u2) (local.get $g0)) (f32.mul (local.get $veff_u0) (local.get $g2))))
                        (local.set $f_u2 (f32.sub (f32.mul (local.get $veff_u0) (local.get $g1)) (f32.mul (local.get $veff_u1) (local.get $g0))))

                        (local.set $tmp (call $load_f32_at (local.get $gam_u_ptr) (call $idx2 (local.get $i) (local.get $n) (local.get $nvor))))
                        (local.set $fg_u0 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f0)))
                                                   (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u0)))))
                        (local.set $fg_u1 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f1)))
                                                   (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u1)))))
                        (local.set $fg_u2 (f32.add (f32.mul (f32.const 2) (f32.mul (local.get $tmp) (local.get $f2)))
                                                   (f32.mul (f32.const 2) (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_GAM)) (local.get $i)) (local.get $f_u2)))))

                        (local.set $dcfx (f32.div (local.get $fg_u0) (local.get $sr)))
                        (local.set $dcfy (f32.div (local.get $fg_u1) (local.get $sr)))
                        (local.set $dcfz (f32.div (local.get $fg_u2) (local.get $sr)))

                        (local.set $idx2v (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                        (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                          (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))) (local.get $dcfx)))
                        (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                          (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))) (local.get $dcfy)))
                        (call $store_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                          (f32.add (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))) (local.get $dcfz)))

                        (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                          (f32.add (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3)))
                                   (f32.div (f32.sub (f32.mul (local.get $dcfz) (local.get $r1)) (f32.mul (local.get $dcfy) (local.get $r2))) (local.get $cr))))
                        (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                          (f32.add (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3)))
                                   (f32.div (f32.sub (f32.mul (local.get $dcfx) (local.get $r2)) (f32.mul (local.get $dcfz) (local.get $r0))) (local.get $cr))))
                        (call $store_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                          (f32.add (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3)))
                                   (f32.div (f32.sub (f32.mul (local.get $dcfy) (local.get $r0)) (f32.mul (local.get $dcfx) (local.get $r1))) (local.get $cr))))

                        (call $store_f32_at (local.get $cnc_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip))
                          (f32.add (call $load_f32_at (local.get $cnc_u_ptr) (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                                   (f32.mul (local.get $cr) (f32.add (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)) (local.get $dcfy))
                                                           (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)) (local.get $dcfz))))))

                        (local.set $n (i32.add (local.get $n) (i32.const 1)))
                        (br $loop_ltr_u)
                      )
                    )

                    (local.set $idx (i32.add (local.get $idx) (i32.const 1)))
                    (br $loop_leg)
                  )
                )
                (local.set $ii (i32.add (local.get $ii) (i32.const 1)))
                (br $loop_ii2)
              )
            )
          )
        )

        (local.set $j (i32.add (local.get $j) (i32.const 1)))
        (br $loop_j)
      )
    )

    ;; Surface totals
    (local.set $is (i32.const 0))
    (block $done_is
      (loop $loop_is
        (br_if $done_is (i32.ge_s (local.get $is) (local.get $nsurf)))

        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDSURF)) (local.get $is) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYSURF)) (local.get $is) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLSURF)) (local.get $is) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDVSURF)) (local.get $is) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDS_A)) (local.get $is) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYS_A)) (local.get $is) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLS_A)) (local.get $is) (f32.const 0))

        ;; Derivative surface totals (U) init
        (local.set $n (i32.const 0))
        (block $done_su_init
          (loop $loop_su_init
            (br_if $done_su_init (i32.ge_s (local.get $n) (local.get $numax)))
            (call $store_f32_at (local.get $cds_u_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (call $store_f32_at (local.get $cys_u_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (call $store_f32_at (local.get $cls_u_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (local.set $idx (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
            (call $store_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_su_init)
          )
        )

        ;; Derivative surface totals (D) init
        (local.set $n (i32.const 0))
        (block $done_sd_init
          (loop $loop_sd_init
            (br_if $done_sd_init (i32.ge_s (local.get $n) (local.get $ncontrol)))
            (call $store_f32_at (local.get $cds_d_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (call $store_f32_at (local.get $cys_d_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (call $store_f32_at (local.get $cls_d_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (local.set $idx (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
            (call $store_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_sd_init)
          )
        )

        ;; Derivative surface totals (G) init
        (local.set $n (i32.const 0))
        (block $done_sg_init
          (loop $loop_sg_init
            (br_if $done_sg_init (i32.ge_s (local.get $n) (local.get $ndesign)))
            (call $store_f32_at (local.get $cds_g_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (call $store_f32_at (local.get $cys_g_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (call $store_f32_at (local.get $cls_g_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)) (f32.const 0))
            (local.set $idx (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
            (call $store_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)) (f32.const 0))
            (call $store_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_sg_init)
          )
        )

        (local.set $en0 (f32.const 0))
        (local.set $en1 (f32.const 0))
        (local.set $en2 (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)) (f32.const 0))

        (local.set $nstrps (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_NJ)) (i32.mul (local.get $is) (i32.const 4)))))
        (local.set $jj (i32.const 0))
        (block $done_jj
          (loop $loop_jj
            (br_if $done_jj (i32.ge_s (local.get $jj) (local.get $nstrps)))
            (local.set $j (i32.add (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_JFRST)) (i32.mul (local.get $is) (i32.const 4)))) (local.get $jj)))

            (local.set $cr (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CHORD)) (local.get $j)))
            (local.set $sr (f32.mul (local.get $cr) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WSTRIP)) (local.get $j))))
            (local.set $sr_over_sref (f32.div (local.get $sr) (local.get $sref)))

            (local.set $rc40 (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 0) (local.get $j)))
                                      (f32.mul (f32.const 0.25) (local.get $cr))))
            (local.set $rc41 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 1) (local.get $j))))
            (local.set $rc42 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE)) (call $idx3 (i32.const 2) (local.get $j))))

            (local.set $en1 (f32.add (local.get $en1) (f32.mul (local.get $sr) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSY)) (local.get $j)))))
            (local.set $en2 (f32.add (local.get $en2) (f32.mul (local.get $sr) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_ENSZ)) (local.get $j)))))

            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDSURF)) (local.get $is)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDSURF)) (local.get $is))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDSTRP)) (local.get $j)) (local.get $sr_over_sref))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYSURF)) (local.get $is)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYSURF)) (local.get $is))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYSTRP)) (local.get $j)) (local.get $sr_over_sref))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLSURF)) (local.get $is)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLSURF)) (local.get $is))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLSTRP)) (local.get $j)) (local.get $sr_over_sref))))

            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3))) (local.get $sr_over_sref))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3))) (local.get $sr_over_sref))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3))) (local.get $sr_over_sref))))

            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3)))
                                (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3)))
                                (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $cref))))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3)))
                                (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))

            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDVSURF)) (local.get $is)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDVSURF)) (local.get $is))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDV_LSTRP)) (local.get $j)) (local.get $sr_over_sref))))

            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDS_A)) (local.get $is)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDS_A)) (local.get $is))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDST_A)) (local.get $j)) (local.get $sr_over_sref))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYS_A)) (local.get $is)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYS_A)) (local.get $is))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYST_A)) (local.get $j)) (local.get $sr_over_sref))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLS_A)) (local.get $is)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLS_A)) (local.get $is))
                       (f32.mul (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLST_A)) (local.get $j)) (local.get $sr_over_sref))))

            ;; U-derivative surface accumulation
            (local.set $n (i32.const 0))
            (block $done_su_acc
              (loop $loop_su_acc
                (br_if $done_su_acc (i32.ge_s (local.get $n) (local.get $numax)))
                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (local.set $idx2v (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
                (call $store_f32_at (local.get $cds_u_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cds_u_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $cdst_u_ptr) (local.get $idx)) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cys_u_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cys_u_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $cyst_u_ptr) (local.get $idx)) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cls_u_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cls_u_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $clst_u_ptr) (local.get $idx)) (local.get $sr_over_sref))))

                (call $store_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))

                (call $store_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))
                (call $store_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $cref))))))
                (call $store_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))

                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_su_acc)
              )
            )

            ;; D-derivative surface accumulation
            (local.set $n (i32.const 0))
            (block $done_sd_acc
              (loop $loop_sd_acc
                (br_if $done_sd_acc (i32.ge_s (local.get $n) (local.get $ncontrol)))
                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (local.set $idx2v (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
                (call $store_f32_at (local.get $cds_d_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cds_d_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $cdst_d_ptr) (local.get $idx)) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cys_d_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cys_d_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $cyst_d_ptr) (local.get $idx)) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cls_d_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cls_d_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $clst_d_ptr) (local.get $idx)) (local.get $sr_over_sref))))

                (call $store_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))

                (call $store_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))
                (call $store_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $cref))))))
                (call $store_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))

                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_sd_acc)
              )
            )

            ;; G-derivative surface accumulation
            (local.set $n (i32.const 0))
            (block $done_sg_acc
              (loop $loop_sg_acc
                (br_if $done_sg_acc (i32.ge_s (local.get $n) (local.get $ndesign)))
                (local.set $idx (call $idx2 (local.get $j) (local.get $n) (local.get $nstrip)))
                (local.set $idx2v (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
                (call $store_f32_at (local.get $cds_g_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cds_g_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $cdst_g_ptr) (local.get $idx)) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cys_g_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cys_g_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $cyst_g_ptr) (local.get $idx)) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cls_g_ptr) (local.get $idx2v)
                  (f32.add (call $load_f32_at (local.get $cls_g_ptr) (local.get $idx2v))
                           (f32.mul (call $load_f32_at (local.get $clst_g_ptr) (local.get $idx)) (local.get $sr_over_sref))))

                (call $store_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))
                (call $store_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cfst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3))) (local.get $sr_over_sref))))

                (call $store_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 0) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))
                (call $store_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 1) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $cref))))))
                (call $store_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 2) (local.get $idx2v) (i32.const 3)))
                           (f32.mul (call $load_f32_at (local.get $cmst_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))
                                    (f32.mul (local.get $sr_over_sref) (f32.div (local.get $cr) (local.get $bref))))))

                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_sg_acc)
              )
            )

            ;; CF_LSRF and CM_LSRF
            (local.set $imags (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_IMAGS)) (i32.mul (local.get $is) (i32.const 4)))))
            (local.set $j0 (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_JFRST)) (i32.mul (local.get $is) (i32.const 4)))))
            (if (i32.ge_s (local.get $imags) (i32.const 0))
              (then
                (local.set $r0 (f32.sub (local.get $rc40) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE1)) (call $idx3 (i32.const 0) (local.get $j0)))))
                (local.set $r1 (f32.sub (local.get $rc41) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE1)) (call $idx3 (i32.const 1) (local.get $j0)))))
                (local.set $r2 (f32.sub (local.get $rc42) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE1)) (call $idx3 (i32.const 2) (local.get $j0)))))
              )
              (else
                (local.set $r0 (f32.sub (local.get $rc40) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE2)) (call $idx3 (i32.const 0) (local.get $j0)))))
                (local.set $r1 (f32.sub (local.get $rc41) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE2)) (call $idx3 (i32.const 1) (local.get $j0)))))
                (local.set $r2 (f32.sub (local.get $rc42) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_RLE2)) (call $idx3 (i32.const 2) (local.get $j0)))))
              )
            )
            (local.set $ssurf (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_SSURF)) (local.get $is)))
            (local.set $cav (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CAVESURF)) (local.get $is)))

            (local.set $cf_l0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3))))
            (local.set $cf_l1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3))))
            (local.set $cf_l2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3))))
            (local.set $cm_l0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSTRP)) (call $idx2 (i32.const 0) (local.get $j) (i32.const 3))))
            (local.set $cm_l1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSTRP)) (call $idx2 (i32.const 1) (local.get $j) (i32.const 3))))
            (local.set $cm_l2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSTRP)) (call $idx2 (i32.const 2) (local.get $j) (i32.const 3))))

            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)))
                       (f32.mul (local.get $cf_l0) (f32.div (local.get $sr) (local.get $ssurf)))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)))
                       (f32.mul (local.get $cf_l1) (f32.div (local.get $sr) (local.get $ssurf)))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)))
                       (f32.mul (local.get $cf_l2) (f32.div (local.get $sr) (local.get $ssurf)))))

            (local.set $tmp (f32.mul (f32.div (local.get $sr) (local.get $ssurf)) (f32.div (local.get $cr) (local.get $cav))))
            (local.set $tmp2 (f32.div (local.get $tmp) (local.get $cr)))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)))
                       (f32.mul (local.get $tmp2) (f32.add (local.get $cm_l0) (f32.sub (f32.mul (local.get $cf_l1) (local.get $r2)) (f32.mul (local.get $cf_l2) (local.get $r1)))))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)))
                       (f32.mul (local.get $tmp2) (f32.add (local.get $cm_l1) (f32.sub (f32.mul (local.get $cf_l2) (local.get $r0)) (f32.mul (local.get $cf_l0) (local.get $r2)))))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3))
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CM_LSRF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)))
                       (f32.mul (local.get $tmp2) (f32.add (local.get $cm_l2) (f32.sub (f32.mul (local.get $cf_l0) (local.get $r1)) (f32.mul (local.get $cf_l1) (local.get $r0)))))))

            (local.set $jj (i32.add (local.get $jj) (i32.const 1)))
            (br $loop_jj)
          )
        )

        (local.set $en1 (f32.div (local.get $en1) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_SSURF)) (local.get $is))))
        (local.set $en2 (f32.div (local.get $en2) (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_SSURF)) (local.get $is))))
        (local.set $en0 (f32.const 0))
        (local.set $ul0 (f32.sub (f32.mul (local.get $ud1) (f32.neg (local.get $en1))) (f32.mul (local.get $ud2) (local.get $en2))))
        (local.set $ul1 (f32.sub (f32.mul (local.get $ud2) (local.get $en0)) (f32.mul (local.get $ud0) (f32.neg (local.get $en1)))))
        (local.set $ul2 (f32.sub (f32.mul (local.get $ud0) (local.get $en2)) (f32.mul (local.get $ud1) (local.get $en0))))
        (local.set $ulmag (call $sqrt_f32 (f32.add (f32.add (f32.mul (local.get $ul0) (local.get $ul0)) (f32.mul (local.get $ul1) (local.get $ul1))) (f32.mul (local.get $ul2) (local.get $ul2)))))
        (if (f32.eq (local.get $ulmag) (f32.const 0))
          (then (local.set $ul2 (f32.const 1)))
          (else
            (local.set $ul0 (f32.div (local.get $ul0) (local.get $ulmag)))
            (local.set $ul1 (f32.div (local.get $ul1) (local.get $ulmag)))
            (local.set $ul2 (f32.div (local.get $ul2) (local.get $ulmag)))
          )
        )
        (local.set $cf_l0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3))))
        (local.set $cf_l1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3))))
        (local.set $cf_l2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CF_LSRF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CL_LSRF)) (local.get $is)
          (f32.add (f32.add (f32.mul (local.get $ul0) (local.get $cf_l0)) (f32.mul (local.get $ul1) (local.get $cf_l1))) (f32.mul (local.get $ul2) (local.get $cf_l2))))
        (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CD_LSRF)) (local.get $is)
          (f32.add (f32.add (f32.mul (local.get $ud0) (local.get $cf_l0)) (f32.mul (local.get $ud1) (local.get $cf_l1))) (f32.mul (local.get $ud2) (local.get $cf_l2))))

        (if (i32.ne (i32.load (i32.add (call $field_ptr (local.get $state) (global.get $IDX_LFLOAD)) (i32.mul (local.get $is) (i32.const 4)))) (i32.const 0))
          (then
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)) (i32.const 0)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)) (i32.const 0))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)) (i32.const 1)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)) (i32.const 1))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)) (i32.const 2)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)) (i32.const 2))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CFSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)))))
            (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT))
              (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CDTOT))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDSURF)) (local.get $is))))
            (f32.store (call $field_addr (local.get $state) (global.get $IDX_CYTOT))
              (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CYTOT))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CYSURF)) (local.get $is))))
            (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLTOT))
              (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CLTOT))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLSURF)) (local.get $is))))
            (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDVTOT))
              (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CDVTOT))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDVSURF)) (local.get $is))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)) (i32.const 0)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)) (i32.const 0))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 0) (local.get $is) (i32.const 3)))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)) (i32.const 1)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)) (i32.const 1))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 1) (local.get $is) (i32.const 3)))))
            (call $store_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)) (i32.const 2)
              (f32.add (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)) (i32.const 2))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CMSURF)) (call $idx2 (i32.const 2) (local.get $is) (i32.const 3)))))
            (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT_A))
              (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CDTOT_A))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CDS_A)) (local.get $is))))
            (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLTOT_A))
              (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CLTOT_A))
                       (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_CLS_A)) (local.get $is))))

            ;; U-derivative totals
            (local.set $n (i32.const 0))
            (block $done_tot_u
              (loop $loop_tot_u
                (br_if $done_tot_u (i32.ge_s (local.get $n) (local.get $numax)))
                (call $store_f32_at (local.get $cdtot_u_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cdtot_u_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cds_u_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (call $store_f32_at (local.get $cytot_u_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cytot_u_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cys_u_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (call $store_f32_at (local.get $cltot_u_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cltot_u_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cls_u_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (local.set $idx (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
                (call $store_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_u_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))))
                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_tot_u)
              )
            )

            ;; D-derivative totals
            (local.set $n (i32.const 0))
            (block $done_tot_d
              (loop $loop_tot_d
                (br_if $done_tot_d (i32.ge_s (local.get $n) (local.get $ncontrol)))
                (call $store_f32_at (local.get $cdtot_d_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cdtot_d_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cds_d_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (call $store_f32_at (local.get $cytot_d_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cytot_d_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cys_d_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (call $store_f32_at (local.get $cltot_d_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cltot_d_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cls_d_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (local.set $idx (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
                (call $store_f32_at (local.get $cftot_d_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_d_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cftot_d_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_d_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cftot_d_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_d_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_d_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_d_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_d_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_d_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_d_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_d_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_d_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))))
                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_tot_d)
              )
            )

            ;; G-derivative totals
            (local.set $n (i32.const 0))
            (block $done_tot_g
              (loop $loop_tot_g
                (br_if $done_tot_g (i32.ge_s (local.get $n) (local.get $ndesign)))
                (call $store_f32_at (local.get $cdtot_g_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cdtot_g_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cds_g_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (call $store_f32_at (local.get $cytot_g_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cytot_g_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cys_g_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (call $store_f32_at (local.get $cltot_g_ptr) (local.get $n)
                  (f32.add (call $load_f32_at (local.get $cltot_g_ptr) (local.get $n))
                           (call $load_f32_at (local.get $cls_g_ptr) (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))))
                (local.set $idx (call $idx2 (local.get $is) (local.get $n) (local.get $nsurf)))
                (call $store_f32_at (local.get $cftot_g_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_g_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cftot_g_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_g_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cftot_g_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_g_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cfs_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_g_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_g_ptr) (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 0) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_g_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_g_ptr) (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 1) (local.get $idx) (i32.const 3)))))
                (call $store_f32_at (local.get $cmtot_g_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_g_ptr) (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)))
                           (call $load_f32_at (local.get $cms_g_ptr) (call $idx2 (i32.const 2) (local.get $idx) (i32.const 3)))))
                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $loop_tot_g)
              )
            )
          )
        )

        (local.set $is (i32.add (local.get $is) (i32.const 1)))
        (br $loop_is)
      )
    )
  )
  (func $PGMAT (export "PGMAT")
    (param $mach f32) (param $alfa f32) (param $beta f32)
    (param $p i32) (param $p_m i32) (param $p_a i32) (param $p_b i32)
    (local $binv f32) (local $bi_m f32)
    (local $sina f32) (local $cosa f32) (local $sinb f32) (local $cosb f32)

    (local.set $binv
      (f32.div (f32.const 1)
        (f32.sqrt (f32.sub (f32.const 1) (f32.mul (local.get $mach) (local.get $mach))))))
    (local.set $bi_m (f32.mul (local.get $mach) (f32.mul (local.get $binv) (f32.mul (local.get $binv) (local.get $binv)))))

    (local.set $sina (call $sin_f32 (local.get $alfa)))
    (local.set $cosa (call $cos_f32 (local.get $alfa)))
    (local.set $sinb (call $sin_f32 (local.get $beta)))
    (local.set $cosb (call $cos_f32 (local.get $beta)))

    (f32.store (local.get $p) (f32.mul (f32.mul (local.get $cosa) (local.get $cosb)) (local.get $binv)))
    (f32.store (i32.add (local.get $p) (i32.const 4)) (f32.mul (f32.neg (local.get $sinb)) (local.get $binv)))
    (f32.store (i32.add (local.get $p) (i32.const 8)) (f32.mul (f32.mul (local.get $sina) (local.get $cosb)) (local.get $binv)))

    (f32.store (i32.add (local.get $p) (i32.const 12)) (f32.mul (local.get $cosa) (local.get $sinb)))
    (f32.store (i32.add (local.get $p) (i32.const 16)) (local.get $cosb))
    (f32.store (i32.add (local.get $p) (i32.const 20)) (f32.mul (local.get $sina) (local.get $sinb)))

    (f32.store (i32.add (local.get $p) (i32.const 24)) (f32.neg (local.get $sina)))
    (f32.store (i32.add (local.get $p) (i32.const 28)) (f32.const 0))
    (f32.store (i32.add (local.get $p) (i32.const 32)) (local.get $cosa))

    (f32.store (local.get $p_m) (f32.mul (f32.mul (local.get $cosa) (local.get $cosb)) (local.get $bi_m)))
    (f32.store (i32.add (local.get $p_m) (i32.const 4)) (f32.mul (f32.neg (local.get $sinb)) (local.get $bi_m)))
    (f32.store (i32.add (local.get $p_m) (i32.const 8)) (f32.mul (f32.mul (local.get $sina) (local.get $cosb)) (local.get $bi_m)))

    (f32.store (i32.add (local.get $p_m) (i32.const 12)) (f32.const 0))
    (f32.store (i32.add (local.get $p_m) (i32.const 16)) (f32.const 0))
    (f32.store (i32.add (local.get $p_m) (i32.const 20)) (f32.const 0))

    (f32.store (i32.add (local.get $p_m) (i32.const 24)) (f32.const 0))
    (f32.store (i32.add (local.get $p_m) (i32.const 28)) (f32.const 0))
    (f32.store (i32.add (local.get $p_m) (i32.const 32)) (f32.const 0))

    (f32.store (local.get $p_a) (f32.mul (f32.neg (local.get $sina)) (f32.mul (local.get $cosb) (local.get $binv))))
    (f32.store (i32.add (local.get $p_a) (i32.const 4)) (f32.const 0))
    (f32.store (i32.add (local.get $p_a) (i32.const 8)) (f32.mul (f32.mul (local.get $cosa) (local.get $cosb)) (local.get $binv)))

    (f32.store (i32.add (local.get $p_a) (i32.const 12)) (f32.mul (f32.neg (local.get $sina)) (local.get $sinb)))
    (f32.store (i32.add (local.get $p_a) (i32.const 16)) (f32.const 0))
    (f32.store (i32.add (local.get $p_a) (i32.const 20)) (f32.mul (local.get $cosa) (local.get $sinb)))

    (f32.store (i32.add (local.get $p_a) (i32.const 24)) (f32.neg (local.get $cosa)))
    (f32.store (i32.add (local.get $p_a) (i32.const 28)) (f32.const 0))
    (f32.store (i32.add (local.get $p_a) (i32.const 32)) (f32.neg (local.get $sina)))

    (f32.store (local.get $p_b) (f32.mul (f32.neg (local.get $cosa)) (f32.mul (local.get $sinb) (local.get $binv))))
    (f32.store (i32.add (local.get $p_b) (i32.const 4)) (f32.mul (f32.neg (local.get $cosb)) (local.get $binv)))
    (f32.store (i32.add (local.get $p_b) (i32.const 8)) (f32.mul (f32.neg (local.get $sina)) (f32.mul (local.get $sinb) (local.get $binv))))

    (f32.store (i32.add (local.get $p_b) (i32.const 12)) (f32.mul (local.get $cosa) (local.get $cosb)))
    (f32.store (i32.add (local.get $p_b) (i32.const 16)) (f32.neg (local.get $sinb)))
    (f32.store (i32.add (local.get $p_b) (i32.const 20)) (f32.mul (local.get $sina) (local.get $cosb)))

    (f32.store (i32.add (local.get $p_b) (i32.const 24)) (f32.const 0))
    (f32.store (i32.add (local.get $p_b) (i32.const 28)) (f32.const 0))
    (f32.store (i32.add (local.get $p_b) (i32.const 32)) (f32.const 0))
  )

  (func $TPFORC_CORE
    (param $pi f32) (param $amach f32) (param $ysym f32) (param $zsym f32)
    (param $iysym i32) (param $izsym i32)
    (param $vrcorec f32) (param $vrcorew f32)
    (param $nstrip i32) (param $numax i32) (param $sref f32) (param $bref f32)
    (param $ijfrst i32) (param $nvstrp i32)
    (param $gam i32) (param $gam_u i32)
    (param $rv1 i32) (param $rv2 i32) (param $rc i32)
    (param $chord i32) (param $lssurf i32) (param $lncomp i32) (param $lfload i32)
    (param $gams i32) (param $gams_u i32)
    (param $rt1 i32) (param $rt2 i32) (param $rtc i32)
    (param $vy_u i32) (param $vz_u i32)
    (param $dwwake i32) (param $clff_u i32) (param $cyff_u i32) (param $cdff_u i32) (param $spanef_u i32)
    (param $out i32)
    (local $hpi f32)
    (local $jc i32) (local $jv i32) (local $i i32) (local $k i32) (local $n i32)
    (local $i1 i32) (local $nvc i32) (local $ic i32) (local $idx i32)
    (local $p0 f32) (local $p1 f32) (local $p2 f32)
    (local $gval f32)
    (local $dxt f32) (local $dyt f32) (local $dzt f32) (local $dst f32)
    (local $ny f32) (local $nz f32) (local $ycntr f32) (local $zcntr f32)
    (local $vy f32) (local $vz f32)
    (local $vyu f32) (local $vzu f32)
    (local $dsy f32) (local $dsz f32) (local $dsyz f32)
    (local $rcore f32)
    (local $dy1 f32) (local $dy2 f32) (local $dz1 f32) (local $dz2 f32)
    (local $rsq1 f32) (local $rsq2 f32)
    (local $clff f32) (local $cyff f32) (local $cdff f32)
    (local $spanef f32) (local $spanef_cl f32) (local $spanef_cy f32) (local $spanef_cd f32)
    (local $ar f32)
    (local $dyz f32)
    (local $tmp f32) (local $tmp2 f32) (local $tmp3 f32)

    (local.set $hpi (f32.div (f32.const 1) (f32.mul (f32.const 2) (local.get $pi))))

    (call $PGMAT (local.get $amach) (f32.const 0) (f32.const 0)
      (i32.const 0) (i32.const 64) (i32.const 128) (i32.const 192))

    (local.set $clff (f32.const 0))
    (local.set $cyff (f32.const 0))
    (local.set $cdff (f32.const 0))

    (local.set $n (i32.const 0))
    (block $nu_clear
      (loop $nu_loop
        (br_if $nu_clear (i32.ge_u (local.get $n) (local.get $numax)))
        (f32.store (i32.add (local.get $clff_u) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cyff_u) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cdff_u) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $spanef_u) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (local.set $n (i32.add (local.get $n) (i32.const 1)))
        (br $nu_loop)
      )
    )

    (local.set $jc (i32.const 0))
    (block $gams_end
      (loop $gams_loop
        (br_if $gams_end (i32.ge_u (local.get $jc) (local.get $nstrip)))
        (f32.store (i32.add (local.get $gams) (i32.mul (local.get $jc) (i32.const 4))) (f32.const 0))
        (local.set $n (i32.const 0))
        (block $gamu_end
          (loop $gamu_loop
            (br_if $gamu_end (i32.ge_u (local.get $n) (local.get $numax)))
            (f32.store (i32.add (local.get $gams_u)
              (i32.mul (call $idx2r (local.get $jc) (local.get $n) (local.get $numax)) (i32.const 4))) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $gamu_loop)
          )
        )
        (local.set $i1 (i32.load (i32.add (local.get $ijfrst) (i32.mul (local.get $jc) (i32.const 4)))))
        (local.set $nvc (i32.load (i32.add (local.get $nvstrp) (i32.mul (local.get $jc) (i32.const 4)))))
        (local.set $i (i32.const 0))
        (block $sum_end
          (loop $sum_loop
            (br_if $sum_end (i32.ge_u (local.get $i) (local.get $nvc)))
            (local.set $idx (i32.add (local.get $i1) (local.get $i)))
            (f32.store (i32.add (local.get $gams) (i32.mul (local.get $jc) (i32.const 4)))
              (f32.add (f32.load (i32.add (local.get $gams) (i32.mul (local.get $jc) (i32.const 4))))
                       (f32.load (i32.add (local.get $gam) (i32.mul (local.get $idx) (i32.const 4))))))
            (local.set $n (i32.const 0))
            (block $sumu_end
              (loop $sumu_loop
                (br_if $sumu_end (i32.ge_u (local.get $n) (local.get $numax)))
                (local.set $gval (f32.load (i32.add (local.get $gam_u)
                  (i32.mul (call $idx2r (local.get $idx) (local.get $n) (local.get $numax)) (i32.const 4)))))
                (f32.store (i32.add (local.get $gams_u)
                  (i32.mul (call $idx2r (local.get $jc) (local.get $n) (local.get $numax)) (i32.const 4)))
                  (f32.add (f32.load (i32.add (local.get $gams_u)
                    (i32.mul (call $idx2r (local.get $jc) (local.get $n) (local.get $numax)) (i32.const 4))))
                    (local.get $gval)))
                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $sumu_loop)
              )
            )
            (local.set $i (i32.add (local.get $i) (i32.const 1)))
            (br $sum_loop)
          )
        )
        (local.set $jc (i32.add (local.get $jc) (i32.const 1)))
        (br $gams_loop)
      )
    )

    (local.set $jc (i32.const 0))
    (block $rt_end
      (loop $rt_loop
        (br_if $rt_end (i32.ge_u (local.get $jc) (local.get $nstrip)))
        (local.set $ic (i32.sub
          (i32.add (i32.load (i32.add (local.get $ijfrst) (i32.mul (local.get $jc) (i32.const 4))))
                   (i32.load (i32.add (local.get $nvstrp) (i32.mul (local.get $jc) (i32.const 4)))))
          (i32.const 1)))
        (local.set $k (i32.const 0))
        (block $k_end
          (loop $k_loop
            (br_if $k_end (i32.ge_u (local.get $k) (i32.const 3)))
            (local.set $p0 (f32.load (i32.add (i32.const 0) (i32.mul (call $idx3 (local.get $k) (i32.const 0)) (i32.const 4)))))
            (local.set $p1 (f32.load (i32.add (i32.const 0) (i32.mul (call $idx3 (local.get $k) (i32.const 1)) (i32.const 4)))))
            (local.set $p2 (f32.load (i32.add (i32.const 0) (i32.mul (call $idx3 (local.get $k) (i32.const 2)) (i32.const 4)))))

            (f32.store (i32.add (local.get $rt1) (i32.mul (call $idx3 (local.get $k) (local.get $jc)) (i32.const 4)))
              (f32.add (f32.add
                (f32.mul (local.get $p0) (f32.load (i32.add (local.get $rv1) (i32.mul (call $idx3 (i32.const 0) (local.get $ic)) (i32.const 4)))))
                (f32.mul (local.get $p1) (f32.load (i32.add (local.get $rv1) (i32.mul (call $idx3 (i32.const 1) (local.get $ic)) (i32.const 4))))))
                (f32.mul (local.get $p2) (f32.load (i32.add (local.get $rv1) (i32.mul (call $idx3 (i32.const 2) (local.get $ic)) (i32.const 4)))))))

            (f32.store (i32.add (local.get $rt2) (i32.mul (call $idx3 (local.get $k) (local.get $jc)) (i32.const 4)))
              (f32.add (f32.add
                (f32.mul (local.get $p0) (f32.load (i32.add (local.get $rv2) (i32.mul (call $idx3 (i32.const 0) (local.get $ic)) (i32.const 4)))))
                (f32.mul (local.get $p1) (f32.load (i32.add (local.get $rv2) (i32.mul (call $idx3 (i32.const 1) (local.get $ic)) (i32.const 4))))))
                (f32.mul (local.get $p2) (f32.load (i32.add (local.get $rv2) (i32.mul (call $idx3 (i32.const 2) (local.get $ic)) (i32.const 4)))))))

            (f32.store (i32.add (local.get $rtc) (i32.mul (call $idx3 (local.get $k) (local.get $jc)) (i32.const 4)))
              (f32.add (f32.add
                (f32.mul (local.get $p0) (f32.load (i32.add (local.get $rc) (i32.mul (call $idx3 (i32.const 0) (local.get $ic)) (i32.const 4)))))
                (f32.mul (local.get $p1) (f32.load (i32.add (local.get $rc) (i32.mul (call $idx3 (i32.const 1) (local.get $ic)) (i32.const 4))))))
                (f32.mul (local.get $p2) (f32.load (i32.add (local.get $rc) (i32.mul (call $idx3 (i32.const 2) (local.get $ic)) (i32.const 4)))))))

            (local.set $k (i32.add (local.get $k) (i32.const 1)))
            (br $k_loop)
          )
        )
        (local.set $jc (i32.add (local.get $jc) (i32.const 1)))
        (br $rt_loop)
      )
    )

    (local.set $jc (i32.const 0))
    (block $main_end
      (loop $main_loop
        (br_if $main_end (i32.ge_u (local.get $jc) (local.get $nstrip)))

        (local.set $dxt (f32.sub (f32.load (i32.add (local.get $rt2) (i32.mul (call $idx3 (i32.const 0) (local.get $jc)) (i32.const 4))))
                                (f32.load (i32.add (local.get $rt1) (i32.mul (call $idx3 (i32.const 0) (local.get $jc)) (i32.const 4))))))
        (local.set $dyt (f32.sub (f32.load (i32.add (local.get $rt2) (i32.mul (call $idx3 (i32.const 1) (local.get $jc)) (i32.const 4))))
                                (f32.load (i32.add (local.get $rt1) (i32.mul (call $idx3 (i32.const 1) (local.get $jc)) (i32.const 4))))))
        (local.set $dzt (f32.sub (f32.load (i32.add (local.get $rt2) (i32.mul (call $idx3 (i32.const 2) (local.get $jc)) (i32.const 4))))
                                (f32.load (i32.add (local.get $rt1) (i32.mul (call $idx3 (i32.const 2) (local.get $jc)) (i32.const 4))))))
        (local.set $dst (f32.sqrt (f32.add (f32.mul (local.get $dyt) (local.get $dyt))
                                           (f32.mul (local.get $dzt) (local.get $dzt)))))
        (local.set $ny (f32.div (f32.neg (local.get $dzt)) (local.get $dst)))
        (local.set $nz (f32.div (local.get $dyt) (local.get $dst)))
        (local.set $ycntr (f32.load (i32.add (local.get $rtc) (i32.mul (call $idx3 (i32.const 1) (local.get $jc)) (i32.const 4)))))
        (local.set $zcntr (f32.load (i32.add (local.get $rtc) (i32.mul (call $idx3 (i32.const 2) (local.get $jc)) (i32.const 4)))))

        (local.set $vy (f32.const 0))
        (local.set $vz (f32.const 0))

        (local.set $n (i32.const 0))
        (block $vyu_clear
          (loop $vyu_loop
            (br_if $vyu_clear (i32.ge_u (local.get $n) (local.get $numax)))
            (f32.store (i32.add (local.get $vy_u) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $vz_u) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $vyu_loop)
          )
        )

        (local.set $jv (i32.const 0))
        (block $jv_end
          (loop $jv_loop
            (br_if $jv_end (i32.ge_u (local.get $jv) (local.get $nstrip)))

            (local.set $dsy (f32.sub (f32.load (i32.add (local.get $rt2) (i32.mul (call $idx3 (i32.const 1) (local.get $jv)) (i32.const 4))))
                                     (f32.load (i32.add (local.get $rt1) (i32.mul (call $idx3 (i32.const 1) (local.get $jv)) (i32.const 4))))))
            (local.set $dsz (f32.sub (f32.load (i32.add (local.get $rt2) (i32.mul (call $idx3 (i32.const 2) (local.get $jv)) (i32.const 4))))
                                     (f32.load (i32.add (local.get $rt1) (i32.mul (call $idx3 (i32.const 2) (local.get $jv)) (i32.const 4))))))
            (local.set $dsyz (f32.sqrt (f32.add (f32.mul (local.get $dsy) (local.get $dsy))
                                               (f32.mul (local.get $dsz) (local.get $dsz)))))

            (local.set $rcore (f32.const 0))
            (if (i32.ne
              (i32.load (i32.add (local.get $lncomp) (i32.mul (i32.load (i32.add (local.get $lssurf) (i32.mul (local.get $jc) (i32.const 4)))) (i32.const 4))))
              (i32.load (i32.add (local.get $lncomp) (i32.mul (i32.load (i32.add (local.get $lssurf) (i32.mul (local.get $jv) (i32.const 4)))) (i32.const 4))))
            )
              (then
                (local.set $rcore
                  (f32.max
                    (f32.mul (local.get $vrcorec) (f32.load (i32.add (local.get $chord) (i32.mul (local.get $jv) (i32.const 4)))))
                    (f32.mul (local.get $vrcorew) (local.get $dsyz))
                  )
                )
              )
            )

            (local.set $dy1 (f32.sub (local.get $ycntr) (f32.load (i32.add (local.get $rt1) (i32.mul (call $idx3 (i32.const 1) (local.get $jv)) (i32.const 4))))))
            (local.set $dy2 (f32.sub (local.get $ycntr) (f32.load (i32.add (local.get $rt2) (i32.mul (call $idx3 (i32.const 1) (local.get $jv)) (i32.const 4))))))
            (local.set $dz1 (f32.sub (local.get $zcntr) (f32.load (i32.add (local.get $rt1) (i32.mul (call $idx3 (i32.const 2) (local.get $jv)) (i32.const 4))))))
            (local.set $dz2 (f32.sub (local.get $zcntr) (f32.load (i32.add (local.get $rt2) (i32.mul (call $idx3 (i32.const 2) (local.get $jv)) (i32.const 4))))))

            (local.set $dyz (f32.add (f32.mul (local.get $dy1) (local.get $dy1)) (f32.mul (local.get $dz1) (local.get $dz1))))
            (local.set $rsq1 (f32.sqrt (f32.add (f32.mul (local.get $dyz) (local.get $dyz))
                                               (f32.mul (f32.mul (local.get $rcore) (local.get $rcore))
                                                        (f32.mul (local.get $rcore) (local.get $rcore))))))
            (local.set $dyz (f32.add (f32.mul (local.get $dy2) (local.get $dy2)) (f32.mul (local.get $dz2) (local.get $dz2))))
            (local.set $rsq2 (f32.sqrt (f32.add (f32.mul (local.get $dyz) (local.get $dyz))
                                               (f32.mul (f32.mul (local.get $rcore) (local.get $rcore))
                                                        (f32.mul (local.get $rcore) (local.get $rcore))))))

            (local.set $vy
              (f32.add (local.get $vy)
                (f32.mul (local.get $hpi)
                  (f32.mul (f32.load (i32.add (local.get $gams) (i32.mul (local.get $jv) (i32.const 4))))
                    (f32.sub (f32.div (local.get $dz1) (local.get $rsq1))
                             (f32.div (local.get $dz2) (local.get $rsq2)))))))
            (local.set $vz
              (f32.add (local.get $vz)
                (f32.mul (local.get $hpi)
                  (f32.mul (f32.load (i32.add (local.get $gams) (i32.mul (local.get $jv) (i32.const 4))))
                    (f32.add (f32.neg (f32.div (local.get $dy1) (local.get $rsq1)))
                             (f32.div (local.get $dy2) (local.get $rsq2)))))))

            (local.set $n (i32.const 0))
            (block $vynu_end
              (loop $vynu_loop
                (br_if $vynu_end (i32.ge_u (local.get $n) (local.get $numax)))
                (local.set $vyu (f32.load (i32.add (local.get $vy_u) (i32.mul (local.get $n) (i32.const 4)))))
                (local.set $vzu (f32.load (i32.add (local.get $vz_u) (i32.mul (local.get $n) (i32.const 4)))))
                (local.set $vyu
                  (f32.add (local.get $vyu)
                    (f32.mul (local.get $hpi)
                      (f32.mul (f32.load (i32.add (local.get $gams_u)
                        (i32.mul (call $idx2r (local.get $jv) (local.get $n) (local.get $numax)) (i32.const 4))))
                        (f32.sub (f32.div (local.get $dz1) (local.get $rsq1))
                                 (f32.div (local.get $dz2) (local.get $rsq2)))))))
                (local.set $vzu
                  (f32.add (local.get $vzu)
                    (f32.mul (local.get $hpi)
                      (f32.mul (f32.load (i32.add (local.get $gams_u)
                        (i32.mul (call $idx2r (local.get $jv) (local.get $n) (local.get $numax)) (i32.const 4))))
                        (f32.add (f32.neg (f32.div (local.get $dy1) (local.get $rsq1)))
                                 (f32.div (local.get $dy2) (local.get $rsq2)))))))
                (f32.store (i32.add (local.get $vy_u) (i32.mul (local.get $n) (i32.const 4))) (local.get $vyu))
                (f32.store (i32.add (local.get $vz_u) (i32.mul (local.get $n) (i32.const 4))) (local.get $vzu))
                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $vynu_loop)
              )
            )

            (local.set $jv (i32.add (local.get $jv) (i32.const 1)))
            (br $jv_loop)
          )
        )

        (f32.store (i32.add (local.get $dwwake) (i32.mul (local.get $jc) (i32.const 4)))
          (f32.neg (f32.add (f32.mul (local.get $ny) (local.get $vy)) (f32.mul (local.get $nz) (local.get $vz)))))

        (if (i32.load (i32.add (local.get $lfload)
              (i32.mul (i32.load (i32.add (local.get $lssurf) (i32.mul (local.get $jc) (i32.const 4)))) (i32.const 4))))
          (then
            (local.set $clff (f32.add (local.get $clff)
              (f32.mul (f32.const 2)
                (f32.mul (f32.load (i32.add (local.get $gams) (i32.mul (local.get $jc) (i32.const 4))))
                  (f32.div (local.get $dyt) (local.get $sref))))))
            (local.set $cyff (f32.sub (local.get $cyff)
              (f32.mul (f32.const 2)
                (f32.mul (f32.load (i32.add (local.get $gams) (i32.mul (local.get $jc) (i32.const 4))))
                  (f32.div (local.get $dzt) (local.get $sref))))))
            (local.set $cdff (f32.add (local.get $cdff)
              (f32.mul
                (f32.load (i32.add (local.get $gams) (i32.mul (local.get $jc) (i32.const 4))))
                (f32.div (f32.sub (f32.mul (local.get $dzt) (local.get $vy))
                                 (f32.mul (local.get $dyt) (local.get $vz)))
                         (local.get $sref)))))

            (local.set $n (i32.const 0))
            (block $clu_end
              (loop $clu_loop
                (br_if $clu_end (i32.ge_u (local.get $n) (local.get $numax)))

                (local.set $tmp (f32.load (i32.add (local.get $gams_u)
                  (i32.mul (call $idx2r (local.get $jc) (local.get $n) (local.get $numax)) (i32.const 4)))))

                (local.set $tmp2
                  (f32.add
                    (f32.load (i32.add (local.get $clff_u) (i32.mul (local.get $n) (i32.const 4))))
                    (f32.mul (f32.const 2)
                      (f32.mul (local.get $tmp)
                        (f32.div (local.get $dyt) (local.get $sref)))))
                )
                (f32.store (i32.add (local.get $clff_u) (i32.mul (local.get $n) (i32.const 4))) (local.get $tmp2))

                (local.set $tmp2
                  (f32.sub
                    (f32.load (i32.add (local.get $cyff_u) (i32.mul (local.get $n) (i32.const 4))))
                    (f32.mul (f32.const 2)
                      (f32.mul (local.get $tmp)
                        (f32.div (local.get $dzt) (local.get $sref)))))
                )
                (f32.store (i32.add (local.get $cyff_u) (i32.mul (local.get $n) (i32.const 4))) (local.get $tmp2))

                (local.set $tmp2 (f32.sub (f32.mul (local.get $dzt) (local.get $vy))
                                          (f32.mul (local.get $dyt) (local.get $vz))))
                (local.set $tmp3 (f32.sub
                  (f32.mul (local.get $dzt) (f32.load (i32.add (local.get $vy_u) (i32.mul (local.get $n) (i32.const 4)))))
                  (f32.mul (local.get $dyt) (f32.load (i32.add (local.get $vz_u) (i32.mul (local.get $n) (i32.const 4)))))))
                (local.set $tmp2 (f32.add
                  (f32.mul (local.get $tmp) (local.get $tmp2))
                  (f32.mul (f32.load (i32.add (local.get $gams) (i32.mul (local.get $jc) (i32.const 4)))) (local.get $tmp3))))
                (local.set $tmp2 (f32.div (local.get $tmp2) (local.get $sref)))
                (local.set $tmp3 (f32.load (i32.add (local.get $cdff_u) (i32.mul (local.get $n) (i32.const 4)))))
                (f32.store (i32.add (local.get $cdff_u) (i32.mul (local.get $n) (i32.const 4)))
                  (f32.add (local.get $tmp3) (local.get $tmp2)))

                (local.set $n (i32.add (local.get $n) (i32.const 1)))
                (br $clu_loop)
              )
            )
          )
        )

        (local.set $jc (i32.add (local.get $jc) (i32.const 1)))
        (br $main_loop)
      )
    )

    (local.set $ar (f32.div (f32.mul (local.get $bref) (local.get $bref)) (local.get $sref)))
    (if (f32.eq (local.get $cdff) (f32.const 0))
      (then
        (local.set $spanef (f32.const 0))
      )
      (else
        (local.set $spanef
          (f32.div
            (f32.add (f32.mul (local.get $clff) (local.get $clff))
                     (f32.mul (local.get $cyff) (local.get $cyff)))
            (f32.mul (local.get $pi) (f32.mul (local.get $ar) (local.get $cdff)))))
        (local.set $spanef_cl (f32.div (f32.mul (f32.const 2) (local.get $clff))
                                       (f32.mul (local.get $pi) (f32.mul (local.get $ar) (local.get $cdff)))))
        (local.set $spanef_cy (f32.div (f32.mul (f32.const 2) (local.get $cyff))
                                       (f32.mul (local.get $pi) (f32.mul (local.get $ar) (local.get $cdff)))))
        (local.set $spanef_cd (f32.neg (f32.div (local.get $spanef) (local.get $cdff))))
        (local.set $n (i32.const 0))
        (block $spanu_end
          (loop $spanu_loop
            (br_if $spanu_end (i32.ge_u (local.get $n) (local.get $numax)))
            (f32.store (i32.add (local.get $spanef_u) (i32.mul (local.get $n) (i32.const 4)))
              (f32.add
                (f32.add
                  (f32.mul (local.get $spanef_cl) (f32.load (i32.add (local.get $clff_u) (i32.mul (local.get $n) (i32.const 4)))))
                  (f32.mul (local.get $spanef_cy) (f32.load (i32.add (local.get $cyff_u) (i32.mul (local.get $n) (i32.const 4)))))
                )
                (f32.mul (local.get $spanef_cd) (f32.load (i32.add (local.get $cdff_u) (i32.mul (local.get $n) (i32.const 4)))))
              )
            )
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $spanu_loop)
          )
        )
      )
    )

    (f32.store (local.get $out) (local.get $clff))
    (f32.store (i32.add (local.get $out) (i32.const 4)) (local.get $cyff))
    (f32.store (i32.add (local.get $out) (i32.const 8)) (local.get $cdff))
    (f32.store (i32.add (local.get $out) (i32.const 12)) (local.get $spanef))
  )

(func $TPFORC_WAT (param $state i32)
    (local $nstrip i32) (local $numax i32)
    (local $ijfrst_ptr i32) (local $nvstrp_ptr i32)
    (local $gam_ptr i32) (local $gam_u_ptr i32)
    (local $rv1_ptr i32) (local $rv2_ptr i32) (local $rc_ptr i32)
    (local $chord_ptr i32) (local $lssurf_ptr i32) (local $lncomp_ptr i32) (local $lfload_ptr i32)
    (local $scratch i32)
    (local $gams_ptr i32) (local $gams_u_ptr i32)
    (local $rt1_ptr i32) (local $rt2_ptr i32) (local $rtc_ptr i32)
    (local $vy_u_ptr i32) (local $vz_u_ptr i32)
    (local $dwwake_ptr i32)
    (local $clff_u_ptr i32) (local $cyff_u_ptr i32) (local $cdff_u_ptr i32) (local $spanef_u_ptr i32)
    (local $out_ptr i32)

    (local.set $nstrip (call $load_i32 (local.get $state) (global.get $IDX_NSTRIP)))
    (local.set $numax (call $load_i32 (local.get $state) (global.get $IDX_NUMAX)))

    (local.set $ijfrst_ptr (call $field_ptr (local.get $state) (global.get $IDX_IJFRST)))
    (local.set $nvstrp_ptr (call $field_ptr (local.get $state) (global.get $IDX_NVSTRP)))
    (local.set $gam_ptr (call $field_ptr (local.get $state) (global.get $IDX_GAM)))
    (local.set $gam_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_GAM_U)))
    (local.set $rv1_ptr (call $field_ptr (local.get $state) (global.get $IDX_RV1)))
    (local.set $rv2_ptr (call $field_ptr (local.get $state) (global.get $IDX_RV2)))
    (local.set $rc_ptr (call $field_ptr (local.get $state) (global.get $IDX_RC)))
    (local.set $chord_ptr (call $field_ptr (local.get $state) (global.get $IDX_CHORD)))
    (local.set $lssurf_ptr (call $field_ptr (local.get $state) (global.get $IDX_LSSURF)))
    (local.set $lncomp_ptr (call $field_ptr (local.get $state) (global.get $IDX_LNCOMP)))
    (local.set $lfload_ptr (call $field_ptr (local.get $state) (global.get $IDX_LFLOAD)))

    (local.set $scratch (i32.const 256))
    (local.set $gams_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $nstrip) (i32.const 4))))
    (local.set $gams_u_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (i32.mul (local.get $nstrip) (local.get $numax)) (i32.const 4))))
    (local.set $rt1_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (i32.mul (local.get $nstrip) (i32.const 3)) (i32.const 4))))
    (local.set $rt2_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (i32.mul (local.get $nstrip) (i32.const 3)) (i32.const 4))))
    (local.set $rtc_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (i32.mul (local.get $nstrip) (i32.const 3)) (i32.const 4))))
    (local.set $vy_u_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $numax) (i32.const 4))))
    (local.set $vz_u_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $numax) (i32.const 4))))
    (local.set $dwwake_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $nstrip) (i32.const 4))))
    (local.set $clff_u_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $numax) (i32.const 4))))
    (local.set $cyff_u_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $numax) (i32.const 4))))
    (local.set $cdff_u_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $numax) (i32.const 4))))
    (local.set $spanef_u_ptr (local.get $scratch))
    (local.set $scratch (i32.add (local.get $scratch) (i32.mul (local.get $numax) (i32.const 4))))
    (local.set $out_ptr (local.get $scratch))

    (call $TPFORC_CORE
      (call $load_f32 (local.get $state) (global.get $IDX_PI))
      (call $load_f32 (local.get $state) (global.get $IDX_AMACH))
      (call $load_f32 (local.get $state) (global.get $IDX_YSYM))
      (call $load_f32 (local.get $state) (global.get $IDX_ZSYM))
      (call $load_i32 (local.get $state) (global.get $IDX_IYSYM))
      (call $load_i32 (local.get $state) (global.get $IDX_IZSYM))
      (call $load_f32 (local.get $state) (global.get $IDX_VRCOREC))
      (call $load_f32 (local.get $state) (global.get $IDX_VRCOREW))
      (local.get $nstrip)
      (local.get $numax)
      (call $load_f32 (local.get $state) (global.get $IDX_SREF))
      (call $load_f32 (local.get $state) (global.get $IDX_BREF))
      (local.get $ijfrst_ptr)
      (local.get $nvstrp_ptr)
      (local.get $gam_ptr)
      (local.get $gam_u_ptr)
      (local.get $rv1_ptr)
      (local.get $rv2_ptr)
      (local.get $rc_ptr)
      (local.get $chord_ptr)
      (local.get $lssurf_ptr)
      (local.get $lncomp_ptr)
      (local.get $lfload_ptr)
      (local.get $gams_ptr)
      (local.get $gams_u_ptr)
      (local.get $rt1_ptr)
      (local.get $rt2_ptr)
      (local.get $rtc_ptr)
      (local.get $vy_u_ptr)
      (local.get $vz_u_ptr)
      (local.get $dwwake_ptr)
      (local.get $clff_u_ptr)
      (local.get $cyff_u_ptr)
      (local.get $cdff_u_ptr)
      (local.get $spanef_u_ptr)
      (local.get $out_ptr)
    )

    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLFF)) (f32.load (local.get $out_ptr)))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CYFF)) (f32.load (i32.add (local.get $out_ptr) (i32.const 4))))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDFF)) (f32.load (i32.add (local.get $out_ptr) (i32.const 8))))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_SPANEF)) (f32.load (i32.add (local.get $out_ptr) (i32.const 12))))
  )
(func $BDFORC_WAT (param $state i32)
    (local $nbody i32) (local $ib i32) (local $ilseg i32)
    (local $l1 i32) (local $l2 i32) (local $nln i32)
    (local $nl_ptr i32) (local $lfrst_ptr i32)
    (local $rl_ptr i32) (local $radl_ptr i32)
    (local $src_ptr i32) (local $src_u_ptr i32)
    (local $dcpb_ptr i32) (local $cdbdy_ptr i32)
    (local $cybdy_ptr i32) (local $clbdy_ptr i32)
    (local $cfbdy_ptr i32) (local $cmbdy_ptr i32)
    (local $cftot_ptr i32) (local $cmtot_ptr i32)
    (local $cdtot_u_ptr i32) (local $cytot_u_ptr i32) (local $cltot_u_ptr i32)
    (local $cftot_u_ptr i32) (local $cmtot_u_ptr i32)
    (local $nlnode i32)
    (local $sref f32) (local $cref f32) (local $bref f32)
    (local $betm f32) (local $sina f32) (local $cosa f32)
    (local $drl0 f32) (local $drl1 f32) (local $drl2 f32)
    (local $drlmag f32) (local $drlmi f32)
    (local $dia f32) (local $dinv f32)
    (local $esl0 f32) (local $esl1 f32) (local $esl2 f32)
    (local $rrot0 f32) (local $rrot1 f32) (local $rrot2 f32)
    (local $vrot0 f32) (local $vrot1 f32) (local $vrot2 f32)
    (local $veff0 f32) (local $veff1 f32) (local $veff2 f32)
    (local $us f32)
    (local $un0 f32) (local $un1 f32) (local $un2 f32)
    (local $fb0 f32) (local $fb1 f32) (local $fb2 f32)
    (local $mb0 f32) (local $mb1 f32) (local $mb2 f32)
    (local $two_over_sref f32)
    (local $tmp f32) (local $tmp2 f32) (local $tmp3 f32)
    (local $vinf0 f32) (local $vinf1 f32) (local $vinf2 f32)
    (local $wrot0 f32) (local $wrot1 f32) (local $wrot2 f32)
    (local $xyz0 f32) (local $xyz1 f32) (local $xyz2 f32)
    (local $iu i32)
    (local $veff_u0 f32) (local $veff_u1 f32) (local $veff_u2 f32)
    (local $dot f32)
    (local $un_u0 f32) (local $un_u1 f32) (local $un_u2 f32)
    (local $src f32) (local $src_u f32)
    (local $fb_u0 f32) (local $fb_u1 f32) (local $fb_u2 f32)
    (local $mb_u0 f32) (local $mb_u1 f32) (local $mb_u2 f32)

    (local.set $nbody (call $load_i32 (local.get $state) (global.get $IDX_NBODY)))
    (local.set $nlnode (call $load_i32 (local.get $state) (global.get $IDX_NLNODE)))
    (local.set $nl_ptr (call $field_ptr (local.get $state) (global.get $IDX_NL)))
    (local.set $lfrst_ptr (call $field_ptr (local.get $state) (global.get $IDX_LFRST)))
    (local.set $rl_ptr (call $field_ptr (local.get $state) (global.get $IDX_RL)))
    (local.set $radl_ptr (call $field_ptr (local.get $state) (global.get $IDX_RADL)))
    (local.set $src_ptr (call $field_ptr (local.get $state) (global.get $IDX_SRC)))
    (local.set $src_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_SRC_U)))
    (local.set $dcpb_ptr (call $field_ptr (local.get $state) (global.get $IDX_DCPB)))
    (local.set $cdbdy_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDBDY)))
    (local.set $cybdy_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYBDY)))
    (local.set $clbdy_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLBDY)))
    (local.set $cfbdy_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFBDY)))
    (local.set $cmbdy_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMBDY)))
    (local.set $cftot_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)))
    (local.set $cmtot_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)))
    (local.set $cdtot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDTOT_U)))
    (local.set $cytot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYTOT_U)))
    (local.set $cltot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLTOT_U)))
    (local.set $cftot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFTOT_U)))
    (local.set $cmtot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMTOT_U)))

    (local.set $sref (call $load_f32 (local.get $state) (global.get $IDX_SREF)))
    (local.set $cref (call $load_f32 (local.get $state) (global.get $IDX_CREF)))
    (local.set $bref (call $load_f32 (local.get $state) (global.get $IDX_BREF)))
    (local.set $two_over_sref (f32.div (f32.const 2) (local.get $sref)))

    (local.set $tmp (call $load_f32 (local.get $state) (global.get $IDX_MACH)))
    (local.set $betm (call $sqrt_f32 (f32.sub (f32.const 1) (f32.mul (local.get $tmp) (local.get $tmp)))))
    (local.set $tmp (call $load_f32 (local.get $state) (global.get $IDX_ALFA)))
    (local.set $sina (call $sin_f32 (local.get $tmp)))
    (local.set $cosa (call $cos_f32 (local.get $tmp)))

    (local.set $vinf0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VINF)) (i32.const 0)))
    (local.set $vinf1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VINF)) (i32.const 1)))
    (local.set $vinf2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_VINF)) (i32.const 2)))
    (local.set $wrot0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 0)))
    (local.set $wrot1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 1)))
    (local.set $wrot2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_WROT)) (i32.const 2)))
    (local.set $xyz0 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 0)))
    (local.set $xyz1 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 1)))
    (local.set $xyz2 (call $load_f32_at (call $field_ptr (local.get $state) (global.get $IDX_XYZREF)) (i32.const 2)))

    (local.set $ib (i32.const 0))
    (block $done_ib
      (loop $loop_ib
        (br_if $done_ib (i32.ge_s (local.get $ib) (local.get $nbody)))

        (call $store_f32_at (local.get $cdbdy_ptr) (local.get $ib) (f32.const 0))
        (call $store_f32_at (local.get $cybdy_ptr) (local.get $ib) (f32.const 0))
        (call $store_f32_at (local.get $clbdy_ptr) (local.get $ib) (f32.const 0))
        (call $store_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3)) (f32.const 0))
        (call $store_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3)) (f32.const 0))

        (local.set $nln (call $load_i32_at (local.get $nl_ptr) (local.get $ib)))
        (local.set $ilseg (i32.const 0))
        (block $done_ilseg
          (loop $loop_ilseg
            (br_if $done_ilseg (i32.ge_s (local.get $ilseg) (i32.sub (local.get $nln) (i32.const 1))))
            (local.set $l1 (i32.add (call $load_i32_at (local.get $lfrst_ptr) (local.get $ib)) (local.get $ilseg)))
            (local.set $l2 (i32.add (local.get $l1) (i32.const 1)))

            (local.set $drl0 (f32.div
              (f32.sub (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 0) (local.get $l2)))
                       (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 0) (local.get $l1))))
              (local.get $betm)))
            (local.set $drl1 (f32.sub (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 1) (local.get $l2)))
                                      (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 1) (local.get $l1)))))
            (local.set $drl2 (f32.sub (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 2) (local.get $l2)))
                                      (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 2) (local.get $l1)))))
            (local.set $drlmag (call $sqrt_f32 (f32.add (f32.add (f32.mul (local.get $drl0) (local.get $drl0))
                                                                  (f32.mul (local.get $drl1) (local.get $drl1)))
                                                         (f32.mul (local.get $drl2) (local.get $drl2)))))
            (local.set $drlmi (select (f32.div (f32.const 1) (local.get $drlmag)) (f32.const 0)
                              (f32.ne (local.get $drlmag) (f32.const 0))))

            (local.set $dia (f32.add (call $load_f32_at (local.get $radl_ptr) (local.get $l1))
                                     (call $load_f32_at (local.get $radl_ptr) (local.get $l2))))
            (local.set $dinv (select (f32.div (f32.const 1) (local.get $dia)) (f32.const 0)
                              (f32.gt (local.get $dia) (f32.const 0))))

            (local.set $esl0 (f32.mul (local.get $drl0) (local.get $drlmi)))
            (local.set $esl1 (f32.mul (local.get $drl1) (local.get $drlmi)))
            (local.set $esl2 (f32.mul (local.get $drl2) (local.get $drlmi)))

            (local.set $rrot0 (f32.sub (f32.mul (f32.const 0.5)
                                               (f32.add (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 0) (local.get $l2)))
                                                        (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 0) (local.get $l1)))))
                                      (local.get $xyz0)))
            (local.set $rrot1 (f32.sub (f32.mul (f32.const 0.5)
                                               (f32.add (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 1) (local.get $l2)))
                                                        (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 1) (local.get $l1)))))
                                      (local.get $xyz1)))
            (local.set $rrot2 (f32.sub (f32.mul (f32.const 0.5)
                                               (f32.add (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 2) (local.get $l2)))
                                                        (call $load_f32_at (local.get $rl_ptr) (call $idx3 (i32.const 2) (local.get $l1)))))
                                      (local.get $xyz2)))

            (local.set $vrot0 (f32.sub (f32.mul (local.get $rrot1) (local.get $wrot2))
                                       (f32.mul (local.get $rrot2) (local.get $wrot1))))
            (local.set $vrot1 (f32.sub (f32.mul (local.get $rrot2) (local.get $wrot0))
                                       (f32.mul (local.get $rrot0) (local.get $wrot2))))
            (local.set $vrot2 (f32.sub (f32.mul (local.get $rrot0) (local.get $wrot1))
                                       (f32.mul (local.get $rrot1) (local.get $wrot0))))

            (local.set $veff0 (f32.div (f32.add (local.get $vinf0) (local.get $vrot0)) (local.get $betm)))
            (local.set $veff1 (f32.add (local.get $vinf1) (local.get $vrot1)))
            (local.set $veff2 (f32.add (local.get $vinf2) (local.get $vrot2)))

            (local.set $us (f32.add (f32.add (f32.mul (local.get $veff0) (local.get $esl0))
                                             (f32.mul (local.get $veff1) (local.get $esl1)))
                                     (f32.mul (local.get $veff2) (local.get $esl2))))

            (local.set $src (call $load_f32_at (local.get $src_ptr) (local.get $l1)))

            (local.set $un0 (f32.sub (local.get $veff0) (f32.mul (local.get $us) (local.get $esl0))))
            (local.set $un1 (f32.sub (local.get $veff1) (f32.mul (local.get $us) (local.get $esl1))))
            (local.set $un2 (f32.sub (local.get $veff2) (f32.mul (local.get $us) (local.get $esl2))))
            (local.set $fb0 (f32.mul (local.get $un0) (local.get $src)))
            (local.set $fb1 (f32.mul (local.get $un1) (local.get $src)))
            (local.set $fb2 (f32.mul (local.get $un2) (local.get $src)))

            (call $store_f32_at (local.get $dcpb_ptr) (call $idx3 (i32.const 0) (local.get $l1))
              (f32.mul (local.get $fb0) (f32.mul (f32.const 2) (f32.mul (local.get $dinv) (local.get $drlmi)))))
            (call $store_f32_at (local.get $dcpb_ptr) (call $idx3 (i32.const 1) (local.get $l1))
              (f32.mul (local.get $fb1) (f32.mul (f32.const 2) (f32.mul (local.get $dinv) (local.get $drlmi)))))
            (call $store_f32_at (local.get $dcpb_ptr) (call $idx3 (i32.const 2) (local.get $l1))
              (f32.mul (local.get $fb2) (f32.mul (f32.const 2) (f32.mul (local.get $dinv) (local.get $drlmi)))))

            (local.set $mb0 (f32.sub (f32.mul (local.get $rrot1) (local.get $fb2))
                                     (f32.mul (local.get $rrot2) (local.get $fb1))))
            (local.set $mb1 (f32.sub (f32.mul (local.get $rrot2) (local.get $fb0))
                                     (f32.mul (local.get $rrot0) (local.get $fb2))))
            (local.set $mb2 (f32.sub (f32.mul (local.get $rrot0) (local.get $fb1))
                                     (f32.mul (local.get $rrot1) (local.get $fb0))))

            (call $store_f32_at (local.get $cdbdy_ptr) (local.get $ib)
              (f32.add (call $load_f32_at (local.get $cdbdy_ptr) (local.get $ib))
                       (f32.mul (f32.add (f32.mul (local.get $fb0) (local.get $cosa))
                                         (f32.mul (local.get $fb2) (local.get $sina)))
                                (local.get $two_over_sref))))
            (call $store_f32_at (local.get $cybdy_ptr) (local.get $ib)
              (f32.add (call $load_f32_at (local.get $cybdy_ptr) (local.get $ib))
                       (f32.mul (local.get $fb1) (local.get $two_over_sref))))
            (call $store_f32_at (local.get $clbdy_ptr) (local.get $ib)
              (f32.add (call $load_f32_at (local.get $clbdy_ptr) (local.get $ib))
                       (f32.mul (f32.add (f32.mul (f32.neg (local.get $fb0)) (local.get $sina))
                                         (f32.mul (local.get $fb2) (local.get $cosa)))
                                (local.get $two_over_sref))))

            (call $store_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3))
              (f32.add (call $load_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3)))
                       (f32.mul (local.get $fb0) (local.get $two_over_sref))))
            (call $store_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3))
              (f32.add (call $load_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3)))
                       (f32.mul (local.get $fb1) (local.get $two_over_sref))))
            (call $store_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3))
              (f32.add (call $load_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3)))
                       (f32.mul (local.get $fb2) (local.get $two_over_sref))))

            (call $store_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3))
              (f32.add (call $load_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3)))
                       (f32.div (f32.mul (local.get $mb0) (local.get $two_over_sref)) (local.get $bref))))
            (call $store_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3))
              (f32.add (call $load_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3)))
                       (f32.div (f32.mul (local.get $mb1) (local.get $two_over_sref)) (local.get $cref))))
            (call $store_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3))
              (f32.add (call $load_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3)))
                       (f32.div (f32.mul (local.get $mb2) (local.get $two_over_sref)) (local.get $bref))))

            (local.set $iu (i32.const 0))
            (block $done_iu
              (loop $loop_iu
                (br_if $done_iu (i32.ge_s (local.get $iu) (i32.const 6)))

                (if (i32.lt_s (local.get $iu) (i32.const 3))
                  (then
                    (local.set $veff_u0 (select (f32.const 1) (f32.const 0) (i32.eq (local.get $iu) (i32.const 0))))
                    (local.set $veff_u1 (select (f32.const 1) (f32.const 0) (i32.eq (local.get $iu) (i32.const 1))))
                    (local.set $veff_u2 (select (f32.const 1) (f32.const 0) (i32.eq (local.get $iu) (i32.const 2))))
                  )
                  (else
                    (if (i32.eq (local.get $iu) (i32.const 3))
                      (then
                        (local.set $veff_u0 (f32.const 0))
                        (local.set $veff_u1 (local.get $rrot2))
                        (local.set $veff_u2 (f32.neg (local.get $rrot1)))
                      )
                      (else
                        (if (i32.eq (local.get $iu) (i32.const 4))
                          (then
                            (local.set $veff_u0 (f32.neg (local.get $rrot2)))
                            (local.set $veff_u1 (f32.const 0))
                            (local.set $veff_u2 (local.get $rrot0))
                          )
                          (else
                            (local.set $veff_u0 (local.get $rrot1))
                            (local.set $veff_u1 (f32.neg (local.get $rrot0)))
                            (local.set $veff_u2 (f32.const 0))
                          )
                        )
                      )
                    )
                  )
                )

                (local.set $dot (f32.add (f32.add (f32.mul (local.get $veff_u0) (local.get $esl0))
                                               (f32.mul (local.get $veff_u1) (local.get $esl1)))
                                         (f32.mul (local.get $veff_u2) (local.get $esl2))))
                (local.set $un_u0 (f32.sub (local.get $veff_u0) (f32.mul (local.get $dot) (local.get $esl0))))
                (local.set $un_u1 (f32.sub (local.get $veff_u1) (f32.mul (local.get $dot) (local.get $esl1))))
                (local.set $un_u2 (f32.sub (local.get $veff_u2) (f32.mul (local.get $dot) (local.get $esl2))))

                (local.set $src_u (call $load_f32_at (local.get $src_u_ptr) (call $idx2 (local.get $l1) (local.get $iu) (local.get $nlnode))))
                (local.set $fb_u0 (f32.add (f32.mul (local.get $un0) (local.get $src_u))
                                           (f32.mul (local.get $un_u0) (local.get $src))))
                (local.set $fb_u1 (f32.add (f32.mul (local.get $un1) (local.get $src_u))
                                           (f32.mul (local.get $un_u1) (local.get $src))))
                (local.set $fb_u2 (f32.add (f32.mul (local.get $un2) (local.get $src_u))
                                           (f32.mul (local.get $un_u2) (local.get $src))))

                (call $store_f32_at (local.get $cdtot_u_ptr) (local.get $iu)
                  (f32.add (call $load_f32_at (local.get $cdtot_u_ptr) (local.get $iu))
                           (f32.mul (f32.add (f32.mul (local.get $fb_u0) (local.get $cosa))
                                             (f32.mul (local.get $fb_u2) (local.get $sina)))
                                    (local.get $two_over_sref))))
                (call $store_f32_at (local.get $cytot_u_ptr) (local.get $iu)
                  (f32.add (call $load_f32_at (local.get $cytot_u_ptr) (local.get $iu))
                           (f32.mul (local.get $fb_u1) (local.get $two_over_sref))))
                (call $store_f32_at (local.get $cltot_u_ptr) (local.get $iu)
                  (f32.add (call $load_f32_at (local.get $cltot_u_ptr) (local.get $iu))
                           (f32.mul (f32.add (f32.mul (f32.neg (local.get $fb_u0)) (local.get $sina))
                                             (f32.mul (local.get $fb_u2) (local.get $cosa)))
                                    (local.get $two_over_sref))))

                (call $store_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 0) (local.get $iu) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 0) (local.get $iu) (i32.const 3)))
                           (f32.mul (local.get $fb_u0) (local.get $two_over_sref))))
                (call $store_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 1) (local.get $iu) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 1) (local.get $iu) (i32.const 3)))
                           (f32.mul (local.get $fb_u1) (local.get $two_over_sref))))
                (call $store_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 2) (local.get $iu) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cftot_u_ptr) (call $idx2 (i32.const 2) (local.get $iu) (i32.const 3)))
                           (f32.mul (local.get $fb_u2) (local.get $two_over_sref))))

                (local.set $mb_u0 (f32.sub (f32.mul (local.get $rrot1) (local.get $fb_u2))
                                           (f32.mul (local.get $rrot2) (local.get $fb_u1))))
                (local.set $mb_u1 (f32.sub (f32.mul (local.get $rrot2) (local.get $fb_u0))
                                           (f32.mul (local.get $rrot0) (local.get $fb_u2))))
                (local.set $mb_u2 (f32.sub (f32.mul (local.get $rrot0) (local.get $fb_u1))
                                           (f32.mul (local.get $rrot1) (local.get $fb_u0))))
                (call $store_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 0) (local.get $iu) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 0) (local.get $iu) (i32.const 3)))
                           (f32.div (f32.mul (local.get $mb_u0) (local.get $two_over_sref)) (local.get $bref))))
                (call $store_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 1) (local.get $iu) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 1) (local.get $iu) (i32.const 3)))
                           (f32.div (f32.mul (local.get $mb_u1) (local.get $two_over_sref)) (local.get $cref))))
                (call $store_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 2) (local.get $iu) (i32.const 3))
                  (f32.add (call $load_f32_at (local.get $cmtot_u_ptr) (call $idx2 (i32.const 2) (local.get $iu) (i32.const 3)))
                           (f32.div (f32.mul (local.get $mb_u2) (local.get $two_over_sref)) (local.get $bref))))

                (local.set $iu (i32.add (local.get $iu) (i32.const 1)))
                (br $loop_iu)
              )
            )

            (local.set $ilseg (i32.add (local.get $ilseg) (i32.const 1)))
            (br $loop_ilseg)
          )
        )

        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT))
          (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CDTOT))
                   (call $load_f32_at (local.get $cdbdy_ptr) (local.get $ib))))
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CYTOT))
          (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CYTOT))
                   (call $load_f32_at (local.get $cybdy_ptr) (local.get $ib))))
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLTOT))
          (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CLTOT))
                   (call $load_f32_at (local.get $clbdy_ptr) (local.get $ib))))

        (call $store_f32_at (local.get $cftot_ptr) (i32.const 0)
          (f32.add (call $load_f32_at (local.get $cftot_ptr) (i32.const 0))
                   (call $load_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3)))))
        (call $store_f32_at (local.get $cftot_ptr) (i32.const 1)
          (f32.add (call $load_f32_at (local.get $cftot_ptr) (i32.const 1))
                   (call $load_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3)))))
        (call $store_f32_at (local.get $cftot_ptr) (i32.const 2)
          (f32.add (call $load_f32_at (local.get $cftot_ptr) (i32.const 2))
                   (call $load_f32_at (local.get $cfbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3)))))
        (call $store_f32_at (local.get $cmtot_ptr) (i32.const 0)
          (f32.add (call $load_f32_at (local.get $cmtot_ptr) (i32.const 0))
                   (call $load_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 0) (local.get $ib) (i32.const 3)))))
        (call $store_f32_at (local.get $cmtot_ptr) (i32.const 1)
          (f32.add (call $load_f32_at (local.get $cmtot_ptr) (i32.const 1))
                   (call $load_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 1) (local.get $ib) (i32.const 3)))))
        (call $store_f32_at (local.get $cmtot_ptr) (i32.const 2)
          (f32.add (call $load_f32_at (local.get $cmtot_ptr) (i32.const 2))
                   (call $load_f32_at (local.get $cmbdy_ptr) (call $idx2 (i32.const 2) (local.get $ib) (i32.const 3)))))

        (local.set $ib (i32.add (local.get $ib) (i32.const 1)))
        (br $loop_ib)
      )
    )
  )

  (func (export "AERO") (param $state i32)
    (local $l i32) (local $n i32) (local $iu i32)
    (local $ncontrol i32) (local $ndesign i32) (local $numax i32)
    (local $iysym i32)
    (local $ptr i32)
    (local $cftot_ptr i32) (local $cmtot_ptr i32)
    (local $cftot_u_ptr i32) (local $cmtot_u_ptr i32)
    (local $cftot_d_ptr i32) (local $cmtot_d_ptr i32)
    (local $cftot_g_ptr i32) (local $cmtot_g_ptr i32)
    (local $cdtot_u_ptr i32) (local $cytot_u_ptr i32) (local $cltot_u_ptr i32)
    (local $cdtot_d_ptr i32) (local $cytot_d_ptr i32) (local $cltot_d_ptr i32)
    (local $cdtot_g_ptr i32) (local $cytot_g_ptr i32) (local $cltot_g_ptr i32)
    (local $chingeptr i32) (local $chinge_u_ptr i32) (local $chinge_d_ptr i32) (local $chinge_g_ptr i32)
    (local $vinf_ptr i32)
    (local $outptr i32) (local $arrptr i32)
    (local $cdref f32) (local $vsq f32) (local $vmag f32) (local $tmp f32)

    (block $aero_body

    (local.set $ncontrol (call $load_i32 (local.get $state) (global.get $IDX_NCONTROL)))
    (local.set $ndesign (call $load_i32 (local.get $state) (global.get $IDX_NDESIGN)))
    (local.set $numax (call $load_i32 (local.get $state) (global.get $IDX_NUMAX)))
    (local.set $iysym (call $load_i32 (local.get $state) (global.get $IDX_IYSYM)))

    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT)) (f32.const 0))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CYTOT)) (f32.const 0))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLTOT)) (f32.const 0))

    (local.set $cftot_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFTOT)))
    (local.set $cmtot_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMTOT)))
    (local.set $l (i32.const 0))
    (block $done_cf
      (loop $loop_cf
        (br_if $done_cf (i32.ge_s (local.get $l) (i32.const 3)))
        (f32.store (i32.add (local.get $cftot_ptr) (i32.mul (local.get $l) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cmtot_ptr) (i32.mul (local.get $l) (i32.const 4))) (f32.const 0))
        (local.set $l (i32.add (local.get $l) (i32.const 1)))
        (br $loop_cf)
      )
    )
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDVTOT)) (f32.const 0))

    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT_A)) (f32.const 0))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLTOT_A)) (f32.const 0))

    (local.set $chingeptr (call $field_ptr (local.get $state) (global.get $IDX_CHINGE)))
    (local.set $l (i32.const 0))
    (block $done_ch
      (loop $loop_ch
        (br_if $done_ch (i32.ge_s (local.get $l) (local.get $ncontrol)))
        (f32.store (i32.add (local.get $chingeptr) (i32.mul (local.get $l) (i32.const 4))) (f32.const 0))
        (local.set $l (i32.add (local.get $l) (i32.const 1)))
        (br $loop_ch)
      )
    )

    (local.set $cdtot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDTOT_U)))
    (local.set $cytot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYTOT_U)))
    (local.set $cltot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLTOT_U)))
    (local.set $cftot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFTOT_U)))
    (local.set $cmtot_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMTOT_U)))
    (local.set $chinge_u_ptr (call $field_ptr (local.get $state) (global.get $IDX_CHINGE_U)))

    (local.set $n (i32.const 0))
    (block $done_u
      (loop $loop_u
        (br_if $done_u (i32.ge_s (local.get $n) (local.get $numax)))
        (f32.store (i32.add (local.get $cdtot_u_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cytot_u_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cltot_u_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (local.set $l (i32.const 0))
        (block $done_u_l
          (loop $loop_u_l
            (br_if $done_u_l (i32.ge_s (local.get $l) (i32.const 3)))
            (local.set $ptr (call $idx2 (local.get $l) (local.get $n) (i32.const 3)))
            (f32.store (i32.add (local.get $cftot_u_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cmtot_u_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (local.set $l (i32.add (local.get $l) (i32.const 1)))
            (br $loop_u_l)
          )
        )
        (local.set $l (i32.const 0))
        (block $done_u_ch
          (loop $loop_u_ch
            (br_if $done_u_ch (i32.ge_s (local.get $l) (local.get $ncontrol)))
            (local.set $ptr (call $idx2 (local.get $l) (local.get $n) (local.get $ncontrol)))
            (f32.store (i32.add (local.get $chinge_u_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (local.set $l (i32.add (local.get $l) (i32.const 1)))
            (br $loop_u_ch)
          )
        )
        (local.set $n (i32.add (local.get $n) (i32.const 1)))
        (br $loop_u)
      )
    )

    (local.set $cdtot_d_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDTOT_D)))
    (local.set $cytot_d_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYTOT_D)))
    (local.set $cltot_d_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLTOT_D)))
    (local.set $cftot_d_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFTOT_D)))
    (local.set $cmtot_d_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMTOT_D)))
    (local.set $chinge_d_ptr (call $field_ptr (local.get $state) (global.get $IDX_CHINGE_D)))

    (local.set $n (i32.const 0))
    (block $done_d
      (loop $loop_d
        (br_if $done_d (i32.ge_s (local.get $n) (local.get $ncontrol)))
        (f32.store (i32.add (local.get $cdtot_d_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cytot_d_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cltot_d_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (local.set $l (i32.const 0))
        (block $done_d_l
          (loop $loop_d_l
            (br_if $done_d_l (i32.ge_s (local.get $l) (i32.const 3)))
            (local.set $ptr (call $idx2 (local.get $l) (local.get $n) (i32.const 3)))
            (f32.store (i32.add (local.get $cftot_d_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cmtot_d_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (local.set $l (i32.add (local.get $l) (i32.const 1)))
            (br $loop_d_l)
          )
        )
        (local.set $l (i32.const 0))
        (block $done_d_ch
          (loop $loop_d_ch
            (br_if $done_d_ch (i32.ge_s (local.get $l) (local.get $ncontrol)))
            (local.set $ptr (call $idx2 (local.get $l) (local.get $n) (local.get $ncontrol)))
            (f32.store (i32.add (local.get $chinge_d_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (local.set $l (i32.add (local.get $l) (i32.const 1)))
            (br $loop_d_ch)
          )
        )
        (local.set $n (i32.add (local.get $n) (i32.const 1)))
        (br $loop_d)
      )
    )

    (local.set $cdtot_g_ptr (call $field_ptr (local.get $state) (global.get $IDX_CDTOT_G)))
    (local.set $cytot_g_ptr (call $field_ptr (local.get $state) (global.get $IDX_CYTOT_G)))
    (local.set $cltot_g_ptr (call $field_ptr (local.get $state) (global.get $IDX_CLTOT_G)))
    (local.set $cftot_g_ptr (call $field_ptr (local.get $state) (global.get $IDX_CFTOT_G)))
    (local.set $cmtot_g_ptr (call $field_ptr (local.get $state) (global.get $IDX_CMTOT_G)))
    (local.set $chinge_g_ptr (call $field_ptr (local.get $state) (global.get $IDX_CHINGE_G)))

    (local.set $n (i32.const 0))
    (block $done_g
      (loop $loop_g
        (br_if $done_g (i32.ge_s (local.get $n) (local.get $ndesign)))
        (f32.store (i32.add (local.get $cdtot_g_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cytot_g_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (f32.store (i32.add (local.get $cltot_g_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
        (local.set $l (i32.const 0))
        (block $done_g_l
          (loop $loop_g_l
            (br_if $done_g_l (i32.ge_s (local.get $l) (i32.const 3)))
            (local.set $ptr (call $idx2 (local.get $l) (local.get $n) (i32.const 3)))
            (f32.store (i32.add (local.get $cftot_g_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cmtot_g_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (local.set $l (i32.add (local.get $l) (i32.const 1)))
            (br $loop_g_l)
          )
        )
        (local.set $l (i32.const 0))
        (block $done_g_ch
          (loop $loop_g_ch
            (br_if $done_g_ch (i32.ge_s (local.get $l) (local.get $ncontrol)))
            (local.set $ptr (call $idx2 (local.get $l) (local.get $n) (local.get $ncontrol)))
            (f32.store (i32.add (local.get $chinge_g_ptr) (i32.mul (local.get $ptr) (i32.const 4))) (f32.const 0))
            (local.set $l (i32.add (local.get $l) (i32.const 1)))
            (br $loop_g_ch)
          )
        )
        (local.set $n (i32.add (local.get $n) (i32.const 1)))
        (br $loop_g)
      )
    )

    (call $SFFORC_WAT (local.get $state))
    (call $BDFORC_WAT (local.get $state))
    (call $TPFORC_WAT (local.get $state))

    (if (i32.eq (local.get $iysym) (i32.const 1))
      (then
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT))
          (f32.mul (f32.const 2) (call $load_f32 (local.get $state) (global.get $IDX_CDTOT))))
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CYTOT)) (f32.const 0))
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLTOT))
          (f32.mul (f32.const 2) (call $load_f32 (local.get $state) (global.get $IDX_CLTOT))))
        (f32.store (i32.add (local.get $cftot_ptr) (i32.const 0))
          (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_ptr) (i32.const 0)))))
        (f32.store (i32.add (local.get $cftot_ptr) (i32.const 4)) (f32.const 0))
        (f32.store (i32.add (local.get $cftot_ptr) (i32.const 8))
          (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_ptr) (i32.const 8)))))
        (f32.store (i32.add (local.get $cmtot_ptr) (i32.const 0)) (f32.const 0))
        (f32.store (i32.add (local.get $cmtot_ptr) (i32.const 4))
          (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cmtot_ptr) (i32.const 4)))))
        (f32.store (i32.add (local.get $cmtot_ptr) (i32.const 8)) (f32.const 0))
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDVTOT))
          (f32.mul (f32.const 2) (call $load_f32 (local.get $state) (global.get $IDX_CDVTOT))))
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT_A))
          (f32.mul (f32.const 2) (call $load_f32 (local.get $state) (global.get $IDX_CDTOT_A))))
        (f32.store (call $field_addr (local.get $state) (global.get $IDX_CLTOT_A))
          (f32.mul (f32.const 2) (call $load_f32 (local.get $state) (global.get $IDX_CLTOT_A))))

        (local.set $n (i32.const 0))
        (block $done_sym_u
          (loop $loop_sym_u
            (br_if $done_sym_u (i32.ge_s (local.get $n) (local.get $numax)))
            (f32.store (i32.add (local.get $cdtot_u_ptr) (i32.mul (local.get $n) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cdtot_u_ptr) (i32.mul (local.get $n) (i32.const 4))))))
            (f32.store (i32.add (local.get $cytot_u_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cltot_u_ptr) (i32.mul (local.get $n) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cltot_u_ptr) (i32.mul (local.get $n) (i32.const 4))))))
            (f32.store (i32.add (local.get $cftot_u_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_u_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cftot_u_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cftot_u_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_u_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cmtot_u_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cmtot_u_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cmtot_u_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cmtot_u_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_sym_u)
          )
        )

        (local.set $n (i32.const 0))
        (block $done_sym_d
          (loop $loop_sym_d
            (br_if $done_sym_d (i32.ge_s (local.get $n) (local.get $ncontrol)))
            (f32.store (i32.add (local.get $cdtot_d_ptr) (i32.mul (local.get $n) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cdtot_d_ptr) (i32.mul (local.get $n) (i32.const 4))))))
            (f32.store (i32.add (local.get $cytot_d_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cltot_d_ptr) (i32.mul (local.get $n) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cltot_d_ptr) (i32.mul (local.get $n) (i32.const 4))))))
            (f32.store (i32.add (local.get $cftot_d_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_d_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cftot_d_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cftot_d_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_d_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cmtot_d_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cmtot_d_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cmtot_d_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cmtot_d_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_sym_d)
          )
        )

        (local.set $n (i32.const 0))
        (block $done_sym_g
          (loop $loop_sym_g
            (br_if $done_sym_g (i32.ge_s (local.get $n) (local.get $ndesign)))
            (f32.store (i32.add (local.get $cdtot_g_ptr) (i32.mul (local.get $n) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cdtot_g_ptr) (i32.mul (local.get $n) (i32.const 4))))))
            (f32.store (i32.add (local.get $cytot_g_ptr) (i32.mul (local.get $n) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cltot_g_ptr) (i32.mul (local.get $n) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cltot_g_ptr) (i32.mul (local.get $n) (i32.const 4))))))
            (f32.store (i32.add (local.get $cftot_g_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_g_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cftot_g_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cftot_g_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cftot_g_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cmtot_g_ptr) (i32.mul (call $idx2 (i32.const 0) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (f32.store (i32.add (local.get $cmtot_g_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4)))
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $cmtot_g_ptr) (i32.mul (call $idx2 (i32.const 1) (local.get $n) (i32.const 3)) (i32.const 4))))))
            (f32.store (i32.add (local.get $cmtot_g_ptr) (i32.mul (call $idx2 (i32.const 2) (local.get $n) (i32.const 3)) (i32.const 4))) (f32.const 0))
            (local.set $n (i32.add (local.get $n) (i32.const 1)))
            (br $loop_sym_g)
          )
        )
      )
    )

    (local.set $vinf_ptr (call $field_ptr (local.get $state) (global.get $IDX_VINF)))
    (local.set $vsq (f32.add
      (f32.add
        (f32.mul (f32.load (local.get $vinf_ptr)) (f32.load (local.get $vinf_ptr)))
        (f32.mul (f32.load (i32.add (local.get $vinf_ptr) (i32.const 4)))
                 (f32.load (i32.add (local.get $vinf_ptr) (i32.const 4)))))
      (f32.mul (f32.load (i32.add (local.get $vinf_ptr) (i32.const 8)))
               (f32.load (i32.add (local.get $vinf_ptr) (i32.const 8))))
    ))
    (local.set $vmag (call $sqrt_f32 (local.get $vsq)))
    (local.set $cdref (call $load_f32 (local.get $state) (global.get $IDX_CDREF)))

    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDVTOT))
      (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CDVTOT)) (f32.mul (local.get $cdref) (local.get $vsq))))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CDTOT))
      (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CDTOT)) (f32.mul (local.get $cdref) (local.get $vsq))))
    (f32.store (call $field_addr (local.get $state) (global.get $IDX_CYTOT))
      (f32.add (call $load_f32 (local.get $state) (global.get $IDX_CYTOT))
        (f32.mul (local.get $cdref)
          (f32.mul (f32.load (i32.add (local.get $vinf_ptr) (i32.const 4))) (local.get $vmag)))))

    (local.set $l (i32.const 0))
    (block $done_add
      (loop $loop_add
        (br_if $done_add (i32.ge_s (local.get $l) (i32.const 3)))
        (local.set $tmp
          (f32.add
            (f32.load (i32.add (local.get $cftot_ptr) (i32.mul (local.get $l) (i32.const 4))))
            (f32.mul
              (local.get $cdref)
              (f32.mul
                (f32.load (i32.add (local.get $vinf_ptr) (i32.mul (local.get $l) (i32.const 4))))
                (local.get $vmag)
              )
            )
          )
        )
        (f32.store (i32.add (local.get $cftot_ptr) (i32.mul (local.get $l) (i32.const 4))) (local.get $tmp))
        (local.set $ptr (call $idx2 (local.get $l) (local.get $l) (i32.const 3)))
        (f32.store (i32.add (local.get $cftot_u_ptr) (i32.mul (local.get $ptr) (i32.const 4)))
          (f32.add
            (f32.load (i32.add (local.get $cftot_u_ptr) (i32.mul (local.get $ptr) (i32.const 4))))
            (f32.mul (local.get $cdref) (local.get $vmag))
          )
        )
        (local.set $l (i32.add (local.get $l) (i32.const 1)))
        (br $loop_add)
      )
    )

    (local.set $iu (i32.const 0))
    (block $done_u_add
      (loop $loop_u_add
        (br_if $done_u_add (i32.ge_s (local.get $iu) (i32.const 3)))
        (f32.store (i32.add (local.get $cdtot_u_ptr) (i32.mul (local.get $iu) (i32.const 4)))
          (f32.add
            (f32.load (i32.add (local.get $cdtot_u_ptr) (i32.mul (local.get $iu) (i32.const 4))))
            (f32.mul (local.get $cdref)
              (f32.mul (f32.const 2) (f32.load (i32.add (local.get $vinf_ptr) (i32.mul (local.get $iu) (i32.const 4))))))))
        (local.set $l (i32.const 0))
        (block $done_u_add_l
          (loop $loop_u_add_l
            (br_if $done_u_add_l (i32.ge_s (local.get $l) (i32.const 3)))
            (local.set $ptr (call $idx2 (local.get $l) (local.get $iu) (i32.const 3)))
            (f32.store (i32.add (local.get $cftot_u_ptr) (i32.mul (local.get $ptr) (i32.const 4)))
              (f32.add
                (f32.load (i32.add (local.get $cftot_u_ptr) (i32.mul (local.get $ptr) (i32.const 4))))
                (f32.mul (local.get $cdref)
                  (f32.div
                    (f32.mul
                      (f32.load (i32.add (local.get $vinf_ptr) (i32.mul (local.get $l) (i32.const 4))))
                      (f32.load (i32.add (local.get $vinf_ptr) (i32.mul (local.get $iu) (i32.const 4))))
                    )
                    (local.get $vmag)
                  )
                )
              ))
            (local.set $l (i32.add (local.get $l) (i32.const 1)))
            (br $loop_u_add_l)
          )
        )
        (local.set $iu (i32.add (local.get $iu) (i32.const 1)))
        (br $loop_u_add)
      )
    )

    (local.set $outptr (call $load_i32 (local.get $state) (global.get $IDX_OUTPUT_PTR)))
    (f32.store (i32.add (local.get $outptr) (i32.const 0)) (call $load_f32 (local.get $state) (global.get $IDX_CDTOT)))
    (f32.store (i32.add (local.get $outptr) (i32.const 4)) (call $load_f32 (local.get $state) (global.get $IDX_CYTOT)))
    (f32.store (i32.add (local.get $outptr) (i32.const 8)) (call $load_f32 (local.get $state) (global.get $IDX_CLTOT)))
    (local.set $l (i32.const 0))
    (block $done_out_cf
      (loop $loop_out_cf
        (br_if $done_out_cf (i32.ge_s (local.get $l) (i32.const 3)))
        (f32.store
          (i32.add (local.get $outptr) (i32.add (i32.const 12) (i32.mul (local.get $l) (i32.const 4))))
          (f32.load (i32.add (local.get $cftot_ptr) (i32.mul (local.get $l) (i32.const 4))))
        )
        (f32.store
          (i32.add (local.get $outptr) (i32.add (i32.const 24) (i32.mul (local.get $l) (i32.const 4))))
          (f32.load (i32.add (local.get $cmtot_ptr) (i32.mul (local.get $l) (i32.const 4))))
        )
        (local.set $l (i32.add (local.get $l) (i32.const 1)))
        (br $loop_out_cf)
      )
    )
    (f32.store (i32.add (local.get $outptr) (i32.const 36)) (call $load_f32 (local.get $state) (global.get $IDX_CDVTOT)))
    (f32.store (i32.add (local.get $outptr) (i32.const 40)) (call $load_f32 (local.get $state) (global.get $IDX_CLFF)))
    (f32.store (i32.add (local.get $outptr) (i32.const 44)) (call $load_f32 (local.get $state) (global.get $IDX_CYFF)))
    (f32.store (i32.add (local.get $outptr) (i32.const 48)) (call $load_f32 (local.get $state) (global.get $IDX_CDFF)))
    (f32.store (i32.add (local.get $outptr) (i32.const 52)) (call $load_f32 (local.get $state) (global.get $IDX_SPANEF)))

    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_DCP)))
    (f32.store (i32.add (local.get $outptr) (i32.const 56)) (f32.load (local.get $arrptr)))
    (f32.store (i32.add (local.get $outptr) (i32.const 60)) (f32.load (i32.add (local.get $arrptr) (i32.const 4))))
    (f32.store (i32.add (local.get $outptr) (i32.const 64)) (f32.load (i32.add (local.get $arrptr) (i32.const 8))))

    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CNC)))
    (f32.store (i32.add (local.get $outptr) (i32.const 68)) (f32.load (local.get $arrptr)))
    (f32.store (i32.add (local.get $outptr) (i32.const 72)) (f32.load (i32.add (local.get $arrptr) (i32.const 4))))
    (f32.store (i32.add (local.get $outptr) (i32.const 76)) (f32.load (i32.add (local.get $arrptr) (i32.const 8))))

    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CFSTRP)))
    (f32.store (i32.add (local.get $outptr) (i32.const 80)) (f32.load (local.get $arrptr)))
    (f32.store (i32.add (local.get $outptr) (i32.const 84)) (f32.load (i32.add (local.get $arrptr) (i32.const 4))))
    (f32.store (i32.add (local.get $outptr) (i32.const 88)) (f32.load (i32.add (local.get $arrptr) (i32.const 8))))

    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CMSTRP)))
    (f32.store (i32.add (local.get $outptr) (i32.const 92)) (f32.load (local.get $arrptr)))
    (f32.store (i32.add (local.get $outptr) (i32.const 96)) (f32.load (i32.add (local.get $arrptr) (i32.const 4))))
    (f32.store (i32.add (local.get $outptr) (i32.const 100)) (f32.load (i32.add (local.get $arrptr) (i32.const 8))))

    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CDSTRP)))
    (f32.store (i32.add (local.get $outptr) (i32.const 104)) (f32.load (local.get $arrptr)))
    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CYSTRP)))
    (f32.store (i32.add (local.get $outptr) (i32.const 108)) (f32.load (local.get $arrptr)))
    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CLSTRP)))
    (f32.store (i32.add (local.get $outptr) (i32.const 112)) (f32.load (local.get $arrptr)))

    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CDVSURF)))
    (f32.store (i32.add (local.get $outptr) (i32.const 116)) (f32.load (local.get $arrptr)))
    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CDSURF)))
    (f32.store (i32.add (local.get $outptr) (i32.const 120)) (f32.load (local.get $arrptr)))
    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CYSURF)))
    (f32.store (i32.add (local.get $outptr) (i32.const 124)) (f32.load (local.get $arrptr)))
    (local.set $arrptr (call $field_ptr (local.get $state) (global.get $IDX_CLSURF)))
    (f32.store (i32.add (local.get $outptr) (i32.const 128)) (f32.load (local.get $arrptr)))
    )
  )

(func (export "SFFORC") (param $state i32)
    (if (i32.eq (global.get $USE_SFFORC_JS) (i32.const 0))
      (then (call $SFFORC_WAT (local.get $state)))
      (else (call $sfforc_js (local.get $state)))
    )
  )
  (func (export "BDFORC") (param $state i32)
    (call $BDFORC_WAT (local.get $state))
  )
)
