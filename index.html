<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q6EYYWH9QE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q6EYYWH9QE');
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VibeLattice</title>
  <link rel="stylesheet" href="./js/dist/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" />
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.172.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/"
    }
  }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
</head>
<body class="vf-theme">
  <header class="app-header">
    <div class="title-bar">
      <div class="title-text">
        <div class="title">VibeLattice</div>
        <div class="title-sub">A vortex lattice method based on <a href="https://web.mit.edu/drela/Public/web/avl/" target="_blank" rel="noopener">AVL</a></div>
      </div>
      <div id="githubStarDesktop" class="github-star github-star-desktop">
        <a
          class="github-button"
          href="https://github.com/kennyjensen/vibelattice"
          data-color-scheme="no-preference: dark; light: dark; dark: dark;"
          data-icon="octicon-star"
          data-size="large"
          data-show-count="true"
          aria-label="Star kennyjensen/vibelattice on GitHub"
        >Star</a>
        <div class="github-star-note">XROTOR port at 100 stars!</div>
      </div>
    </div>
  </header>
  <div class="page-indicator" role="tablist" aria-label="Panels">
    <button id="navEditor" class="nav-btn" data-index="0" type="button">Editor</button>
    <button id="navSettings" class="nav-btn" data-index="1" type="button">Settings</button>
    <button id="navPlots" class="nav-btn active" data-index="2" type="button">Plots</button>
    <button id="navOutputs" class="nav-btn" data-index="3" type="button">Outputs</button>
  </div>
  <div class="app" id="appRoot">
    <section class="col editor-col" id="editorCol">
      <aside class="panel-col" id="editorPanelCol"></aside>
    </section>

    <section class="col settings-col" id="settingsCol">
      <aside class="panel-col">
      <div class="panel">
        <div class="panel-title">Aircraft</div>
        <div class="panel-body">
          <div class="row aircraft-actions">
            <div class="aircraft-buttons">
              <label class="btn">
                Load AVL
                <input id="fileInput" type="file" accept=".avl,.run,.dat,.txt,text/plain,application/octet-stream,*/*" multiple hidden />
              </label>
              <button id="saveBtn" class="btn" type="button">Save AVL</button>
              <select id="loadExampleSelect" class="btn aircraft-example-select" aria-label="Load Example">
                <option value="">Load Example</option>
              </select>
            </div>
          </div>
          <div class="file-meta" id="fileMeta">No file loaded.</div>
          <div id="fileSummary" class="file-summary hidden">
            <input id="fileAircraftName" class="file-aircraft-name" type="text" />
            <div class="file-summary-lines">
              <div># Surfaces = <strong id="fileNSurf">-</strong></div>
              <div># Strips   = <strong id="fileNStrip">-</strong></div>
              <div># Vortices = <strong id="fileNVort">-</strong></div>
            </div>
            <div class="file-ref-grid">
              <div class="file-ref-row"><span class="label-text">IYSym</span>
                <select id="fileIysym">
                  <option value="0">0 - Off (No Y symmetry)</option>
                  <option value="1">1 - On (Mirror in X-Z plane)</option>
                  <option value="-1">-1 - Antisymmetric (Y)</option>
                </select>
              </div>
              <div class="file-ref-row"><span class="label-text">IZSym</span>
                <select id="fileIzsym">
                  <option value="0">0 - Off (No Z symmetry)</option>
                  <option value="1">1 - On (Mirror in X-Y plane)</option>
                  <option value="-1">-1 - Antisymmetric (Z)</option>
                </select>
              </div>
              <div class="file-ref-row"><span class="label-text">ZSym</span><input id="fileZsym" type="number" step="0.01" /></div>
              <div class="file-ref-row"><span class="label-text">Sref</span><input id="fileSref" type="number" step="0.01" /></div>
              <div class="file-ref-row"><span class="label-text">Cref</span><input id="fileCref" type="number" step="0.01" /></div>
              <div class="file-ref-row"><span class="label-text">Bref</span><input id="fileBref" type="number" step="0.01" /></div>
              <div class="file-ref-row"><span class="label-text">Xref</span><input id="fileXref" type="number" step="0.01" /></div>
              <div class="file-ref-row"><span class="label-text">Yref</span><input id="fileYref" type="number" step="0.01" /></div>
              <div class="file-ref-row"><span class="label-text">Zref</span><input id="fileZref" type="number" step="0.01" /></div>
            </div>
          </div>
          <div id="airfoilFilesPanel" class="airfoil-files hidden">
            <div class="airfoil-files-title">AFILE Dependencies</div>
            <div id="airfoilFilesList" class="airfoil-files-list"></div>
          </div>
          <div id="templateParamsPanel" class="template-params-inline hidden">
            <div id="templateParamsList" class="template-params-list"></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Flight Conditions</div>
        <div class="panel-body flight-conditions">
          <label class="flight-row"><span class="label-text">Gravity</span>
            <input id="gee" type="number" step="0.1" value="9.81" />
          </label>
          <label class="flight-row"><span class="label-text">Air density</span>
            <input id="rho" type="number" step="0.1" value="1.225" />
          </label>
          <label class="flight-row"><span class="label-text">Mass</span>
            <input id="mass" type="number" step="0.1" value="120" />
          </label>
          <label class="flight-row"><span class="label-text">Velocity</span>
            <input id="vel" type="number" step="0.1" value="30" />
          </label>
          <label class="flight-row"><span class="label-text">C<sub>L</sub></span>
            <input id="cl" type="number" step="0.1" value="0.6" />
          </label>
          <label class="flight-row"><span class="label-text">Flight mode</span>
            <select id="flightMode">
              <option value="level">Level or banked</option>
              <option value="looping">Looping</option>
            </select>
          </label>
          <input id="clLoop" type="hidden" value="0.6" />
          <input id="velLoop" type="hidden" value="30" />
          <div id="levelInputs" class="grid-2 flight-grid">
            <label class="flight-row"><span class="label-text">Bank angle</span>
              <input id="bank" type="number" step="0.1" value="0" />
            </label>
          </div>
          <div id="loopInputs" class="grid-2 flight-grid hidden">
            <label class="flight-row"><span class="label-text">Turn radius</span>
              <input id="radLoop" type="number" step="0.1" value="0" />
            </label>
            <label class="flight-row"><span class="label-text">Load factor</span>
              <input id="facLoop" type="number" step="0.1" value="0" />
            </label>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Constraints</div>
        <div class="panel-body">
          <div id="constraintTable" class="constraint-table"></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Run Cases</div>
        <div class="panel-body run-cases-panel">
          <div class="row run-cases-actions">
            <label class="btn">
              Load Runs
              <input id="runCasesInput" type="file" accept=".run,text/plain,application/octet-stream" hidden />
            </label>
            <button id="runCasesSaveBtn" class="btn" type="button">Save Runs</button>
          </div>
          <div class="file-meta" id="runCasesMeta">No run cases loaded.</div>
          <div id="runCaseList" class="run-cases-list"></div>
          <div class="row run-case-edit-actions">
            <button id="runCaseAddBtn" class="btn" type="button">Add case</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Mass Properties</div>
        <div class="panel-body mass-props-panel">
          <div class="row mass-props-actions">
            <label class="btn">
              Load Mass
              <input id="massPropsInput" type="file" accept=".mass,text/plain,application/octet-stream" hidden />
            </label>
            <button id="massPropsSaveBtn" class="btn" type="button">Save Mass</button>
          </div>
          <div class="file-meta" id="massPropsMeta">No mass file loaded.</div>
          <div class="mass-props-grid">
            <label class="flight-row"><span class="label-text">Mass</span><input id="massTotal" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Xcg</span><input id="massXcg" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Ycg</span><input id="massYcg" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Zcg</span><input id="massZcg" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Ixx</span><input id="massIxx" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Iyy</span><input id="massIyy" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Izz</span><input id="massIzz" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Ixy</span><input id="massIxy" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Ixz</span><input id="massIxz" type="number" step="0.0001" /></label>
            <label class="flight-row"><span class="label-text">Iyz</span><input id="massIyz" type="number" step="0.0001" /></label>
          </div>
        </div>
      </div>
      </aside>
    </section>

    <section class="col plots-col" id="plotsCol">
      <main class="main-col">
      <div class="stage stage-geo">
        <div id="viewer" class="viewer">
          <div id="viewerAircraftName" class="viewer-aircraft-name"></div>
          <div class="viewer-overlay">
            <button class="viewer-btn icon-btn" id="viewerHome" type="button" title="Fit to model">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 11.5 12 5l8 6.5" />
                <path d="M7 10.5v7h10v-7" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerZoomIn" type="button" title="Zoom in">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="11" cy="11" r="6" />
                <path d="M11 8v6m-3-3h6M15.2 15.2l3.3 3.3" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerZoomOut" type="button" title="Zoom out">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="11" cy="11" r="6" />
                <path d="M8 11h6M15.2 15.2l3.3 3.3" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerPan" type="button" title="Pan mode">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 5v14M5 12h14" />
                <path d="M9 7 12 4l3 3" />
                <path d="M9 17l3 3 3-3" />
                <path d="M7 9 4 12l3 3" />
                <path d="M17 9l3 3-3 3" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerView" type="button" title="Cycle view">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M18 8.5a7.5 7.5 0 0 0-11.5-2.3" />
                <path d="M6.5 6.2 8.6213 2.5257M6.5 6.2 10.1743 8.3213" />
                <path d="M6 15.5a7.5 7.5 0 0 0 11.5 2.3" />
                <path d="M17.5 17.8 13.8257 15.6787M17.5 17.8 15.3787 21.4743" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerGrid" type="button" title="Cycle grid">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="4" y="4" width="16" height="16" rx="1.5" />
                <path d="M4 12h16M12 4v16" />
              </svg>
            </button>
          </div>
          <div class="viewer-overlay-bottom">
            <button class="viewer-btn icon-btn" id="viewerSurface" type="button" title="Surface mode">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7l8-4 8 4-8 4-8-4z" />
                <path d="M4 12l8 4 8-4" />
                <path d="M4 17l8 4 8-4" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerPanelSpacing" type="button" title="Panel spacing">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="4" y="4" width="16" height="16" rx="1.2" />
                <path d="M4 9.5h16M4 14.5h16M9.5 4v16M14.5 4v16" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerVortices" type="button" title="Bound and leg vortices">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 12h8" />
                <path d="M12 12l4-4M12 12l4 4" />
                <path d="M16 8h4M16 16h4" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerPressure" type="button" title="Toggle pressure">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 3c2.8 3.7 5 6.2 5 9.2a5 5 0 1 1-10 0c0-3 2.2-5.5 5-9.2z" />
                <path d="M9.3 13.2a2.9 2.9 0 0 0 2.7 2.8" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerLoad" type="button" title="Toggle loading">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19h16" />
                <path d="M7 17V7" />
                <path d="M12 17V5" />
                <path d="M17 17V9" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerFlow" type="button" title="Flow velocity field">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 8h10" />
                <path d="M4 12h14" />
                <path d="M4 16h8" />
                <path d="M12 6l2 2-2 2M16 10l2 2-2 2M10 14l2 2-2 2" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="stage panel" id="trefftzPanel">
        <div class="panel-title">Trefftz</div>
        <div class="panel-body stage-panel-body">
          <div class="trefftz-overlay" id="trefftzOverlay" aria-hidden="true">
            <div class="trefftz-spinner" aria-hidden="true"></div>
            <div class="trefftz-overlay-text">Thinking…</div>
          </div>
          <canvas id="trefftz" class="trefftz-plot" width="860" height="320" style="background:#0f1115;"></canvas>
        </div>
      </div>

      <div class="stage panel" id="eigenPanel">
        <div class="panel-title">Eigenmodes</div>
        <div class="panel-body stage-panel-body">
          <canvas id="eigenPlot" class="eigen-plot" width="860" height="280" style="background:#0f1115;"></canvas>
        </div>
      </div>
      <div id="githubStarMobile" class="github-star github-star-mobile">
        <div class="github-star-note">XROTOR port at 100 stars!</div>
        <a
          class="github-button"
          href="https://github.com/kennyjensen/vibelattice"
          data-color-scheme="no-preference: dark; light: dark; dark: dark;"
          data-icon="octicon-star"
          data-size="large"
          data-show-count="true"
          aria-label="Star kennyjensen/vibelattice on GitHub"
        >Star</a>
      </div>

      <div id="editorDesktopAnchor"></div>
      <div class="panel" id="editorPanel">
        <div class="panel-title">AVL Editor</div>
        <div class="panel-body">
          <div class="file-editor" id="fileEditor">
            <pre id="fileHighlight" class="file-highlight" aria-hidden="true"></pre>
            <textarea id="fileText" class="code" rows="8" wrap="off" placeholder="AVL file text appears here..." spellcheck="false"></textarea>
          </div>
        </div>
      </div>
      </main>
    </section>

    <section class="col outputs-col" id="outputsCol">
      <aside class="output-col">
      <div class="panel output">
        <div class="panel-title">Total Forces</div>
        <div class="panel-body">
          <div class="total-forces-grid" id="trimOutput">
            <div class="force-cell r1 c1">α = <strong id="outAlpha">-</strong></div>
            <div class="force-cell r1 c2">pb/2v = <strong id="outPb2v">-</strong></div>
            <div class="force-cell r1 c3">&nbsp;CL = <strong id="outCL">-</strong></div>
            <div class="force-cell r1 c4">cl = <strong id="outCltot">-</strong></div>

            <div class="force-cell r2 c1">β = <strong id="outBeta">-</strong></div>
            <div class="force-cell r2 c2">qc/2v = <strong id="outQc2v">-</strong></div>
            <div class="force-cell r2 c3">&nbsp;CY = <strong id="outCYtot">-</strong></div>
            <div class="force-cell r2 c4">cm = <strong id="outCmtot">-</strong></div>

            <div class="force-cell r3 c1">M = <strong id="outMach">-</strong></div>
            <div class="force-cell r3 c2">rb/2v = <strong id="outRb2v">-</strong></div>
            <div class="force-cell r3 c3">&nbsp;CD = <strong id="outCD">-</strong></div>
            <div class="force-cell r3 c4">cn = <strong id="outCntot">-</strong></div>

            <div class="force-cell r4 c3">CDi = <strong id="outCDind">-</strong></div>
            <div class="force-cell r4 c4">&nbsp;e = <strong id="outEff">-</strong></div>
            <div class="force-cell r5 c3">CDp = <strong id="outCDvis">-</strong></div>

            <div id="outControlRows"></div>

            <div class="force-kv-hidden">bank = <strong id="outBank">-</strong></div>
            <div class="force-kv-hidden">velocity = <strong id="outV">-</strong></div>
            <div class="force-kv-hidden">turn radius = <strong id="outRad">-</strong></div>
            <div class="force-kv-hidden">load factor = <strong id="outFac">-</strong></div>
            <div class="force-kv-hidden">theta = <strong id="outThe">-</strong></div>
            <div class="force-kv-hidden">cm xyz = <strong id="outCM">-</strong></div>
            <div class="force-kv-hidden">rates = <strong id="outRates">-</strong></div>
            <div class="force-kv-hidden">def = <strong id="outDef">-</strong></div>
            <div class="force-kv-hidden">cx = <strong id="outCXtot">-</strong></div>
            <div class="force-kv-hidden">cz = <strong id="outCZtot">-</strong></div>
          </div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Stability Derivatives</div>
        <div class="panel-body">
          <div class="stability-grid" id="outStability">-</div>
          <div class="stability-neutral" id="outStabilityNeutral">Xnp = -</div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Body-Axis Derivatives</div>
        <div class="panel-body">
          <div class="body-deriv-grid" id="outBodyDeriv">-</div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Surface Forces</div>
        <div class="panel-body">
          <div class="surface-forces-grid" id="outForcesSurface">-</div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Hinge Moments</div>
        <div class="panel-body">
          <div class="hinge-grid" id="outHinge">-</div>
        </div>
      </div>
      <div aria-hidden="true" style="display:none;">
        <button id="downloadForcesStrip" type="button">Download strip forces</button>
        <button id="downloadForcesElement" type="button">Download element forces</button>
        <pre id="outForcesBody">-</pre>
      </div>
      <div id="debugPanel" class="panel output">
        <div class="panel-title">Debug</div>
        <div class="panel-body">
          <div class="row">
            <button id="trimBtn" class="btn primary" type="button">Trim</button>
            <label class="toggle">
              <input id="useWasmExec" type="checkbox" checked />
              Use WASM for EXEC
            </label>
            <button id="clearDebug" class="btn ghost" type="button">Clear</button>
          </div>
          <pre id="debugLog" class="debug-log"></pre>
        </div>
      </div>
      </aside>
    </section>
  </div>
  <script id="defaultPlane" type="text/plain">
!***************************************
!Sample AVL input dataset
!***************************************
Plane Vanilla
!Mach
 0.0    
!IYsym   IZsym   Zsym
 0       0       0.0
!Sref    Cref    Bref
12.0     1.0     15.0
!Xref    Yref    Zref
0.0      0.0      0.0

#--------------------------------------------------
SURFACE 
WING 
!Nchordwise  Cspace  Nspanwise  Sspace
1            1.0     16         -2.0
YDUPLICATE 
0.0
ANGLE
4.0

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.25   0.     0.      1.000   0.    8          1.0
CONTROL
aileron  1.0  0.0  0. 0. 0.  -1

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.175  7.5    0.5     0.700   0.    0          0
CONTROL
aileron  1.0  0.0  0. 0. 0.  -1

#--------------------------------------------------
SURFACE
STAB
!Nchordwise  Cspace  Nspanwise  Sspace
1            1.0     7          -2.0
YDUPLICATE 
0.0
TRANSLATE 
6.0  0.0  0.5
SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.1    0.     0.0     0.4     0.    7          -1.25
CONTROL
elevator  1.0  0.0  0. 0. 0.  1

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.075  2.00   0.0     0.3     0.    0          0
CONTROL
elevator  1.0  0.0  0. 0. 0.  1

#--------------------------------------------------
SURFACE
FIN
!Nchordwise  Cspace   Nspanewise  Sspace
1            1.0      10          1.0
TRANSLATE
6.0   0.0  0.5
SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.1    0.     0.0     0.4     0.    7          -1.25
CONTROL
rudder  1.0  0.0  0. 0. 0.  1

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.075  0.     1.0     0.3     0.    0          0
CONTROL
rudder  1.0  0.0  0. 0. 0.  1
  </script>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search || '');
      const debugRaw = String(params.get('debug') || '').trim().toLowerCase();
      const showDebug = ['1', 'true', 'yes', 'on'].includes(debugRaw);
      const debugPanel = document.getElementById('debugPanel');
      if (debugPanel) {
        debugPanel.hidden = !showDebug;
        debugPanel.style.display = showDebug ? '' : 'none';
      }
      const el = document.getElementById('debugLog');
      const format = (msg) => `[BOOT ${new Date().toLocaleTimeString()}] ${msg}`;
      const log = (msg) => {
        if (el) {
          el.textContent += `${format(msg)}\n`;
          el.scrollTop = el.scrollHeight;
        }
        console.log(format(msg));
      };
      window.__debugLog = window.__debugLog || log;
      log('Boot script running.');
      window.addEventListener('error', (evt) => {
        log(`Window error: ${evt.message}`);
      });
      window.addEventListener('unhandledrejection', (evt) => {
        log(`Window rejection: ${evt.reason?.message ?? evt.reason}`);
      });
    })();
  </script>
  <script type="module">
    import('./js/dist/app.js')
      .then(() => window.__debugLog?.('App module loaded.'))
      .catch((err) => window.__debugLog?.(`App module failed: ${err?.message ?? err}`));
  </script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</body>
</html>
