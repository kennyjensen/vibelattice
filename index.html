<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VibeLattice</title>
  <link rel="stylesheet" href="./js/dist/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" />
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.172.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/"
    }
  }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
</head>
<body class="vf-theme">
  <header class="app-header">
    <div class="title-bar">
      <div class="title-text">
        <div class="title">VibeLattice</div>
        <div class="title-sub">A vortex lattice method based on <a href="https://web.mit.edu/drela/Public/web/avl/" target="_blank" rel="noopener">AVL</a></div>
      </div>
    </div>
  </header>
  <div class="page-indicator" role="tablist" aria-label="Panels">
    <button id="navSettings" class="nav-btn active" data-index="0" type="button">Settings</button>
    <button id="navPlots" class="nav-btn" data-index="1" type="button">Plots</button>
    <button id="navOutputs" class="nav-btn" data-index="2" type="button">Outputs</button>
  </div>
  <div class="app" id="appRoot">
    <section class="col settings-col" id="settingsCol">
      <aside class="panel-col">
      <div class="panel">
        <div class="panel-title">Aircraft</div>
        <div class="panel-body">
          <div id="fileSummary" class="file-summary hidden">
            <input id="fileAircraftName" class="file-aircraft-name" type="text" />
            <div class="file-summary-lines">
              <div># Surfaces = <strong id="fileNSurf">-</strong></div>
              <div># Strips   = <strong id="fileNStrip">-</strong></div>
              <div># Vortices = <strong id="fileNVort">-</strong></div>
            </div>
            <div class="file-summary-line">
              Sref= <strong id="fileSref">-</strong>
              Cref= <strong id="fileCref">-</strong>
              Bref= <strong id="fileBref">-</strong>
            </div>
            <div class="file-summary-line">
              Xref= <strong id="fileXref">-</strong>
              Yref= <strong id="fileYref">-</strong>
              Zref= <strong id="fileZref">-</strong>
            </div>
          </div>
          <div class="row aircraft-actions">
            <div class="aircraft-buttons">
              <label class="btn">
                Load AVL
                <input id="fileInput" type="file" accept=".avl,.run,.dat,.txt,text/plain,application/octet-stream,*/*" multiple hidden />
              </label>
              <button id="saveBtn" class="btn ghost" type="button">Save AVL</button>
            </div>
            <div class="file-meta" id="fileMeta">No file loaded.</div>
          </div>
          <div id="airfoilFilesPanel" class="airfoil-files hidden">
            <div class="airfoil-files-title">AFILE Dependencies</div>
            <div id="airfoilFilesList" class="airfoil-files-list"></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Flight Conditions</div>
        <div class="panel-body flight-conditions">
          <label class="flight-row"><span class="label-text">Gravity (m/s<sup>2</sup>)</span>
            <input id="gee" type="number" step="0.1" value="9.81" />
          </label>
          <label class="flight-row"><span class="label-text">Air density (kg/m<sup>3</sup>)</span>
            <input id="rho" type="number" step="0.1" value="1.225" />
          </label>
          <label class="flight-row"><span class="label-text">Mass (kg)</span>
            <input id="mass" type="number" step="0.1" value="120" />
          </label>
          <label class="flight-row"><span class="label-text">Velocity (m/s)</span>
            <input id="vel" type="number" step="0.1" value="30" />
          </label>
          <label class="flight-row"><span class="label-text">C<sub>L</sub></span>
            <input id="cl" type="number" step="0.1" value="0.6" />
          </label>
          <label class="flight-row"><span class="label-text">Flight mode</span>
            <select id="flightMode">
              <option value="level">Level or banked</option>
              <option value="looping">Looping</option>
            </select>
          </label>
          <input id="clLoop" type="hidden" value="0.6" />
          <input id="velLoop" type="hidden" value="30" />
          <div id="levelInputs" class="grid-2 flight-grid">
            <label class="flight-row"><span class="label-text">Bank angle (deg)</span>
              <input id="bank" type="number" step="0.1" value="0" />
            </label>
          </div>
          <div id="loopInputs" class="grid-2 flight-grid hidden">
            <label class="flight-row"><span class="label-text">Turn radius (m)</span>
              <input id="radLoop" type="number" step="0.1" value="0" />
            </label>
            <label class="flight-row"><span class="label-text">Load factor</span>
              <input id="facLoop" type="number" step="0.1" value="0" />
            </label>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Constraints</div>
        <div class="panel-body">
          <div id="constraintTable" class="constraint-table"></div>
        </div>
      </div>
      </aside>
    </section>

    <section class="col plots-col" id="plotsCol">
      <main class="main-col">
      <div class="stage stage-geo">
        <div id="viewer" class="viewer">
          <div class="viewer-overlay">
            <button class="viewer-btn icon-btn" id="viewerPan" type="button" title="Pan mode">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2v4m0 12v4m10-10h-4M6 12H2M7 7l-3 3 3 3M17 7l3 3-3 3M7 17l3 3 3-3M17 17l-3 3-3-3" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerZoomIn" type="button" title="Zoom in">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="11" cy="11" r="6" />
                <path d="M11 8v6m-3-3h6m4.5 4.5-3.5-3.5" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerZoomOut" type="button" title="Zoom out">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="11" cy="11" r="6" />
                <path d="M8 11h6m4.5 4.5-3.5-3.5" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerHome" type="button" title="Fit to model">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 11.5 12 5l8 6.5" />
                <path d="M7 10.5v7h10v-7" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerView" type="button" title="Cycle view">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 12a8 8 0 0 1 14-5" />
                <path d="M20 7v-5h-5" />
                <path d="M20 12a8 8 0 0 1-14 5" />
                <path d="M4 17v5h5" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerGrid" type="button" title="Cycle grid">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="4" y="4" width="16" height="16" rx="1.5" />
                <path d="M4 12h16M12 4v16" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerCoord" type="button" title="Coordinate frame">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19h16" />
                <path d="M5 18l4-4 4 3 6-8" />
                <path d="M18 6h2v2" />
              </svg>
            </button>
            <button class="viewer-btn icon-btn" id="viewerLoad" type="button" title="Toggle loading">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19h16" />
                <path d="M7 17V7" />
                <path d="M12 17V5" />
                <path d="M17 17V9" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="stage">
        <div class="trefftz-overlay" id="trefftzOverlay" aria-hidden="true">
          <div class="trefftz-spinner" aria-hidden="true"></div>
          <div class="trefftz-overlay-text">Thinking…</div>
        </div>
        <canvas id="trefftz" class="trefftz-plot" width="860" height="320"></canvas>
      </div>

      <div class="panel">
        <div class="panel-title">AVL Editor</div>
        <div class="panel-body">
          <div class="file-editor" id="fileEditor">
            <pre id="fileHighlight" class="file-highlight" aria-hidden="true"></pre>
            <textarea id="fileText" class="code" rows="8" wrap="off" placeholder="AVL file text appears here..." spellcheck="false"></textarea>
          </div>
        </div>
      </div>
      </main>
    </section>

    <section class="col outputs-col" id="outputsCol">
      <aside class="output-col">
      <div class="panel output">
        <div class="panel-title">Total Forces</div>
        <div class="panel-body">
          <div class="total-forces-grid" id="trimOutput">
            <div class="force-cell r1 c1">α = <strong id="outAlpha">-</strong></div>
            <div class="force-cell r1 c2">pb/2v = <strong id="outPb2v">-</strong></div>
            <div class="force-cell r1 c3">&nbsp;CL = <strong id="outCL">-</strong></div>
            <div class="force-cell r1 c4">cl = <strong id="outCltot">-</strong></div>

            <div class="force-cell r2 c1">β = <strong id="outBeta">-</strong></div>
            <div class="force-cell r2 c2">qc/2v = <strong id="outQc2v">-</strong></div>
            <div class="force-cell r2 c3">&nbsp;CY = <strong id="outCYtot">-</strong></div>
            <div class="force-cell r2 c4">cm = <strong id="outCmtot">-</strong></div>

            <div class="force-cell r3 c1">M = <strong id="outMach">-</strong></div>
            <div class="force-cell r3 c2">rb/2v = <strong id="outRb2v">-</strong></div>
            <div class="force-cell r3 c3">&nbsp;CD = <strong id="outCD">-</strong></div>
            <div class="force-cell r3 c4">cn = <strong id="outCntot">-</strong></div>

            <div class="force-cell r4 c3">CDi = <strong id="outCDind">-</strong></div>
            <div class="force-cell r4 c4">&nbsp;e = <strong id="outEff">-</strong></div>
            <div class="force-cell r5 c3">CDp = <strong id="outCDvis">-</strong></div>

            <div id="outControlRows"></div>

            <div class="force-kv-hidden">bank = <strong id="outBank">-</strong></div>
            <div class="force-kv-hidden">velocity = <strong id="outV">-</strong></div>
            <div class="force-kv-hidden">turn radius = <strong id="outRad">-</strong></div>
            <div class="force-kv-hidden">load factor = <strong id="outFac">-</strong></div>
            <div class="force-kv-hidden">theta = <strong id="outThe">-</strong></div>
            <div class="force-kv-hidden">cm xyz = <strong id="outCM">-</strong></div>
            <div class="force-kv-hidden">rates = <strong id="outRates">-</strong></div>
            <div class="force-kv-hidden">def = <strong id="outDef">-</strong></div>
            <div class="force-kv-hidden">cx = <strong id="outCXtot">-</strong></div>
            <div class="force-kv-hidden">cz = <strong id="outCZtot">-</strong></div>
          </div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Stability Derivatives</div>
        <div class="panel-body">
          <div class="stability-grid" id="outStability">-</div>
          <div class="stability-neutral" id="outStabilityNeutral">Xnp = -</div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Body-Axis Derivatives</div>
        <div class="panel-body">
          <div class="body-deriv-grid" id="outBodyDeriv">-</div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Surface Forces</div>
        <div class="panel-body">
          <div class="surface-forces-grid" id="outForcesSurface">-</div>
        </div>
      </div>
      <div class="panel output">
        <div class="panel-title">Hinge Moments</div>
        <div class="panel-body">
          <div class="hinge-grid" id="outHinge">-</div>
        </div>
      </div>
      <div aria-hidden="true" style="display:none;">
        <button id="downloadForcesStrip" type="button">Download strip forces</button>
        <button id="downloadForcesElement" type="button">Download element forces</button>
        <pre id="outForcesBody">-</pre>
      </div>
      <div class="panel output">
        <div class="panel-title">Debug</div>
        <div class="panel-body">
          <div class="row">
            <button id="trimBtn" class="btn primary" type="button">Trim</button>
            <label class="toggle">
              <input id="useWasmExec" type="checkbox" checked />
              Use WASM for EXEC
            </label>
            <button id="clearDebug" class="btn ghost" type="button">Clear</button>
          </div>
          <pre id="debugLog" class="debug-log"></pre>
        </div>
      </div>
      </aside>
    </section>
  </div>
  <script id="defaultPlane" type="text/plain">
!***************************************
!Sample AVL input dataset
!***************************************
Plane Vanilla
!Mach
 0.0    
!IYsym   IZsym   Zsym
 0       0       0.0
!Sref    Cref    Bref
12.0     1.0     15.0
!Xref    Yref    Zref
0.0      0.0      0.0

#--------------------------------------------------
SURFACE 
WING 
!Nchordwise  Cspace  Nspanwise  Sspace
1            1.0     16         -2.0
YDUPLICATE 
0.0
ANGLE
4.0

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.25   0.     0.      1.000   0.    8          1.0
CONTROL
aileron  1.0  0.0  0. 0. 0.  -1

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.175  7.5    0.5     0.700   0.    0          0
CONTROL
aileron  1.0  0.0  0. 0. 0.  -1

#--------------------------------------------------
SURFACE
STAB
!Nchordwise  Cspace  Nspanwise  Sspace
1            1.0     7          -2.0
YDUPLICATE 
0.0
TRANSLATE 
6.0  0.0  0.5
SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.1    0.     0.0     0.4     0.    7          -1.25
CONTROL
elevator  1.0  0.0  0. 0. 0.  1

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.075  2.00   0.0     0.3     0.    0          0
CONTROL
elevator  1.0  0.0  0. 0. 0.  1

#--------------------------------------------------
SURFACE
FIN
!Nchordwise  Cspace   Nspanewise  Sspace
1            1.0      10          1.0
TRANSLATE
6.0   0.0  0.5
SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.1    0.     0.0     0.4     0.    7          -1.25
CONTROL
rudder  1.0  0.0  0. 0. 0.  1

SECTION
!Xle    Yle    Zle     Chord   Ainc  Nspanwise  Sspace
-0.075  0.     1.0     0.3     0.    0          0
CONTROL
rudder  1.0  0.0  0. 0. 0.  1
  </script>

  <script>
    (function () {
      const el = document.getElementById('debugLog');
      const format = (msg) => `[BOOT ${new Date().toLocaleTimeString()}] ${msg}`;
      const log = (msg) => {
        if (el) {
          el.textContent += `${format(msg)}\n`;
          el.scrollTop = el.scrollHeight;
        }
        console.log(format(msg));
      };
      window.__debugLog = window.__debugLog || log;
      log('Boot script running.');
      window.addEventListener('error', (evt) => {
        log(`Window error: ${evt.message}`);
      });
      window.addEventListener('unhandledrejection', (evt) => {
        log(`Window rejection: ${evt.reason?.message ?? evt.reason}`);
      });
    })();
  </script>
  <script type="module">
    import('./js/dist/app.js')
      .then(() => window.__debugLog?.('App module loaded.'))
      .catch((err) => window.__debugLog?.(`App module failed: ${err?.message ?? err}`));
  </script>
</body>
</html>
